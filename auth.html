<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Connexion</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#0a1020; --muted:#667085; --stroke:#e6e9f3; --accent:#111827; --accent-ink:#fff; --pill:#f6f9ff; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:#fff}
    .page{min-height:100%;display:grid;grid-template-columns:520px 1fr}
    .left{display:flex;align-items:center;justify-content:center;padding:24px}
    .left-inner{width:100%;max-width:420px}
    .brand{display:flex;align-items:center;gap:8px;margin-bottom:28px}
    .logo{width:24px;height:24px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    h1{font-size:44px;line-height:1.05;margin:0 0 6px;font-weight:900;letter-spacing:-.02em}
    .subtitle{font-size:18px;color:var(--muted);margin:0 0 18px}
    .btn{width:100%;border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer;text-align:center}
    .btn.black{background:var(--accent);color:var(--accent-ink);border-color:#0000}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px}
    .field{width:100%}
    label{display:block;font-size:13px;color:#475569;margin:10px 0 6px}
    input{width:100%;border:1px solid var(--stroke);border-radius:10px;padding:12px 12px;font:500 14px/1.2 Inter}
    .or{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;color:#98a2b3;margin:10px 0}
    .or::before,.or::after{content:"";height:1px;background:var(--stroke)}
    .hint{font-size:13px;color:var(--muted)}
    .link{color:#0a66ff;text-decoration:none}
    .space{height:10px}
    .err{background:#fff2f2;border:1px solid #ffd7d7;color:#b42318;border-radius:10px;padding:10px 12px;font-size:13px;margin-bottom:10px;display:none}
    .ok{background:#f1fff3;border:1px solid #c9f1cf;color:#067647;border-radius:10px;padding:10px 12px;font-size:13px;margin-bottom:10px;display:none}
    .right{position:relative;overflow:hidden;background:radial-gradient(1200px 600px at 60% 30%, #eaf2ff, #f7f9ff 60%, #ffffff 100%)}
    .blob{position:absolute;inset:-20% -10% auto -10%;height:120%;background:
      radial-gradient(40% 40% at 70% 30%, rgba(59,130,246,.35), transparent 60%),
      radial-gradient(40% 40% at 30% 70%, rgba(139,92,246,.25), transparent 60%);filter:blur(40px)}
    .search{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(700px,70%);height:74px;border-radius:999px;
      background:linear-gradient(180deg,#ffffffcc,#ffffff80);border:1px solid #e7edf9;box-shadow:0 12px 36px rgba(11,25,70,.12);
      display:flex;align-items:center;padding:0 8px 0 24px;backdrop-filter:blur(8px)}
    .search span{color:#616c80;font-weight:600;font-size:26px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .go{margin-left:auto;width:54px;height:54px;border-radius:16px;background:#fff;border:1px solid #e6ebf7;display:grid;place-items:center;box-shadow:0 10px 24px rgba(0,0,0,.06)}
    .go svg{width:22px;height:22px;stroke:#6b7280}
    @media (max-width:980px){.page{grid-template-columns:1fr}.right{display:none}.left{padding:18px}h1{font-size:36px}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="page">
    <div class="left">
      <div class="left-inner">
        <div class="brand"><div class="logo" aria-hidden="true"></div><strong>PropoFlash</strong></div>
        <h1>Welcome to<br/>PropoFlash</h1>
        <p class="subtitle">Connectez-vous pour créer et envoyer vos propositions.</p>

        <div id="msgErr" class="err"></div>
        <div id="msgOk"  class="ok"></div>

        <button id="googleBtn" class="btn">
          <span style="display:inline-flex;align-items:center;gap:10px;justify-content:center">
            <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18">
            Log in with Google
          </span>
        </button>

        <div class="or">OR</div>

        <div class="field">
          <label>Email</label>
          <input id="email" type="email" placeholder="Enter your email address" autocomplete="email">
        </div>
        <div class="field">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label>Password</label>
            <a href="#" id="forgot" class="link" style="font-size:12px">Forgot password?</a>
          </div>
          <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password">
        </div>

        <div class="space"></div>
        <button id="submitBtn" class="btn black">Log In</button>

        <div class="space"></div>
        <p class="hint" id="footHint">
          Don't have an account? <a href="#" id="toggle" class="link">Sign up</a>
          &nbsp;&nbsp;·&nbsp; <a href="index.html" class="link">← Back to home</a>
        </p>
      </div>
    </div>

    <div class="right" aria-hidden="true">
      <div class="blob"></div>
      <div class="search">
        <span>Transformez vos idées en propositions</span>
        <div class="go">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase =====
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // DOM
    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('password');
    const submit  = document.getElementById('submitBtn');
    const google  = document.getElementById('googleBtn');
    const forgot  = document.getElementById('forgot');
    const toggle  = document.getElementById('toggle');
    const msgErr  = document.getElementById('msgErr');
    const msgOk   = document.getElementById('msgOk');

    // Flow state
    let mode = 'login'; // or 'signup'
    const params = new URLSearchParams(location.search);
    const NEXT = params.get('next') || 'index.html';

    function showErr(t){ msgErr.textContent=t; msgErr.style.display='block'; msgOk.style.display='none'; }
    function showOk(t){ msgOk.textContent=t; msgOk.style.display='block'; msgErr.style.display='none'; }
    function clearMsgs(){ msgErr.style.display='none'; msgOk.style.display='none'; }

    // 1) Si déjà loggé → redirection
    (async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      if(session){ location.replace(NEXT); }
    })();

    // 2) Fin de l’OAuth (échange code → session), puis redirection
    (async ()=>{
      const url = new URL(window.location.href);
      if(url.searchParams.get('code')){
        try{
          const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
          if(error) throw error;
          location.replace(NEXT);
          return;
        }catch(e){
          showErr('Impossible de finaliser la connexion Google : '+(e.message||e));
        }
      }
    })();

    // 3) Aussi réagir aux changements (au cas où)
    sb.auth.onAuthStateChange((_event, session)=>{
      if(session){ location.replace(NEXT); }
    });

    // Google OAuth
    google.onclick = async ()=>{
      clearMsgs();
      try{
        const redirectTo = `${window.location.origin}/auth.html?next=${encodeURIComponent(NEXT)}`;
        const { error } = await sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo } });
        if(error) showErr(error.message);
      }catch(e){ showErr(String(e.message||e)); }
    };

    // Toggle login/signup
    toggle.onclick = (e)=>{
      e.preventDefault(); clearMsgs();
      if(mode==='login'){ mode='signup'; submit.textContent='Create account'; toggle.textContent='Log in'; forgot.style.visibility='hidden'; }
      else { mode='login'; submit.textContent='Log In'; toggle.textContent='Sign up'; forgot.style.visibility='visible'; }
    };

    // Email + password
    submit.onclick = async ()=>{
      clearMsgs();
      const email = (emailEl.value||'').trim();
      const password = passEl.value||'';
      if(!email || !password){ showErr('Email et mot de passe requis.'); return; }
      submit.disabled=true;
      try{
        if(mode==='signup'){
          const { error } = await sb.auth.signUp({ email, password });
          if(error) showErr(error.message);
          else showOk('Compte créé. Vérifiez votre email si la confirmation est requise.');
        }else{
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if(error) showErr(error.message);
          else { location.replace(NEXT); }
        }
      }catch(e){ showErr(String(e.message||e)); }
      finally{ submit.disabled=false; }
    };

    // Mot de passe oublié
    forgot.onclick = async (e)=>{
      e.preventDefault(); clearMsgs();
      const email = (emailEl.value||'').trim() || prompt('Votre email pour réinitialiser le mot de passe :');
      if(!email) return;
      try{
        const redirectTo = `${window.location.origin}/auth.html?next=${encodeURIComponent(NEXT)}#reset`;
        const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
        if(error) showErr(error.message);
        else showOk('Lien de réinitialisation envoyé. Consultez votre boîte mail.');
      }catch(err){ showErr(String(err.message||err)); }
    };

    if(location.hash === '#reset'){ showOk('Définissez un nouveau mot de passe puis reconnectez-vous.'); }
  </script>
</body>
</html>
