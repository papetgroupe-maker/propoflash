<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Connexion</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--ink:#0a1020;--muted:#667085;--stroke:#e6e9f3;--accent:#111827;--accent-ink:#fff}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
    .page{min-height:100%;display:grid;grid-template-columns:520px 1fr}
    .left{display:flex;align-items:center;justify-content:center;padding:24px}
    .left-inner{width:100%;max-width:420px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:24px}
    .logo{width:22px;height:22px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .brand a{color:inherit;text-decoration:none;font-weight:800}
    h1{font-size:36px;margin:0 0 6px;font-weight:800}
    .sub{color:var(--muted);margin:0 0 16px}
    .btn{width:100%;border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer}
    .btn.black{background:var(--accent);color:var(--accent-ink);border-color:#0000}
    .msg{display:none;margin:10px 0;padding:10px 12px;border-radius:10px;font-size:13px}
    .ok{background:#f1fff3;border:1px solid #c9f1cf;color:#067647}
    .err{background:#fff2f2;border:1px solid #ffd7d7;color:#b42318}
    .right{position:relative;overflow:hidden;background:radial-gradient(1200px 600px at 60% 30%, #eaf2ff, #f7f9ff 60%, #ffffff 100%)}
    .search{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,74%);
      height:76px;border-radius:999px;background:linear-gradient(180deg,#ffffffcc,#ffffff85);
      border:1px solid #e7edf9;box-shadow:0 12px 36px rgba(11,25,70,.12);display:flex;align-items:center;padding:0 8px 0 24px}
    .search span{color:#616c80;font-weight:600;font-size:26px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .go{margin-left:auto;width:54px;height:54px;border-radius:16px;background:#fff;border:1px solid #e6ebf7;display:grid;place-items:center}
    @media (max-width:980px){.page{grid-template-columns:1fr}.right{display:none}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="page">
    <div class="left">
      <div class="left-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <a href="index.html">PropoFlash</a>
        </div>
        <h1>Bienvenue</h1>
        <p class="sub">Connectez-vous pour créer et envoyer vos propositions.</p>

        <div id="msgOk"  class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>

        <button id="googleBtn" class="btn" style="display:inline-flex;gap:10px;align-items:center;justify-content:center">
          <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18">
          Se connecter avec Google
        </button>

        <div style="height:12px"></div>
        <button id="logoutBtn" class="btn black" style="display:none">Se déconnecter</button>
      </div>
    </div>

    <div class="right" aria-hidden="true">
      <div class="search">
        <span>Transformez vos idées en propositions</span>
        <div class="go"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#6b7280" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg></div>
      </div>
    </div>
  </div>

  <script>
    // === Supabase ===
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const q = (k)=>new URLSearchParams(location.search).get(k);
    const returnTo = q('return') || 'studio'; // studio par défaut

    const msgOk = document.getElementById('msgOk');
    const msgErr = document.getElementById('msgErr');
    const showOk  = (t)=>{ msgOk.textContent=t; msgOk.style.display='block'; msgErr.style.display='none'; };
    const showErr = (t)=>{ msgErr.textContent=t; msgErr.style.display='block'; msgOk.style.display='none'; };

    // 1) Si on revient d'OAuth: échange le code PKCE, crée la session, redirige
    (async ()=>{
      if (location.search.includes('code=')) {
        try{
          console.log('[auth] code present → exchangeCodeForSession');
          const { data, error } = await sb.auth.exchangeCodeForSession(window.location.href);
          if (error) { console.error('[auth] exchange error', error); showErr('Connexion impossible : '+error.message); return; }
          console.log('[auth] session created', data?.session?.user?.email);
          // Nettoie l’URL
          history.replaceState({}, document.title, location.pathname);
          // Redirige
          location.href = (returnTo==='studio' ? 'studio.html' : 'index.html');
        }catch(e){ console.error(e); showErr(String(e.message||e)); }
        return;
      }
      // Si déjà connecté, envoie au studio directement
      const { data:{ session } } = await sb.auth.getSession();
      if (session) {
        console.log('[auth] already logged in as', session.user.email);
        showOk('Déjà connecté·e. Redirection…');
        setTimeout(()=> location.href = 'studio.html', 400);
        document.getElementById('logoutBtn').style.display = 'block';
      }
    })();

    // 2) Démarre le flux OAuth → retour sur auth.html (même page)
    document.getElementById('googleBtn').onclick = async ()=>{
      try{
        const redirectTo = new URL(location.href);
        redirectTo.searchParams.set('return', 'studio');
        console.log('[auth] start OAuth →', redirectTo.toString());
        const { error } = await sb.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: redirectTo.toString(), queryParams: { prompt: 'select_account' } }
        });
        if (error) { console.error(error); showErr(error.message); }
      }catch(e){ console.error(e); showErr(String(e.message||e)); }
    };

    // 3) Déconnexion (utile si une mauvaise session traine)
    document.getElementById('logoutBtn').onclick = async ()=>{
      await sb.auth.signOut();
      showOk('Déconnecté. Vous pouvez vous reconnecter.');
      document.getElementById('logoutBtn').style.display = 'none';
    };

    // 4) Debug: affiche les changements d’état
    sb.auth.onAuthStateChange((event, session)=>{
      console.log('[auth] onAuthStateChange', event, session?.user?.email);
    });
  </script>
</body>
</html>
