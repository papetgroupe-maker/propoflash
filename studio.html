<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash ‚Äî Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1629; --ink:#e6ecff; --muted:#9aa6bf; --stroke:#22314d;
      --accent:#3b82f6; --accent2:#8b5cf6; --accent-ink:#fff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .top{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, #0f1629ee, #0f1629f5);backdrop-filter:saturate(130%) blur(6px);
      border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .brand{display:flex;align-items:center;gap:10px;cursor:pointer}
    .spark{width:24px;height:24px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .rightBtns{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--stroke);background:#101a33;border-radius:10px;padding:8px 12px;font-weight:700;color:#cfe1ff;cursor:pointer}
    .btn:hover{background:#132044}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .layout{height:calc(100% - 58px);display:grid;grid-template-columns:420px 1fr}
    .left{border-right:1px solid var(--stroke);background:var(--panel);display:flex;flex-direction:column}
    .head{padding:10px 12px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:8px;justify-content:space-between}
    .chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:88%;padding:10px 12px;border:1px solid #1a2747;border-radius:12px;background:#0d1730;color:#cfe1ff}
    .me{align-self:flex-end;background:#122043}
    .composer{padding:10px;border-top:1px solid var(--stroke);display:flex;gap:8px;align-items:flex-end}
    .logoBtn{min-width:44px;height:44px;border-radius:10px;border:1px solid var(--stroke);background:#0e1832;display:grid;place-items:center;cursor:pointer}
    .text{flex:1;min-height:44px;max-height:140px;border:1px solid var(--stroke);border-radius:12px;background:#0e1832;color:#cfe1ff;padding:10px 12px;resize:vertical}
    .send{min-width:100px;height:44px;border-radius:10px;border:1px solid var(--stroke);background:var(--accent);color:var(--accent-ink);font-weight:800;cursor:pointer}
    .send.loading{opacity:.7;pointer-events:none}
    .right{position:relative;overflow:auto}
    .toolbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, #0f1629ee, #0f1629f5);padding:8px;border-bottom:1px solid var(--stroke);display:flex;gap:8px;align-items:center}
    .chip{border:1px solid var(--stroke);background:#101a33;color:#cfe1ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .wrap{padding:16px;display:grid;place-items:start}
    .sheet{width:900px;min-height:1200px;background:#0d152b;border:1px solid var(--stroke);border-radius:12px;box-shadow:0 14px 48px rgba(0,0,0,.35);padding:26px;color:#dfe8ff}
    .h1{font-size:28px;font-weight:800;margin:0 0 4px}
    .meta{color:#9aa6bf;margin-bottom:16px}
    h2{margin:20px 0 8px}
    .tag{display:inline-block;border:1px solid #27406f;background:#121e3d;color:#cfe1ff;padding:2px 8px;border-radius:999px;font-size:12px}
    .card{border:1px solid #1a2747;background:#0f1a36;border-radius:12px;padding:12px;margin:8px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    ul{margin:6px 0 10px 18px}
    table{border-collapse:collapse;width:100%;font-size:14px;color:#e6ecff}
    th,td{border:1px solid #1a2747;padding:8px}
    th{background:#0f1a36}
    .muted{color:#9aa6bf}
    .hidden{display:none}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="top">
    <a class="brand" href="index.html" title="Retour √† l‚Äôaccueil">
      <div class="spark" aria-hidden="true"></div><strong>PropoFlash Studio</strong>
    </a>
    <div class="rightBtns">
      <button id="historyBtn" class="btn">Historique</button>
      <button id="authBtn" class="btn">Se connecter</button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: Chat -->
    <aside class="left">
      <div class="head">
        <div style="font-weight:800">Assistant</div>
        <div class="muted" id="chatTitle">Nouvelle discussion</div>
      </div>
      <div id="thread" class="chat" aria-live="polite"></div>
      <div class="composer">
        <button id="logoBtn" class="logoBtn" title="+ Logo">üñºÔ∏è</button>
        <input id="logoInput" type="file" accept="image/*" hidden>
        <textarea id="prompt" class="text" placeholder="√âcrivez votre message‚Ä¶ (Entr√©e = envoyer ‚Ä¢ Maj+Entr√©e = nouvelle ligne ‚Ä¢ Alt+Espace = envoyer)"></textarea>
        <button id="send" class="send">Envoyer</button>
      </div>
    </aside>

    <!-- RIGHT: Live preview -->
    <main class="right">
      <div class="toolbar">
        <span class="chip" id="status">Aper√ßu</span>
        <button id="openFull" class="btn">Plein √©cran</button>
        <button id="emailModeBtn" class="btn">Mode Email</button>
      </div>
      <div class="wrap">
        <div id="preview" class="sheet"></div>
      </div>
    </main>
  </div>

  <!-- Drawer Historique -->
  <div id="drawer" class="hidden" style="position:fixed;inset:auto 0 0 auto;width:360px;background:#0f1629;border-left:1px solid var(--stroke);box-shadow:-10px 0 40px rgba(0,0,0,.45)">
    <div style="padding:10px;border-bottom:1px solid var(--stroke);display:flex;justify-content:space-between;align-items:center">
      <strong>Mes discussions</strong>
      <button id="closeDrawer" class="btn">Fermer</button>
    </div>
    <div id="chatList" style="display:flex;flex-direction:column;gap:8px;padding:10px;max-height:60vh;overflow:auto"></div>
  </div>

  <script>
    /* ============== Supabase ============== */
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ============== Mode invit√© / connect√© + limite d‚Äôessai ============== */
    const GUEST_LIMIT = 1; // 1 proposition en mode invit√©
    function monthKeyGuest(){
      const d=new Date(); return `pf_guest_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
    }
    function getGuestCount(){ return parseInt(localStorage.getItem(monthKeyGuest())||'0',10); }
    function incGuestCount(){ localStorage.setItem(monthKeyGuest(), String(getGuestCount()+1)); }

    let IS_GUEST = true;
    let CURRENT_SESSION = null;

    (async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      CURRENT_SESSION = session;
      IS_GUEST = !session;
      setupAuthUI();
      enforceGuestLimitUI();
    })();

    function setupAuthUI(){
      const authBtn = document.getElementById('authBtn');
      if(IS_GUEST){
        authBtn.textContent = 'Se connecter';
        authBtn.onclick = ()=>{ location.href = 'auth.html?from=studio'; };
      }else{
        authBtn.textContent = 'Se d√©connecter';
        authBtn.onclick = async ()=>{ await sb.auth.signOut(); localStorage.removeItem('pf_chat_id'); location.reload(); };
      }
    }

    function enforceGuestLimitUI(){
      const count = getGuestCount();
      const sendBtn = document.getElementById('send');
      const promptEl = document.getElementById('prompt');
      const statusEl = document.getElementById('status');

      if(IS_GUEST && count >= GUEST_LIMIT){
        sendBtn.disabled = true;
        promptEl.disabled = true;
        promptEl.placeholder = 'Connectez-vous pour continuer ‚Äî essai gratuit utilis√©.';
        statusEl.textContent = 'Essai gratuit utilis√©';
      }else{
        sendBtn.disabled = false;
        promptEl.disabled = false;
        statusEl.textContent = 'Aper√ßu';
      }
    }

    /* ============== UI helpers ============== */
    const $ = (q,ctx=document)=>ctx.querySelector(q);
    const thread = $('#thread');
    const statusEl = $('#status');
    const promptEl = $('#prompt');
    const sendBtn  = $('#send');
    const logoBtn  = $('#logoBtn');
    const logoInput= $('#logoInput');
    const chatTitle= $('#chatTitle');
    const drawer   = $('#drawer');
    const chatList = $('#chatList');

    function addMsg(text, who='ai'){
      const b = document.createElement('div');
      b.className = 'msg'+(who==='me'?' me':'');
      b.textContent = String(text||'');
      thread.appendChild(b);
      thread.scrollTop = thread.scrollHeight;
    }
    function setStatus(t){ statusEl.textContent = t; }

    /* ============== State ============== */
    let currentChatId = localStorage.getItem('pf_chat_id') || null;
    let spec = null;
    function loadSpec(){
      try{ spec = JSON.parse(localStorage.getItem('pf_proposal')||'{"meta":{"lang":"fr"},"sections":[]}'); }
      catch{ spec = { meta:{ lang:'fr' } }; }
      renderPreview();
    }
    function saveSpec(){ localStorage.setItem('pf_proposal', JSON.stringify(spec||{})); }

    /* ============== Historique ============== */
    $('#historyBtn').onclick = async ()=>{
      if(IS_GUEST){ alert("Connectez-vous pour acc√©der √† l‚Äôhistorique."); return; }
      drawer.classList.remove('hidden'); await listChats();
    };
    $('#closeDrawer').onclick = ()=> drawer.classList.add('hidden');

    async function listChats(){
      chatList.innerHTML = '<div class="muted">Chargement‚Ä¶</div>';
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ chatList.innerHTML = '<div class="muted">Connectez-vous.</div>'; return; }
      const { data, error } = await sb.from('chats').select('id,title,created_at').order('created_at',{ascending:false}).limit(50);
      if(error){ chatList.innerHTML = '<div class="muted">Erreur.</div>'; return; }
      chatList.innerHTML = '';
      data.forEach(c=>{
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.justifyContent='space-between';
        btn.innerHTML = `<span>${c.title||'Sans titre'}</span>
                         <span class="muted" style="font-size:12px">${new Date(c.created_at).toLocaleString()}</span>`;
        btn.onclick = ()=> openChat(c.id);
        chatList.appendChild(btn);
      });
    }

    async function openChat(chatId){
      currentChatId = chatId;
      localStorage.setItem('pf_chat_id', chatId);
      thread.innerHTML = '';
      chatTitle.textContent = 'Discussion';
      const { data, error } = await sb.from('messages').select('role,content,created_at').eq('chat_id', chatId).order('created_at',{ascending:true});
      if(!error && data){ data.forEach(m => addMsg(m.content, m.role==='user'?'me':'ai')); }
      drawer.classList.add('hidden');
      promptEl.focus();
      try{
        const { data: p } = await sb.from('proposals').select('spec').eq('chat_id', chatId).maybeSingle();
        if(p?.spec){ spec = p.spec; saveSpec(); renderPreview(); }
      }catch{}
    }

    async function ensureChat(titleFallback='Nouvelle discussion'){
      if(IS_GUEST) return null;
      if(currentChatId) return currentChatId;
      const { data:{ user } } = await sb.auth.getUser();
      if(!user) return null;
      const title = (promptEl.value||titleFallback).slice(0,80);
      const { data, error } = await sb.from('chats').insert({ user_id:user.id, title }).select().single();
      if(error) return null;
      currentChatId = data.id;
      localStorage.setItem('pf_chat_id', data.id);
      return data.id;
    }

    async function saveMessage(role, content){
      if(IS_GUEST || !currentChatId) return;
      const { data:{ user } } = await sb.auth.getUser();
      if(!user) return;
      await sb.from('messages').insert({ chat_id: currentChatId, user_id: user.id, role, content });
    }

    /* ============== API Chat ============== */
    async function callChatAPI(message, proposalSpec, history){
      const { data:{ session } } = await sb.auth.getSession();
      const headers = {'Content-Type':'application/json'};
      if(session?.access_token){ headers.Authorization = `Bearer ${session.access_token}`; }
      const res = await fetch('/api/chat',{ method:'POST', headers, body: JSON.stringify({ message, proposalSpec, history }) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    /* ============== Envoi ============== */
    sendBtn.onclick = async ()=>{
      // Si mode invit√© et essai d√©j√† utilis√© ‚Üí forcer la connexion
      if(IS_GUEST && getGuestCount() >= GUEST_LIMIT){
        alert("Essai gratuit d√©j√† utilis√©. Connectez-vous pour continuer.");
        location.href = 'auth.html?from=studio';
        return;
      }

      const v = (promptEl.value||'').trim(); if(!v) return;
      addMsg(v,'me'); promptEl.value=''; promptEl.focus();
      const beforeCount = getGuestCount();

      sendBtn.classList.add('loading'); sendBtn.disabled=true; setStatus('G√©n√©ration‚Ä¶');
      try{
        await ensureChat('Nouvelle discussion');
        await saveMessage('user', v);

        const history = JSON.parse(localStorage.getItem('pf_chat')||'[]');
        const data = await callChatAPI(v, spec, history);

        if(data.reply){ addMsg(data.reply,'ai'); await saveMessage('assistant',data.reply); }

        if(data.proposalSpec){
          spec = { ...(spec||{}), ...(data.proposalSpec||{}) , meta:{ ...(spec?.meta||{}), ...(data.proposalSpec.meta||{}) } };
          saveSpec(); renderPreview();
          if(!IS_GUEST && currentChatId){
            try{
              const { data:{ user } } = await sb.auth.getUser();
              if(user){
                await sb.from('proposals').upsert({ user_id:user.id, chat_id:currentChatId, spec }, { onConflict:'chat_id' });
              }
            }catch{}
          }
        }

        const newHist = [...history, {role:'user',content:v},{role:'assistant',content:(data.reply||'')}].slice(-30);
        localStorage.setItem('pf_chat', JSON.stringify(newHist));
        setStatus('Aper√ßu mis √† jour');

        // Comptabiliser l‚Äôessai gratuit d√®s le premier aller-retour r√©ussi
        if(IS_GUEST && beforeCount < GUEST_LIMIT){
          incGuestCount();
          enforceGuestLimitUI();
          setTimeout(()=>alert('Votre essai gratuit a √©t√© utilis√©. Connectez-vous pour continuer.'), 50);
        }
      }catch(e){
        console.error(e); addMsg('Erreur serveur. R√©essayez.','ai'); setStatus('Erreur');
      }finally{
        sendBtn.classList.remove('loading');
        // Si l‚Äôessai vient d‚Äô√™tre consomm√©, send reste d√©sactiv√© par enforceGuestLimitUI()
        if(!(IS_GUEST && getGuestCount() >= GUEST_LIMIT)) sendBtn.disabled=false;
      }
    };

    // Clavier : Entr√©e pour envoyer (sans Shift) ‚Ä¢ Alt+Espace pour envoyer
    promptEl.addEventListener('keydown', (e)=>{
      const hasText = (promptEl.value||'').trim().length>0;
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(hasText) sendBtn.click(); }
      if(e.key===' ' && e.altKey){ e.preventDefault(); if(hasText) sendBtn.click(); }
    });

    /* ============== Logo upload + palette ============== */
    logoBtn.onclick = ()=> logoInput.click();
    logoInput.onchange = async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const dataUrl = await fileToDataURL(file);
      const { primary, secondary } = await extractPaletteFromDataUrl(dataUrl);
      spec = spec || { meta:{} };
      spec.meta = { ...(spec.meta||{}), accent: primary, style:{ ...(spec.meta?.style||{}), logoDataUrl:dataUrl, primary, secondary } };
      saveSpec(); renderPreview();
      addMsg(`Logo import√©. Couleurs d√©tect√©es : ${primary} / ${secondary}.`,'ai');
    };
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file);
      });
    }
    async function extractPaletteFromDataUrl(dataUrl){
      const img = new Image(); img.crossOrigin='anonymous'; img.src=dataUrl;
      await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{ willReadFrequently:true });
      const W=180,H=Math.max(90,Math.round(img.height*(W/img.width))); canvas.width=W; canvas.height=H;
      ctx.drawImage(img,0,0,W,H);
      const { data }=ctx.getImageData(0,0,W,H);
      const map=new Map();
      for(let i=0;i<data.length;i+=4*10){
        const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3]/255; if(a<0.6) continue;
        const lum=(0.2126*r+0.7152*g+0.0722*b)/255; if(lum<0.12||lum>0.98) continue;
        const key=((r&0xF0)<<16)|((g&0xF0)<<8)|(b&0xF0); map.set(key,(map.get(key)||0)+1);
      }
      const sorted=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(([k])=>{
        const r=(k>>16)&0xF0,g=(k>>8)&0xF0,b=k&0xF0;
        return `#${(r|0x0F).toString(16).padStart(2,'0')}${(g|0x0F).toString(16).padStart(2,'0')}${(b|0x0F).toString(16).padStart(2,'0')}`.toUpperCase();
      });
      const primary=sorted[0]||'#3B82F6';
      let secondary='#8B5CF6';
      for(let i=1;i<sorted.length;i++){ if(colorDistance(sorted[0],sorted[i])>80){ secondary=sorted[i]; break; } }
      return {primary,secondary};
    }
    function colorDistance(h1,h2){
      const a=hexToRGB(h1),b=hexToRGB(h2); const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db);
    }
    function hexToRGB(h){ const s=h.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }

    /* ============== Preview ============== */
    const previewEl = $('#preview');
    const emailModeBtn = $('#emailModeBtn');
    let emailMode = false;
    $('#openFull').onclick = ()=>{ window.location.href='preview.html'; };
    emailModeBtn.onclick = ()=>{ emailMode=!emailMode; emailModeBtn.textContent = emailMode?'Vue compl√®te':'Mode Email'; renderPreview(); };

    function money(n,c){ try{ return new Intl.NumberFormat('fr-FR',{style:'currency',currency:c||'EUR'}).format(Number(n||0)); }catch{ return String(n||0)+' '+(c||'‚Ç¨'); } }
    function safeArr(v){ return Array.isArray(v)?v:[]; }
    function safeStr(v,f=''){ return (v==null?'':String(v)).trim()||f; }
    function fmtDate(d){ try{ const dt=d?new Date(d):new Date(); return dt.toLocaleDateString('fr-FR',{year:'numeric',month:'short',day:'2-digit'});}catch{ return '' } }

    function renderPreview(){
      if(!spec){ previewEl.innerHTML='<div class="muted">Aucune donn√©e.</div>'; return; }
      const primary = spec?.meta?.style?.primary || spec?.meta?.accent || '#3b82f6';
      const secondary = spec?.meta?.style?.secondary || '#8b5cf6';
      document.documentElement.style.setProperty('--accent', primary);
      document.documentElement.style.setProperty('--accent2', secondary);

      const L = (spec.meta?.lang==='en') ? {
        title:"Business Proposal", to:"To", from:"Issued by", date:"Date", letter:"Cover Letter",
        executive:"Executive Summary", objectives:"Objectives", approach:"Approach & Phasing", deliverables:"Deliverables",
        in_scope:"In scope", out_scope:"Out of scope", timeline:"Timeline", pricing:"Pricing", terms:"Terms",
        assumptions:"Assumptions / Risks", next:"Next Steps"
      } : {
        title:"Proposition commerciale", to:"Pour", from:"√âmis par", date:"Date", letter:"Lettre d‚Äôintroduction",
        executive:"R√©sum√© ex√©cutif", objectives:"Objectifs", approach:"Approche & phasage", deliverables:"Livrables",
        in_scope:"Inclus", out_scope:"Hors-p√©rim√®tre", timeline:"Planning", pricing:"Tarification", terms:"Conditions",
        assumptions:"Hypoth√®ses / Risques", next:"Prochaines √©tapes"
      };

      previewEl.innerHTML = '';
      const company = safeStr(spec.meta?.company || spec.meta?.brand?.company, 'Votre soci√©t√©');
      const client  = safeStr(spec.meta?.client, 'Client');
      const title   = safeStr(spec.meta?.title, L.title);
      const date    = safeStr(spec.meta?.date, fmtDate());

      const h1 = document.createElement('div');
      h1.innerHTML = `<div class="h1">${title}</div>
                      <div class="meta">${L.to}: <span class="tag">${client}</span> ‚Ä¢ ${L.from}: <span class="tag">${company}</span> ‚Ä¢ ${L.date}: ${date}</div>`;
      previewEl.appendChild(h1);

      if(emailMode){
        const letter = spec.letter || {};
        if(letter.greeting) p(letter.greeting);
        safeArr(letter.body_paragraphs?.length ? letter.body_paragraphs : letter.paragraphs).forEach(t=>p(t));
        if(letter.closing) p(letter.closing);
        if(letter.signature) p(letter.signature);
        return;
      }

      if(spec.letter && (spec.letter.greeting || (safeArr(spec.letter.body_paragraphs).length||safeArr(spec.letter.paragraphs).length) || spec.letter.closing || spec.letter.signature)){
        h2(L.letter);
        const letter = spec.letter;
        if(letter.greeting) p(letter.greeting);
        (safeArr(letter.body_paragraphs?.length?letter.body_paragraphs:letter.paragraphs)).forEach(t=>p(t));
        if(letter.closing) p(letter.closing);
        if(letter.signature) p(letter.signature);
      }

      if(safeArr(spec.executive_summary?.paragraphs).length){ h2(L.executive); safeArr(spec.executive_summary.paragraphs).forEach(t=>p(t)); }
      if(safeArr(spec.objectives?.bullets).length){ h2(L.objectives); ul(spec.objectives.bullets); }

      if(safeArr(spec.approach?.phases).length){
        h2(L.approach);
        spec.approach.phases.forEach((ph,i)=>{
          const c = card(`<strong>Phase ${i+1} ‚Äî ${safeStr(ph.title,'√Ä confirmer')}</strong> <span class="muted">${safeStr(ph.duration,'')}</span>`);
          previewEl.appendChild(c);
          if(ph.description) p(ph.description);
          const acts = safeArr(ph.activities?.length ? ph.activities : ph.steps);
          if(acts.length){ ul(acts); }
          if(safeArr(ph.outcomes).length){ p('R√©sultats attendus :'); ul(ph.outcomes); }
        });
      }

      if(spec.deliverables && (safeArr(spec.deliverables.in).length || safeArr(spec.deliverables.out).length)){
        h2(L.deliverables);
        const grid = document.createElement('div'); grid.className='grid2';
        const a = card(`<div class="muted">${L.in_scope}</div>`); const b = card(`<div class="muted">${L.out_scope}</div>`);
        grid.appendChild(a); grid.appendChild(b); previewEl.appendChild(grid);
        ulInto(a, safeArr(spec.deliverables.in)); ulInto(b, safeArr(spec.deliverables.out));
      }

      if(safeArr(spec.timeline?.milestones).length){
        h2(L.timeline);
        const grid = document.createElement('div'); grid.className='grid2'; previewEl.appendChild(grid);
        spec.timeline.milestones.forEach(ms=>{
          const c = card(`<strong>${safeStr(ms.title,'√âtape')}</strong> <div class="muted">${safeStr(ms.dateOrWeek||ms.date||ms.duration||'')}</div>`);
          if(ms.notes){ const pp=document.createElement('p'); pp.textContent=ms.notes; c.appendChild(pp); }
          grid.appendChild(c);
        });
      }

      if(spec.pricing && (Array.isArray(spec.pricing.items)?spec.pricing.items.length:spec.pricing.price!=null)){
        h2(L.pricing);
        const pr = spec.pricing; const currency = pr.currency || spec.meta?.currency || 'EUR';
        if(Array.isArray(pr.items) && pr.items.length){
          const table = document.createElement('table');
          table.innerHTML = `<thead><tr><th>Item</th><th>Qt√©</th><th>Unit√©</th><th>PU</th><th>Sous-total</th></tr></thead><tbody></tbody><tfoot></tfoot>`;
          const tb = table.querySelector('tbody');
          let subtotal=0;
          pr.items.forEach(it=>{
            const qty=Number(it.qty||1), up=Number(it.unit_price||0);
            const st = it.subtotal!=null ? Number(it.subtotal) : qty*up; subtotal += (isFinite(st)?st:0);
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${safeStr(it.name,'‚Äî')}</td><td>${qty}</td><td>${safeStr(it.unit||'‚Äî')}</td><td>${money(up,currency)}</td><td>${money(st,currency)}</td>`;
            tb.appendChild(tr);
          });
          const tax = subtotal*((Number(pr.tax_rate||0))/100); const total=subtotal+tax;
          const tf=table.querySelector('tfoot');
          tf.innerHTML = `<tr><td colspan="4" style="text-align:right">Sous-total</td><td>${money(subtotal,currency)}</td></tr>
                          <tr><td colspan="4" style="text-align:right">Taxes</td><td>${money(tax,currency)} ${pr.tax_rate?`(${pr.tax_rate}%)`:''}</td></tr>
                          <tr><td colspan="4" style="text-align:right"><strong>Total</strong></td><td><strong>${money(total,currency)}</strong></td></tr>`;
          previewEl.appendChild(table);
        }else{
          const c = card(`<div style="font-size:20px;font-weight:800">${money(pr.price, currency)}</div>`);
          previewEl.appendChild(c);
        }
        if(safeArr(spec.pricing?.terms).length){
          const c = card(`<div class="muted">Conditions</div>`); ulInto(c, safeArr(spec.pricing.terms)); previewEl.appendChild(c);
        }
      }

      if(safeArr(spec.assumptions?.paragraphs).length){ h2(L.assumptions); safeArr(spec.assumptions.paragraphs).forEach(t=>p(t)); }
      if(safeArr(spec.next_steps?.paragraphs).length){ h2(L.next); safeArr(spec.next_steps.paragraphs).forEach(t=>p(t)); }

      function h2(t){ const el=document.createElement('h2'); el.textContent=t; previewEl.appendChild(el); }
      function p(t){ const el=document.createElement('p'); el.textContent=t; previewEl.appendChild(el); }
      function ul(arr){ const u=document.createElement('ul'); arr.forEach(x=>{const li=document.createElement('li'); li.textContent=x; u.appendChild(li);}); previewEl.appendChild(u); }
      function ulInto(container, arr){ const u=document.createElement('ul'); arr.forEach(x=>{const li=document.createElement('li'); li.textContent=x; u.appendChild(li);}); container.appendChild(u); }
      function card(html){ const c=document.createElement('div'); c.className='card'; c.innerHTML=html; return c; }
    }

    /* ============== Divers ============== */
    document.getElementById('openFull').onclick = ()=>{ window.location.href='preview.html'; };

    // Boot
    loadSpec();
  </script>
</body>
</html>
