<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Studio</title>
  <!-- Polices cohérentes avec le reste du site -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f8fc;
      --panel: #ffffff;
      --ink: #0a1020;
      --muted: #5c667a;
      --stroke: #e0e6f4;
      --accent: #3b82f6;
      --accent2: #8b5cf6;
      --accent-ink: #fff;
      --paper-w: 210mm;
      --paper-h: 297mm;
      --elev: 0 18px 48px rgba(10, 16, 32, 0.10), inset 0 1px 0 #ffffffaa;
      --transition: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
      --focus: #a5b4fc;
      --radius: 12px;
      --font-heading: 'Playfair Display', serif;
      --font-body: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      height: 100vh;
      background: linear-gradient(180deg, var(--bg), #eef3ff);
      font-family: var(--font-body);
      color: var(--ink);
      perspective: 1200px;
    }

    /* --- Layout Principal --- */
    .main {
      height: calc(100vh - 64px);
      display: grid;
      grid-template-columns: clamp(520px, 38vw, 640px) 1fr;
      gap: 18px;
      padding: 18px 24px;
      align-items: stretch;
      min-height: 0;
    }
    @media (max-width: 1100px) { .main { grid-template-columns: 1fr; } }

    /* --- Barre Supérieure --- */
    .bar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--panel);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      box-shadow: var(--elev);
    }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 800; cursor: pointer; }
    .spark { width: 22px; height: 22px; border-radius: 6px; background: conic-gradient(from 180deg, #93c5fd, #c4b5fd, #60a5fa, #93c5fd); }
    .btn { border: 1px solid var(--stroke); background: var(--panel); border-radius: 10px; padding: 8px 12px; font-weight: 700; cursor: pointer; box-shadow: var(--elev); transition: all var(--transition); }
    .btn.primary { background: #0a1020; color: #fff; border-color: #0a1020; }

    /* --- Chat --- */
    .chat { min-height: 0; display: flex; flex-direction: column; }
    .chat-body { padding: 12px; overflow: auto; flex: 1; min-height: 0; }
    .msg { display: flex; gap: 10px; margin: 10px 0; align-items: flex-end; width: 100%; }
    .bubble { max-width: min(100%, 560px); padding: 10px 12px; border-radius: 14px; border: 1px solid var(--stroke); box-shadow: var(--elev); word-wrap: break-word; }
    .bubble-assistant { background: color-mix(in hsl, var(--panel) 86%, transparent); }
    .bubble-user { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: var(--accent-ink); border-color: transparent; }
    .chat-compose { position: relative; padding: 12px; border-top: 1px solid var(--stroke); display: flex; align-items: flex-end; gap: 16px; }
    .input textarea { flex: 1; resize: vertical; min-height: 72px; border: none; outline: none; background: transparent; font: 500 14px/1.4 var(--font-body); color: var(--ink); }

    /* --- Aperçu --- */
    .sheet-wrap { flex: 1; min-height: 0; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 12px 24px; }
    .sheet { position: relative; width: var(--paper-w); max-width: 100%; background: transparent; border: none; box-shadow: none; color: var(--ink); font-family: var(--font-body); }
    .page { position: relative; width: var(--paper-w); min-height: var(--paper-h); background: var(--panel); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--elev); margin: 0 0 16mm 0; overflow: hidden; }
    .inner { padding: 22mm 18mm; position: relative; z-index: 1; }
    .h1 { font-family: var(--font-heading); font-size: 34px; line-height: 1.05; margin: 0 0 10px; font-weight: 900; letter-spacing: -0.01em; }
    .h2 { font-family: var(--font-heading); margin: 0 0 10px; font-size: 22px; font-weight: 800; letter-spacing: 0.2px; }

    /* --- Conteneur 3D --- */
    #three-container {
      width: 100%;
      height: 300px;
      position: relative;
      background: linear-gradient(to bottom, #f0f4ff, #e6f0ff);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--elev);
      margin: 10px 0;
    }

    /* --- Animations --- */
    .fade-in { animation: fadeIn 0.9s cubic-bezier(0.4, 0, 0.2, 1) both; }
    @keyframes fadeIn { 0% { opacity: 0; transform: translateY(32px); } 100% { opacity: 1; transform: none; } }
  </style>
  <!-- Dépendances critiques -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="lang.js"></script>
</head>
<body>
  <!-- Barre supérieure -->
  <div class="bar">
    <div class="left">
      <div class="brand" id="homeBtn"><div class="spark"></div>PropoFlash</div>
      <button class="btn" id="openHistory">Historique</button>
      <button class="btn primary" id="newChatBtn">Nouvelle discussion</button>
      <span class="muted" id="status">Prêt</span>
    </div>
    <div class="right">
      <label class="muted">Langue</label>
      <select class="sel" id="langSel" data-lang-picker>
        <option value="fr">FR</option>
        <option value="en">EN</option>
      </select>
      <div class="avatar" id="avatar">U</div>
    </div>
  </div>

  <!-- Conteneur principal -->
  <div class="main">
    <!-- Chat -->
    <div class="panel chat">
      <div class="chat-head"><strong class="chat-title">Chat</strong></div>
      <div class="chat-body" id="chatBody"></div>
      <div class="chat-compose">
        <div class="input">
          <textarea id="composer" placeholder="Écrivez votre message" enterkeyhint="send" autocomplete="off"></textarea>
          <button class="send" id="sendBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="20" height="20">
              <path d="M22 2L11 13"></path>
              <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Aperçu -->
    <div class="panel sheet-wrap">
      <div class="sheet" id="sheet">
        <div id="three-container"></div>
        <div class="content" id="sheetContent"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Configuration Supabase ---
    const SUPABASE_URL = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // --- Variables globales ---
    let messages = JSON.parse(localStorage.getItem('pf_chat') || '[]');
    let spec = JSON.parse(localStorage.getItem('pf_proposal') || JSON.stringify({
      meta: {
        lang: 'fr',
        title: 'Proposition commerciale',
        style: {
          palette: { primary: "#3B82F6", secondary: "#8B5CF6" },
          typography: { heading: "Playfair Display", body: "Inter" }
        }
      }
    }));

    // --- DOM Elements ---
    const chatBody = document.getElementById('chatBody');
    const composer = document.getElementById('composer');
    const sendBtn = document.getElementById('sendBtn');
    const statusEl = document.getElementById('status');
    const sheetContent = document.getElementById('sheetContent');
    const threeContainer = document.getElementById('three-container');

    // --- Three.js Setup ---
    let scene, camera, renderer, cube;
    function initThreeJS() {
      if (scene) return; // Évite les doublons

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, threeContainer.clientWidth / 300, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(threeContainer.clientWidth, 300);
      threeContainer.appendChild(renderer.domElement);

      // Cube 3D par défaut
      const geometry = new THREE.BoxGeometry();
      const material = new THREE.MeshBasicMaterial({
        color: spec.meta.style.palette.primary || 0x3B82F6,
        transparent: true,
        opacity: 0.8
      });
      cube = new THREE.Mesh(geometry, material);
      scene.add(cube);

      camera.position.z = 5;

      function animate() {
        requestAnimationFrame(animate);
        cube.rotation.x += 0.01;
        cube.rotation.y += 0.01;
        renderer.render(scene, camera);
      }
      animate();

      // Redimensionnement
      window.addEventListener('resize', () => {
        camera.aspect = threeContainer.clientWidth / 300;
        camera.updateProjectionMatrix();
        renderer.setSize(threeContainer.clientWidth, 300);
      });
    }

    // --- Rendu de l'aperçu ---
    function renderPreview() {
      sheetContent.innerHTML = `
        <div class="page fade-in">
          <div class="inner">
            <h1 class="h1">${spec.meta.title || 'Proposition commerciale'}</h1>
            <p style="font-family: var(--font-body);">Aperçu en temps réel de votre proposition.</p>
            <div style="margin: 20px 0; font-family: var(--font-body);">
              <strong>Style actuel :</strong>
              <div>Police titre: ${spec.meta.style.typography.heading}</div>
              <div>Police texte: ${spec.meta.style.typography.body}</div>
            </div>
          </div>
        </div>
      `;
    }

    // --- Envoi de message avec gestion d'erreur robuste ---
    async function sendMessage() {
      const content = composer.value.trim();
      if (!content) return;

      // Ajoute le message utilisateur
      messages.push({ role: 'user', content });
      localStorage.setItem('pf_chat', JSON.stringify(messages));
      chatBody.innerHTML += `
        <div class="msg user">
          <div class="bubble bubble-user">${escapeHTML(content).replace(/\n/g, '<br/>')}</div>
        </div>
      `;
      composer.value = '';
      scrollChat();

      // Affiche l'état de chargement
      statusEl.textContent = 'Génération en cours...';
      chatBody.innerHTML += `
        <div class="msg assistant" id="typing-indicator">
          <div class="avatar-badge bot">PF</div>
          <div class="bubble bubble-assistant">
            <span class="typing">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </span>
          </div>
        </div>
      `;
      scrollChat();

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: content,
            proposalSpec: spec,
            history: messages.slice(-10)
          })
        });

        if (!response.ok) throw new Error(`Erreur ${response.status}: ${response.statusText}`);

        const data = await response.json();

        // Supprime l'indicateur de typing
        document.getElementById('typing-indicator')?.remove();

        // Ajoute la réponse de l'IA
        messages.push({ role: 'assistant', content: data.reply });
        chatBody.innerHTML += `
          <div class="msg assistant">
            <div class="avatar-badge bot">PF</div>
            <div class="bubble bubble-assistant">${escapeHTML(data.reply).replace(/\n/g, '<br/>')}</div>
          </div>
        `;

        // Met à jour la spec et l'aperçu
        if (data.proposalSpec) {
          spec = { ...spec, ...data.proposalSpec };
          localStorage.setItem('pf_proposal', JSON.stringify(spec));
          renderPreview();

          // Met à jour Three.js si des couleurs changent
          if (cube && data.proposalSpec.meta?.style?.palette?.primary) {
            cube.material.color.set(data.proposalSpec.meta.style.palette.primary);
          }
        }

        statusEl.textContent = 'Prêt';
      } catch (error) {
        console.error("Erreur API:", error);
        statusEl.textContent = 'Erreur réseau';
        document.getElementById('typing-indicator')?.remove();
        chatBody.innerHTML += `
          <div class="msg assistant">
            <div class="avatar-badge bot">PF</div>
            <div class="bubble bubble-assistant">
              <em style="color: #e74c3c;">Erreur de connexion. Vérifiez votre réseau ou réessayez.</em>
            </div>
          </div>
        `;
      }
      scrollChat();
    }

    // --- Gestion du scroll du chat ---
    function scrollChat() {
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // --- Échappement HTML pour sécurité ---
    function escapeHTML(s) {
      return String(s || '').replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
      }[m]));
    }

    // --- Initialisation ---
    function init() {
      // Charge l'historique du chat
      messages.forEach(m => {
        chatBody.innerHTML += `
          <div class="msg ${m.role}">
            ${m.role === 'assistant' ?
              `<div class="avatar-badge bot">PF</div><div class="bubble bubble-assistant">${escapeHTML(m.content).replace(/\n/g, '<br/>')}</div>` :
              `<div class="bubble bubble-user">${escapeHTML(m.content).replace(/\n/g, '<br/>')}</div><div class="avatar-badge you">ME</div>`}
          </div>
        `;
      });

      // Initialise Three.js et l'aperçu
      initThreeJS();
      renderPreview();

      // Écouteurs d'événements
      sendBtn.addEventListener('click', sendMessage);
      composer.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // Démarre l'application
    init();
  </script>
</body>
</html>
