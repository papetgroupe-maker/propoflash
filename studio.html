<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fc; --panel:#ffffff; --ink:#0a1020; --muted:#5c667a; --stroke:#e0e6f4;
      --accent:#3b82f6; --accent2:#8b5cf6; --accent-ink:#fff;
      --paper-w:210mm; --paper-h:297mm;
      --elev:0 18px 48px rgba(10,16,32,.10), inset 0 1px 0 #ffffffaa;

      /* Chat themes */
      --assistant-bubble: color-mix(in hsl, var(--panel) 86%, transparent);
      --user-bubble: linear-gradient(135deg, var(--accent), var(--accent2));
      --user-ink: #ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      height:100vh;
      overflow:hidden; /* pas de scroll de page */
      background:linear-gradient(180deg,var(--bg),#eef3ff);
      font-family:Inter,system-ui,sans-serif;color:var(--ink)
    }

    /* Top bar */
    .bar{position:sticky;top:0;z-index:30;background:var(--panel);border-bottom:1px solid var(--stroke);
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px;box-shadow:var(--elev)}
    .left,.right{display:flex;gap:10px;align-items:center}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;cursor:pointer}
    .spark{width:22px;height:22px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .btn{border:1px solid var(--stroke);background:var(--panel);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:var(--elev)}
    .sel{border:1px solid var(--stroke);border-radius:10px;padding:7px 10px;background:var(--panel);color:var(--ink)}
    .avatar{width:32px;height:32px;border-radius:50%;border:1px solid var(--stroke);display:grid;place-items:center;font-weight:800;background:var(--panel);cursor:pointer;box-shadow:var(--elev)}
    .menu{position:absolute;top:54px;right:14px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;box-shadow:var(--elev);display:none;overflow:hidden}
    .menu a,.menu button{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:var(--panel);cursor:pointer;font-weight:600;color:var(--ink)}
    .menu a:hover,.menu button:hover{background:color-mix(in hsl, var(--panel) 80%, transparent)}

    /* Layout principal : chat + preview */
    .main{
      height:calc(100vh - 64px);
      display:grid;
      grid-template-columns: clamp(520px, 38vw, 640px) 1fr;
      gap:18px;
      padding:18px 24px;
      align-items:stretch;
      min-height:0;
    }
    .panel{
      background:var(--panel);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--elev);
      display:flex;flex-direction:column;
      min-height:0;
    }

    /* Chat */
    .chat{min-height:0; display:flex;flex-direction:column;}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke)}
    .chat-title{font-weight:800}
    .chat-body{ padding:12px; overflow:auto; flex:1; min-height:0; }
    .msg{ display:flex; gap:10px; margin:10px 0; align-items:flex-end; width:100%; }
    .msg.assistant{justify-content:flex-start}
    .msg.user{justify-content:flex-end}
    .avatar-badge{ width:28px;height:28px;border-radius:50%;display:grid;place-items:center;font-weight:800;font-size:11px;border:1px solid var(--stroke);box-shadow:var(--elev);background:var(--panel);color:var(--ink);user-select:none; }
    .avatar-badge.bot{background:#111827;color:#fff;border-color:#111827}
    .avatar-badge.you{background:var(--accent);color:#fff;border-color:transparent}
    .bubble{ max-width:min(100%, 560px); padding:10px 12px;border-radius:14px;border:1px solid var(--stroke); box-shadow:var(--elev); word-wrap:break-word;overflow-wrap:anywhere; }
    .bubble-assistant{ background:var(--assistant-bubble); color:var(--ink); }
    .bubble-user{ background:var(--user-bubble); color:var(--user-ink); border-color:transparent; }
    .chat-compose{ position:relative; padding:12px; border-top:1px solid var(--stroke); display:flex;align-items:flex-end;gap:16px; }
    .logo-wrap{ position:relative; flex:0 0 auto; }
    .input{ display:flex;gap:8px;align-items:flex-end;background:var(--panel);border:1px solid var(--stroke); border-radius:14px;padding:8px;box-shadow:var(--elev); flex:1; }
    .input textarea{flex:1;resize:vertical;min-height:72px;border:none;outline:none;background:transparent;font:500 14px/1.4 Inter;color:var(--ink)}
    .send{width:40px;height:40px;border-radius:12px;border:1px solid var(--stroke);background:#0a1020;color:#fff;display:grid;place-items:center;cursor:pointer}
    .logo-btn{width:34px;height:34px;border-radius:10px;border:1px solid #0002;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd);box-shadow:var(--elev);display:grid;place-items:center;cursor:pointer}
    .logo-btn input{display:none}
    .logo-tip{ position:absolute;left:0;bottom:44px;background:#111;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;display:none;white-space:nowrap }
    .logo-wrap:hover .logo-tip{display:block}
    .typing{display:inline-flex;gap:5px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#8aa0c6;opacity:.7;animation:bounce 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}

    /* Aperçu */
    .sheet-wrap{ flex:1; min-height:0; overflow:auto; display:flex;justify-content:center;align-items:flex-start; padding:12px 24px; }
    .sheet{ position:relative; overflow:visible; width:var(--paper-w); max-width:100%; background:transparent; border:none; box-shadow:none; color:var(--ink); font-family: var(--font-body, Inter), system-ui, sans-serif; }
    .decor{position:fixed; inset:0; pointer-events:none; z-index:0}
    .content{position:relative; z-index:1}
    .page{ position:relative; width:var(--paper-w); min-height:var(--paper-h); background:var(--panel); border:1px solid var(--stroke); border-radius:var(--radius, 12px); box-shadow:var(--elev); margin:0 0 16mm 0; overflow:hidden; }
    .page:last-child{margin-bottom:0}
    .inner{ padding:22mm 18mm; position:relative; z-index:1; }
    .page .page-decor{ position:absolute; inset:0; pointer-events:none; z-index:0 }

    .doc-header{display:grid;grid-template-columns:100px 1fr;gap:16px;align-items:center;margin-bottom:16px}
    .logo-box{width:100px;height:100px;border:1px solid var(--stroke);border-radius:var(--radius, 12px);display:grid;place-items:center;overflow:hidden;background:var(--panel)}
    .logo-box img{width:100%;height:100%;object-fit:contain}
    .brand-info .company{font-weight:800;font-size:18px; font-family: var(--font-heading, Inter), system-ui, sans-serif;}
    .brand-info .muted{color:var(--muted);font-size:12px}
    .toc{border:1px solid var(--stroke);border-radius:var(--radius, 12px);padding:10px 12px;background:color-mix(in hsl, var(--panel) 85%, transparent);margin:10px 0 14px}
    .toc b{display:block;margin-bottom:6px}
    .toc a{display:block;text-decoration:none;color:var(--ink);font-size:13px;margin:4px 0}
    .toc a:hover{text-decoration:underline}
    .h1{font-size:34px;line-height:1.05;margin:0 0 10px;font-weight:900;letter-spacing:-.01em; font-family: var(--font-heading, Inter), system-ui, sans-serif;}
    .h2{margin:0 0 10px;font-size:22px;font-weight:800;letter-spacing:.2px; font-family: var(--font-heading, Inter), system-ui, sans-serif;}
    .meta{color:var(--muted);font-size:14px;margin-bottom:18px}
    .band{border-radius:var(--radius, 12px);padding:14px 16px;background:color-mix(in hsl, var(--accent) 12%, var(--panel));border:1px solid var(--stroke);margin:10px 0}
    .hr{height:1px;background:var(--stroke);margin:12px 0}
    p{margin:8px 0 10px}
    ul{margin:8px 0 10px 18px}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:color-mix(in hsl, var(--accent) 16%, transparent);border:1px solid var(--stroke);font-size:12px;color:var(--ink)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border:1px solid var(--stroke);border-radius:var(--radius, 12px);padding:12px;background:var(--panel);box-shadow:var(--elev)}
    .price{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:var(--panel)}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border:1px solid var(--stroke);padding:8px;text-align:left}
    th{background:color-mix(in hsl, var(--panel) 85%, transparent)}
    tfoot td{font-weight:800}

    /* Editable (aperçu live) */
    .editable{outline:1px dashed #9fb0d0; outline-offset:2px; border-radius:6px}
    .editable:hover{background:rgba(147,197,253,.14)}
    .hint-bar{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:rgba(17,24,39,.9);color:#fff;border-radius:10px;padding:6px 10px;font-size:12px;display:flex;gap:12px;align-items:center;z-index:60}
    .hint-bar kbd{background:#111827;color:#fff;border:1px solid #334155;border-radius:6px;padding:2px 6px;font-size:11px}

    /* Designer (panneau latéral) */
    .designer{position:fixed;right:18px;bottom:18px;z-index:50;display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .fab{width:48px;height:48px;border-radius:14px;border:1px solid #0002;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd);box-shadow:var(--elev);display:grid;place-items:center;cursor:pointer}
    .fab svg{filter:drop-shadow(0 6px 14px rgba(0,0,0,.25))}
    .panel-des{width:320px;max-width:92vw;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;box-shadow:var(--elev);display:none}
    .panel-des header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--stroke);font-weight:800}
    .panel-des .body{padding:10px 12px;display:grid;gap:10px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
    .row input[type="color"]{width:44px;height:28px;border:1px solid var(--stroke);border-radius:8px;background:#fff}
    .row input[type="text"], .row select, .row input[type="number"]{width:100%;padding:8px;border:1px solid var(--stroke);border-radius:10px;background:#fff}
    .row .help{font-size:12px;color:var(--muted);grid-column:1/-1}

    /* Toast */
    .toast{position:fixed;right:18px;top:18px;background:#111827;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-size:13px;box-shadow:var(--elev);display:none;z-index:70}

    /* Impression */
    @media print{
      .bar,.designer,.hint-bar,.toast{display:none}
      body{overflow:visible;height:auto;background:#fff}
      .main{height:auto}
      .sheet-wrap{overflow:visible;flex:auto;min-height:auto;padding:0}
      .page{page-break-after:always; box-shadow:none; margin:0; border:0; border-radius:0}
      .page:last-child{page-break-after:auto}
      .inner{padding:18mm 16mm}
      a[href]:after{content:""}
    }

    @media (max-width:1100px){
      .main{grid-template-columns:1fr}
      .page{width:100%;min-height:auto}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="lang.js"></script>
</head>
<body>
  <!-- Top bar -->
  <div class="bar">
    <div class="left">
      <div class="brand" id="homeBtn"><div class="spark" aria-hidden="true"></div>PropoFlash</div>
      <button class="btn" id="openHistory">Historique</button>
      <span class="muted" id="status">Prêt</span>
    </div>
    <div class="right">
      <label class="muted">Langue</label>
      <select class="sel" id="langSel" data-lang-picker><option value="fr">FR</option><option value="en">EN</option></select>
      <div class="avatar" id="avatar">U</div>
      <div class="menu" id="menu">
        <a href="studio.html">Studio</a>
        <a href="#history">Historique</a>
        <button id="logoutBtn">Se déconnecter</button>
      </div>
    </div>
  </div>

  <!-- History drawer (simple) -->
  <div class="drawer" id="drawer" style="position:fixed;left:0;top:64px;bottom:0;width:320px;max-width:90vw;background:var(--panel);border-right:1px solid var(--stroke);box-shadow:var(--elev);padding:12px;display:none;z-index:40">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Historique</h3>
      <button class="btn" id="closeDrawer">Fermer</button>
    </div>
    <div class="drawer-list" id="histList" style="margin-top:8px;display:grid;gap:8px"></div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Chat -->
    <div class="panel chat">
      <div class="chat-head"><strong class="chat-title">Chat</strong></div>
      <div class="chat-body" id="chatBody" aria-live="polite"></div>

      <div class="chat-compose">
        <div class="logo-wrap">
          <label class="logo-btn" title="Ajouter un logo (PNG/JPG/SVG)">
            <input type="file" id="logoInput" accept="image/*,.svg"/>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0a1020" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          </label>
          <div class="logo-tip">Ajouter votre logo</div>
        </div>
        <div class="input">
          <textarea id="composer" placeholder="Écrivez votre message"></textarea>
          <button class="send" id="sendBtn" title="Envoyer" aria-label="Envoyer">
            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="20" height="20"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Aperçu -->
    <div class="panel sheet-wrap">
      <div class="sheet" id="sheet">
        <div class="decor" id="decor"></div>
        <div class="content" id="sheetContent"></div>
      </div>
    </div>
  </div>

  <!-- Hint bar -->
  <div class="hint-bar" id="hint" style="display:none">
    <span>Double-clic pour éditer • <kbd>Cmd/Ctrl</kbd> + <kbd>K</kbd> pour IA (réécriture/ton/traduction)</span>
  </div>

  <!-- Designer -->
  <div class="designer">
    <div class="panel-des" id="designerPanel" role="dialog" aria-label="Designer">
      <header>
        <span>Designer</span>
        <button class="btn" id="closeDesigner">Fermer</button>
      </header>
      <div class="body">
        <div class="row"><label>Primary</label><input type="color" id="cPrimary"><input type="text" id="tPrimary" placeholder="#3B82F6"></div>
        <div class="row"><label>Secondary</label><input type="color" id="cSecondary"><input type="text" id="tSecondary" placeholder="#8B5CF6"></div>
        <div class="row"><label>Surface</label><input type="color" id="cSurface"><input type="text" id="tSurface" placeholder="#FFFFFF"></div>
        <div class="row"><label>Ink</label><input type="color" id="cInk"><input type="text" id="tInk" placeholder="#0A1020"></div>
        <div class="row"><label>Muted</label><input type="color" id="cMuted"><input type="text" id="tMuted" placeholder="#5C667A"></div>
        <div class="row"><label>Stroke</label><input type="color" id="cStroke"><input type="text" id="tStroke" placeholder="#E0E6F4"></div>
        <div class="row"><label>Heading</label>
          <select id="sHeading">
            <option>Inter</option><option>Montserrat</option><option>Poppins</option><option>Playfair</option><option>DM Sans</option>
          </select>
        </div>
        <div class="row"><label>Body</label>
          <select id="sBody">
            <option>Inter</option><option>DM Sans</option><option>Poppins</option>
          </select>
        </div>
        <div class="row"><label>Rayon</label><input type="number" id="nRadius" min="4" max="28" step="1" value="12"><div class="help">Rayon des cartes/pages (px)</div></div>
        <div class="row"><label>Décor</label>
          <select id="sDecor">
            <option value="none">Aucun</option>
            <option value="glow">Glow</option>
            <option value="gradient_blob">Blob</option>
            <option value="grid">Grille</option>
            <option value="dots">Dots</option>
            <option value="diagonal">Diagonales</option>
          </select>
        </div>
      </div>
    </div>
    <button class="fab" id="openDesigner" title="Designer">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0a1020" stroke-width="2">
        <path d="M12 2v4M12 18v4M2 12h4M18 12h4M4.9 4.9l2.8 2.8M16.3 16.3l2.8 2.8M19.1 4.9l-2.8 2.8M7.7 16.3L4.9 19.1"/>
      </svg>
    </button>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    /* Supabase guard (1 essai anonyme) */
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    async function guard(){
      const { data:{ session } } = await sb.auth.getSession();
      if(session?.user) return true;
      const tries = parseInt(localStorage.getItem('pf_anon_uses')||'0',10);
      if(tries>=1){ /* pas de redirection bloquante pour l’aperçu live */ return true; }
      localStorage.setItem('pf_anon_uses', String(tries+1));
      return true;
    }
    guard();

    /* Profil menu */
    const avatar=document.getElementById('avatar'), menu=document.getElementById('menu'), logoutBtn=document.getElementById('logoutBtn');
    (async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      avatar.textContent = session?.user ? (session.user.email||'?')[0].toUpperCase() : 'U';
    })();
    avatar.onclick = (e)=>{ e.stopPropagation(); menu.style.display = menu.style.display==='block'?'none':'block'; };
    document.addEventListener('click', ()=> menu.style.display='none');
    logoutBtn.onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

    /* Nav + drawer historique (caché par défaut) */
    document.getElementById('homeBtn').onclick=()=>location.href='index.html';
    const drawer=document.getElementById('drawer'); const histList=document.getElementById('histList');
    document.getElementById('openHistory').onclick = ()=> { drawer.style.display='block'; };
    document.getElementById('closeDrawer').onclick = ()=> { drawer.style.display='none'; };

    function saveHistory(title, spec, messages){
      const h=JSON.parse(localStorage.getItem('pf_history')||'[]');
      h.unshift({ id:Date.now(), title, date:new Date().toISOString(), spec, messages });
      localStorage.setItem('pf_history', JSON.stringify(h.slice(0,100)));
      renderHistory();
    }
    function renderHistory(){
      const h=JSON.parse(localStorage.getItem('pf_history')||'[]');
      histList.innerHTML='';
      if(!h.length){ histList.innerHTML='<div class="muted" style="padding:8px">Aucun élément</div>'; return; }
      h.forEach(item=>{
        const d=new Date(item.date);
        const div=document.createElement('div');
        div.style.border='1px solid var(--stroke)'; div.style.borderRadius='10px'; div.style.padding='8px'; div.style.cursor='pointer';
        div.innerHTML = `<strong>${item.title||'Sans titre'}</strong><br><span class="muted">${d.toLocaleString()}</span>`;
        div.onclick=()=>{ spec=item.spec; messages=item.messages||[]; localStorage.setItem('pf_proposal', JSON.stringify(spec)); renderSpec(); renderChat(); drawer.style.display='none'; };
        histList.appendChild(div);
      });
    }
    renderHistory();

    /* Chat + Spec */
    const chatBody=document.getElementById('chatBody');
    const composer=document.getElementById('composer');
    const sendBtn=document.getElementById('sendBtn');
    const statusEl=document.getElementById('status');
    const sheet=document.getElementById('sheet');
    const decor=document.getElementById('decor');
    const sheetContent=document.getElementById('sheetContent');
    const hint=document.getElementById('hint');

    let messages = JSON.parse(localStorage.getItem('pf_chat')||'[]');
    let spec = null;

    function loadSpec(){
      try{ spec = JSON.parse(localStorage.getItem('pf_proposal')||'null'); }catch{ spec=null; }
      if(!spec){ spec = { meta:{ lang:getLang(), title:(getLang()==='en'?'Business Proposal':'Proposition commerciale'), currency:'EUR' }, sections:[] }; }
      if(!spec.meta) spec.meta = { lang:getLang() };
    }
    loadSpec();

    (function consumeWelcome(){
      const w = localStorage.getItem('pf_welcome_msg');
      if(w){ messages.push({ role:'user', content:w }); localStorage.removeItem('pf_welcome_msg'); }
    })();

    function scrollChat(){ chatBody.scrollTop = chatBody.scrollHeight; }
    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
    function toast(msg, t=1800){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=> el.style.display='none', t); }

    /* Bullles */
    function bubble(role, html){
      const row=document.createElement('div');
      row.className='msg '+(role==='assistant'?'assistant':'user');
      const ava=document.createElement('div');
      ava.className='avatar-badge '+(role==='assistant'?'bot':'you');
      ava.textContent = (role==='assistant') ? 'PF' : 'ME';
      const bub=document.createElement('div');
      bub.className='bubble '+(role==='assistant'?'bubble-assistant':'bubble-user');
      bub.innerHTML=html;
      if(role==='assistant'){ row.appendChild(ava); row.appendChild(bub); }
      else { row.appendChild(bub); row.appendChild(ava); }
      chatBody.appendChild(row);
      scrollChat();
      return row;
    }
    let typingRow=null;
    function showTyping(){
      if(typingRow) return;
      typingRow = document.createElement('div');
      typingRow.className='msg assistant';
      const ava=document.createElement('div'); ava.className='avatar-badge bot'; ava.textContent='PF';
      const bub=document.createElement('div'); bub.className='bubble bubble-assistant';
      bub.innerHTML=`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      typingRow.appendChild(ava); typingRow.appendChild(bub);
      chatBody.appendChild(typingRow); scrollChat();
    }
    function hideTyping(){ if(typingRow){ typingRow.remove(); typingRow=null; } }
    function renderChat(){ chatBody.innerHTML=''; messages.forEach(m=> bubble(m.role, escapeHTML(m.content).replace(/\n/g,'<br/>'))); }
    renderChat();

    /* === Envoi message IA === */
    async function sendMessage(text){
      const content=text.trim(); if(!content) return;
      messages.push({ role:'user', content }); localStorage.setItem('pf_chat', JSON.stringify(messages));
      bubble('user', escapeHTML(content).replace(/\n/g,'<br/>'));
      composer.value=''; statusEl.textContent='Rédaction…';
      try{
        showTyping();
        const resp = await fetch('/api/chat', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: content, proposalSpec: spec, history: messages.slice(-10) })
        });
        const data = await resp.json();
        hideTyping();
        const reply = data.reply || (getLang()==='en'?'I could not structure the proposal.':'Je n’ai pas pu structurer la proposition.');
        messages.push({ role:'assistant', content: reply }); localStorage.setItem('pf_chat', JSON.stringify(messages));
        bubble('assistant', escapeHTML(reply).replace(/\n/g,'<br/>'));
        if(data.proposalSpec){
          spec = data.proposalSpec;
          localStorage.setItem('pf_proposal', JSON.stringify(spec));
          renderSpec();
        }
        saveHistory(spec?.meta?.title || 'Proposition', spec, messages);
        statusEl.textContent='Prêt';
      }catch(e){
        hideTyping(); statusEl.textContent='Erreur réseau';
        bubble('assistant', '<em>Erreur réseau. Réessayez.</em>');
      }
    }
    composer.addEventListener('keydown', (e)=>{
      if(e.isComposing || e.keyCode===229) return;
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(composer.value); }
    });
    sendBtn.onclick = ()=> sendMessage(composer.value);

    /* Upload logo */
    const logoInput = document.getElementById('logoInput');
    logoInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const url = reader.result;
        spec.meta = { ...(spec.meta||{}), style:{ ...(spec.meta?.style||{}), logoDataUrl: url } };
        localStorage.setItem('pf_proposal', JSON.stringify(spec));
        renderSpec();
        toast('Logo mis à jour');
      };
      reader.readAsDataURL(file);
      e.target.value='';
    });

    /* Libellés */
    const t = {
      fr:{ title:"Proposition commerciale", to:"Pour", from:"Émis par", date:"Date", letter:"Lettre d’introduction", executive:"Résumé exécutif", objectives:"Objectifs", approach:"Approche & phasage", deliverables:"Livrables", in_scope:"Inclus", out_scope:"Hors-périmètre", timeline:"Planning", pricing:"Tarification", assumptions:"Hypothèses / Risques", next:"Prochaines étapes", price_model:"Modèle", terms:"Conditions", toc:"Sommaire" },
      en:{ title:"Business Proposal", to:"To", from:"Issued by", date:"Date", letter:"Cover Letter", executive:"Executive Summary", objectives:"Objectives", approach:"Approach & Phasing", deliverables:"Deliverables", in_scope:"In scope", out_scope:"Out of scope", timeline:"Timeline", pricing:"Pricing", assumptions:"Assumptions / Risks", next:"Next Steps", price_model:"Model", terms:"Terms", toc:"Table of Contents" }
    };

    function safeArr(v){ return Array.isArray(v)?v:[]; }
    function safeStr(v,fb=''){ return (v==null?'':String(v)).trim() || fb; }
    function fmtDate(d){ try{ const dt=d?new Date(d):new Date(); return dt.toLocaleDateString(document.documentElement.lang||getLang(), {year:'numeric',month:'short',day:'2-digit'});}catch{return ''} }
    function money(n,c){ try{ return new Intl.NumberFormat(document.documentElement.lang||getLang(),{style:'currency',currency:c||'EUR'}).format(Number(n||0)); }catch{ return String(n||0)+' '+(c||'€') } }

    /* === THEME === */
    function applyStyleTokens(style){
      const palette = {
        primary: "#3B82F6", secondary: "#8B5CF6", surface: "#FFFFFF",
        ink: "#0A1020", muted: "#5C667A", stroke: "#E0E6F4",
        accentA: "#60A5FA", accentB: "#93C5FD",
        ...(style?.palette||{})
      };
      const shapes = { radius:"12px", shadow:"0 18px 48px rgba(10,16,32,.12)", ...(style?.shapes||{}) };
      const typo   = { heading:"Inter", body:"Inter", accent:"Inter", ...(style?.typography||{}) };

      sheet.style.setProperty('--panel', palette.surface);
      sheet.style.setProperty('--ink', palette.ink);
      sheet.style.setProperty('--muted', palette.muted);
      sheet.style.setProperty('--stroke', palette.stroke);
      sheet.style.setProperty('--accent', palette.primary);
      sheet.style.setProperty('--accent2', palette.secondary);
      sheet.style.setProperty('--elev', shapes.shadow);
      sheet.style.setProperty('--radius', shapes.radius);
      sheet.style.setProperty('--font-body', typo.body);
      sheet.style.setProperty('--font-heading', typo.heading);

      renderDecorLayers(style?.decor_layers||[], palette);
    }

    function hsla(h,s,l,a){ return `hsla(${Number(h||0)},${Number(s||0)}%,${Number(l||0)}%,${Number(a||1)})`; }
    function pickCorner(pos){
      const map = {
        top: {top:'-15vh', left:'50%', transform:'translateX(-50%)'},
        bottom: {bottom:'-15vh', left:'50%', transform:'translateX(-50%)'},
        left: {left:'-15vw', top:'50%', transform:'translateY(-50%)'},
        right:{right:'-15vw', top:'50%', transform:'translateY(-50%)'},
        center:{top:'50%', left:'50%', transform:'translate(-50%,-50%)'}
      };
      return map[pos] || map.center;
    }
    function renderDecorLayers(layers, palette){
      decor.innerHTML = '';
      if(!layers?.length) return;
      layers.forEach((L,i)=>{
        const layer = document.createElement('div');
        layer.style.position='absolute';
        layer.style.pointerEvents='none';
        layer.style.mixBlendMode = (L.blend||'normal');
        const pos = pickCorner(L.position);
        Object.assign(layer.style, pos);
        const rot = Number(L.rotate||0);
        const scale = Math.max(0.25, Number(L.scale||1));
        const color = hsla(L.h ?? 220, L.s ?? 60, L.l ?? 55, L.opacity ?? 0.18);

        switch((L.type||'').toLowerCase()){
          case 'glow': {
            const size = 900*scale;
            layer.style.width = layer.style.height = size+'px';
            layer.style.borderRadius='50%';
            layer.style.filter='blur(48px)';
            layer.style.background = `radial-gradient(closest-side, ${color} 0%, transparent 70%)`;
            layer.style.transform = (pos.transform?pos.transform+' ':'') + `rotate(${rot}deg)`;
            break;
          }
          case 'gradient_blob': {
            const w = 1000*scale, h = 700*scale;
            layer.style.width = w+'px'; layer.style.height = h+'px';
            layer.style.borderRadius='40%';
            layer.style.filter='blur(24px)';
            layer.style.background = `conic-gradient(from 180deg, ${color}, transparent 60%)`;
            layer.style.transform = (pos.transform?pos.transform+' ':'') + `rotate(${rot}deg)`;
            break;
          }
          case 'diagonal': {
            const size = 1600*scale;
            layer.style.width = size+'px'; layer.style.height = size+'px';
            layer.style.background = `
              repeating-linear-gradient(${rot}deg,
                ${color} 0px, ${color} 4px,
                transparent 4px, transparent 22px)`;
            break;
          }
          case 'grid': {
            const size = 1400*scale;
            layer.style.width = size+'px'; layer.style.height = size+'px';
            const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svg.setAttribute('viewBox','0 0 100 100'); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
            const defs = document.createElementNS(svg.namespaceURI,'defs');
            const pat = document.createElementNS(svg.namespaceURI,'pattern');
            pat.setAttribute('id',`p-${i}`); pat.setAttribute('width','10'); pat.setAttribute('height','10'); pat.setAttribute('patternUnits','userSpaceOnUse');
            const path = document.createElementNS(svg.namespaceURI,'path');
            path.setAttribute('d','M10 0 L0 0 0 10');
            path.setAttribute('fill','none'); path.setAttribute('stroke', color); path.setAttribute('stroke-width','0.4');
            pat.appendChild(path); defs.appendChild(pat); svg.appendChild(defs);
            const rect = document.createElementNS(svg.namespaceURI,'rect');
            rect.setAttribute('width','100%'); rect.setAttribute('height','100%'); rect.setAttribute('fill',`url(#p-${i})`);
            svg.appendChild(rect);
            layer.appendChild(svg);
            layer.style.transform = (pos.transform?pos.transform+' ':'') + `rotate(${rot}deg)`;
            break;
          }
          case 'dots': {
            const size = 1400*scale;
            layer.style.width = size+'px'; layer.style.height = size+'px';
            const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svg.setAttribute('viewBox','0 0 100 100'); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
            const defs = document.createElementNS(svg.namespaceURI,'defs');
            const pat = document.createElementNS(svg.namespaceURI,'pattern');
            pat.setAttribute('id',`d-${i}`); pat.setAttribute('width','6'); pat.setAttribute('height','6'); pat.setAttribute('patternUnits','userSpaceOnUse');
            const circle = document.createElementNS(svg.namespaceURI,'circle');
            circle.setAttribute('cx','1.5'); circle.setAttribute('cy','1.5'); circle.setAttribute('r','0.6'); circle.setAttribute('fill', color);
            pat.appendChild(circle); defs.appendChild(pat); svg.appendChild(defs);
            const rect = document.createElementNS(svg.namespaceURI,'rect');
            rect.setAttribute('width','100%'); rect.setAttribute('height','100%'); rect.setAttribute('fill',`url(#d-${i})`);
            svg.appendChild(rect);
            layer.appendChild(svg);
            layer.style.transform = (pos.transform?pos.transform+' ':'') + `rotate(${rot}deg)`;
            break;
          }
          default: {
            const size = 1000*scale;
            layer.style.width = layer.style.height = size+'px';
            layer.style.borderRadius='50%';
            layer.style.filter='blur(40px)';
            layer.style.background = `radial-gradient(closest-side, ${color} 0%, transparent 70%)`;
            layer.style.transform = (pos.transform?pos.transform+' ':'') + `rotate(${rot}deg)`;
          }
        }
        decor.appendChild(layer);
      });
    }

    /* Pages API */
    const sheetPages = [];
    function clearPages(){ sheetContent.innerHTML=''; sheetPages.length=0; }
    function makePage(kind='default'){
      const page = document.createElement('div'); page.className='page'; page.dataset.kind=kind;
      const pageDecor = document.createElement('div'); pageDecor.className='page-decor';
      const inner = document.createElement('div'); inner.className='inner';
      page.appendChild(pageDecor); page.appendChild(inner);
      sheetContent.appendChild(page); sheetPages.push({page, inner, pageDecor});
      return {page, inner, pageDecor};
    }
    function H1(inner, text, path){ const el=document.createElement('div'); el.className='h1'; el.textContent=text; bindEditable(el, path); inner.appendChild(el); }
    function H2(inner, text){ const el=document.createElement('div'); el.className='h2'; el.textContent=text; inner.appendChild(el); }
    function HR(inner){ inner.appendChild(Object.assign(document.createElement('div'),{className:'hr'})); }
    function P(inner, text, path){ const p=document.createElement('p'); p.textContent=text; if(path) bindEditable(p, path); inner.appendChild(p); }
    function LI(ul,text,path){ const li=document.createElement('li'); li.textContent=text; if(path) bindEditable(li,path); ul.appendChild(li); }
    function UL(inner, arr, basePath){ if(!arr?.length) return; const ul=document.createElement('ul'); arr.forEach((x,i)=> LI(ul,x, basePath?`${basePath}.${i}`:null)); inner.appendChild(ul); }

    /* Cover */
    function pageAccentBar(pageDecor, colorA, colorB){
      const band = document.createElement('div');
      band.style.position='absolute'; band.style.inset='-10% -10% auto -10%'; band.style.height='40%';
      band.style.background = `linear-gradient(135deg, ${colorA}, ${colorB})`;
      band.style.opacity = .25; band.style.transform = 'skewY(-8deg)';
      pageDecor.appendChild(band);
    }
    function renderCover(style, L, title, company, client, date){
      const { inner, pageDecor } = makePage('cover');
      const pA = getComputedStyle(sheet).getPropertyValue('--accent').trim() || '#3B82F6';
      const pB = getComputedStyle(sheet).getPropertyValue('--accent2').trim() || '#8B5CF6';
      pageAccentBar(pageDecor, pA, pB);

      const head=document.createElement('div'); head.className='doc-header';
      const logoBox=document.createElement('div'); logoBox.className='logo-box';
      if(style?.logoDataUrl){ const im=new Image(); im.src=style.logoDataUrl; logoBox.appendChild(im); } else { logoBox.textContent='LOGO'; logoBox.style.color='#9aa6bf'; }
      const bi=document.createElement('div'); bi.className='brand-info';
      const compDiv=document.createElement('div'); compDiv.className='company'; compDiv.textContent=company; bindEditable(compDiv,'meta.company');
      const dateDiv=document.createElement('div'); dateDiv.className='muted'; dateDiv.textContent=date; bindEditable(dateDiv,'meta.date');
      bi.appendChild(compDiv); bi.appendChild(dateDiv);
      head.appendChild(logoBox); head.appendChild(bi);
      inner.appendChild(head);

      H1(inner, title, 'meta.title');
      const meta=document.createElement('div');
      meta.className='meta';
      meta.innerHTML = `${L.to}: <span class="tag" id="clientTag">${client}</span> &nbsp;•&nbsp; ${L.from}: <span class="tag">${company}</span>`;
      inner.appendChild(meta);
      // tag client editable (click)
      meta.querySelector('#clientTag').classList.add('editable');
      meta.querySelector('#clientTag').setAttribute('contenteditable','true');
      meta.querySelector('#clientTag').addEventListener('blur', (e)=>{ setByPath(spec,'meta.client', e.target.textContent.trim()); persistAndRender(); });

      const band=document.createElement('div'); band.className='band';
      band.textContent = (L===t.fr) ? "Aperçu généré automatiquement selon votre brief." : "Preview auto-generated from your brief.";
      inner.appendChild(band);
    }

    function renderTOC(L, sections){
      const present = sections.filter(s=>s.present);
      if(present.length<3) return;
      const { inner } = makePage('toc');
      H2(inner, L.toc);
      const toc=document.createElement('div'); toc.className='toc';
      toc.innerHTML = `<b>${L.toc}</b>`;
      present.forEach(s=>{ const a=document.createElement('a'); a.textContent=s.title; a.href='#'+s.id; toc.appendChild(a); });
      inner.appendChild(toc);
    }

    function renderLetter(L, letter){
      const { inner } = makePage('letter');
      H2(inner, L.letter);
      if(letter?.greeting) P(inner, letter.greeting, 'letter.greeting');
      safeArr(letter?.body_paragraphs?.length?letter.body_paragraphs:letter?.paragraphs).forEach((p,i)=>P(inner, p, `letter.body_paragraphs.${i}`));
      if(letter?.closing) P(inner, letter.closing, 'letter.closing');
      if(letter?.signature) P(inner, letter.signature, 'letter.signature');
    }

    function renderExecutive(L, exec){
      const { inner } = makePage('executive');
      H2(inner, L.executive);
      safeArr(exec?.paragraphs).forEach((p,i)=>P(inner, p, `executive_summary.paragraphs.${i}`));
    }

    function renderObjectives(L, obj){
      const { inner } = makePage('objectives');
      H2(inner, L.objectives);
      const arr=obj?.bullets||[];
      if(arr.length){ const ul=document.createElement('ul'); arr.forEach((x,i)=> LI(ul,x, `objectives.bullets.${i}`)); inner.appendChild(ul); }
    }

    function renderApproach(L, approach){
      const { inner } = makePage('approach');
      H2(inner, L.approach);
      safeArr(approach?.phases).forEach((ph,i)=>{
        const card=document.createElement('div'); card.className='card';
        const titleEl=document.createElement('div'); titleEl.innerHTML=`<strong>Phase ${i+1} — <span id="ph_t_${i}">${safeStr(ph.title,'À confirmer')}</span></strong>`;
        bindEditable(titleEl.querySelector('span'), `approach.phases.${i}.title`);
        const dur = document.createElement('span'); dur.className='pill'; dur.id=`ph_d_${i}`; dur.textContent=safeStr(ph.duration||'','');
        bindEditable(dur, `approach.phases.${i}.duration`);
        const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
        head.appendChild(titleEl); head.appendChild(dur); card.appendChild(head);
        const acts=safeArr(ph.activities?.length?ph.activities:ph.steps);
        if(acts.length){ const p=document.createElement('p'); p.innerHTML='<em>Activités :</em>'; card.appendChild(p); const ul=document.createElement('ul'); acts.forEach((x,j)=> LI(ul,x, `approach.phases.${i}.activities.${j}`)); card.appendChild(ul); }
        const outs=safeArr(ph.outcomes); if(outs.length){ const p=document.createElement('p'); p.innerHTML='<em>Résultats attendus :</em>'; card.appendChild(p); const ul=document.createElement('ul'); outs.forEach((x,j)=> LI(ul,x, `approach.phases.${i}.outcomes.${j}`)); card.appendChild(ul); }
        inner.appendChild(card);
      });
    }

    function renderDeliverables(L, deliv){
      const { inner } = makePage('deliverables');
      H2(inner, L.deliverables);
      const grid=document.createElement('div'); grid.className='grid2';
      const a=document.createElement('div'); a.className='card'; a.innerHTML=`<div class="muted" style="margin-bottom:6px">${L.in_scope}</div>`;
      const b=document.createElement('div'); b.className='card'; b.innerHTML=`<div class="muted" style="margin-bottom:6px">${L.out_scope}</div>`;
      const ulA=document.createElement('ul'); safeArr(deliv?.in).forEach((x,i)=> LI(ulA,x, `deliverables.in.${i}`));
      const ulB=document.createElement('ul'); safeArr(deliv?.out).forEach((x,i)=> LI(ulB,x, `deliverables.out.${i}`));
      a.appendChild(ulA); b.appendChild(ulB); grid.appendChild(a); grid.appendChild(b); inner.appendChild(grid);
    }

    function renderTimeline(L, timeline){
      const { inner } = makePage('timeline');
      H2(inner, L.timeline);
      const grid=document.createElement('div'); grid.className='grid2';
      safeArr(timeline?.milestones).forEach((ms,i)=>{
        const c=document.createElement('div'); c.className='card';
        const tEl=document.createElement('div'); tEl.innerHTML = `<strong id="ms_t_${i}">${safeStr(ms.title,'Étape')}</strong>`;
        bindEditable(tEl, `timeline.milestones.${i}.title`);
        const dEl=document.createElement('div'); dEl.className='muted'; dEl.id=`ms_d_${i}`; dEl.textContent=safeStr(ms.dateOrWeek || ms.date || ms.duration || '', '');
        bindEditable(dEl, `timeline.milestones.${i}.dateOrWeek`);
        c.appendChild(tEl); c.appendChild(dEl);
        if(ms.notes){ const p=document.createElement('p'); p.textContent=ms.notes; bindEditable(p, `timeline.milestones.${i}.notes`); c.appendChild(p); }
        grid.appendChild(c);
      });
      inner.appendChild(grid);
    }

    function renderPricing(L, pr, currencyFallback){
      const { inner } = makePage('pricing');
      H2(inner, L.pricing);
      const currency=pr?.currency||currencyFallback||'EUR';
      const meta=document.createElement('div'); meta.className='muted'; meta.style.margin='-6px 0 8px';
      meta.innerHTML = `${L.price_model}: <span class="pill" id="priceModel">${safeStr(pr?.model,'forfait')}</span>`;
      bindEditable(meta.querySelector('#priceModel'), 'pricing.model');
      inner.appendChild(meta);

      if(Array.isArray(pr?.items) && pr.items.length){
        const table=document.createElement('table');
        table.innerHTML=`<thead><tr><th>Item</th><th>Qté</th><th>Unité</th><th>PU</th><th>Sous-total</th></tr></thead><tbody></tbody><tfoot>
          <tr><td colspan="4" style="text-align:right">Sous-total</td><td id="ft_subtotal"></td></tr>
          <tr><td colspan="4" style="text-align:right">Taxes</td><td id="ft_tax"></td></tr>
          <tr><td colspan="4" style="text-align:right">Total</td><td id="ft_total"></td></tr></tfoot>`;
        const tb=table.querySelector('tbody');
        pr.items.forEach((it,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td id="it_n_${i}">${safeStr(it.name,'—')}</td>
                        <td id="it_q_${i}">${Number(it.qty||1)}</td>
                        <td id="it_u_${i}">${safeStr(it.unit||'—')}</td>
                        <td id="it_p_${i}">${money(Number(it.unit_price||0),currency)}</td>
                        <td id="it_s_${i}">${money((it.subtotal!=null)?Number(it.subtotal):Number(it.qty||1)*Number(it.unit_price||0),currency)}</td>`;
          tb.appendChild(tr);
          bindEditable(tr.querySelector(`#it_n_${i}`), `pricing.items.${i}.name`);
          bindEditable(tr.querySelector(`#it_q_${i}`), `pricing.items.${i}.qty`, { type:'number' });
          bindEditable(tr.querySelector(`#it_u_${i}`), `pricing.items.${i}.unit`);
          // prix: au blur, parse monnaie
          const pCell = tr.querySelector(`#it_p_${i}`);
          pCell.classList.add('editable'); pCell.setAttribute('contenteditable','true');
          pCell.addEventListener('blur', (e)=>{ const v=parseFloat((e.target.textContent||'').replace(/[^\d.,-]/g,'').replace(',','.'))||0; setByPath(spec, `pricing.items.${i}.unit_price`, v); persistAndRender(); });
        });
        inner.appendChild(table);
        // Totaux
        const subtotal = (pr.items||[]).reduce((s,it)=> s + ((it.subtotal!=null)?Number(it.subtotal):Number(it.qty||1)*Number(it.unit_price||0)), 0);
        const taxRate=Number(pr.tax_rate||0); const taxes=subtotal*(taxRate/100); const total=subtotal+taxes;
        table.querySelector('#ft_subtotal').textContent=money(subtotal,currency);
        table.querySelector('#ft_tax').textContent=`${money(taxes,currency)} ${taxRate?`(${taxRate}%)`:''}`;
        table.querySelector('#ft_total').textContent=money(total,currency);
        if((pr.terms||[]).length){
          const terms=document.createElement('div'); terms.className='card'; terms.style.marginTop='8px';
          terms.innerHTML=`<div class="muted" style="margin-bottom:6px">${L.terms}</div><ul>${(pr.terms||[]).map((x,i)=>`<li class="editable" contenteditable data-path="pricing.terms.${i}">${x}</li>`).join('')}</ul>`;
          inner.appendChild(terms);
          terms.querySelectorAll('[data-path]').forEach(el=> bindEditable(el, el.getAttribute('data-path')));
        }
      }else{
        const priceBox=document.createElement('div'); priceBox.className='card';
        const price=pr?.price!=null?String(pr.price):'—';
        const pVal=document.createElement('div'); pVal.className='price'; pVal.id='p_val'; pVal.textContent=money(price,currency);
        bindEditable(pVal, 'pricing.price', { type:'number' });
        priceBox.appendChild(pVal);
        const meta2=document.createElement('div'); meta2.className='muted'; meta2.style.marginTop='4px';
        meta2.innerHTML=`${L.price_model}: <span id="pm2">${safeStr(pr?.model,'forfait')}</span>`;
        bindEditable(meta2.querySelector('#pm2'),'pricing.model');
        priceBox.appendChild(meta2);
        inner.appendChild(priceBox);
      }
    }

    function renderAssumptions(L, asmp){
      const { inner } = makePage('assumptions');
      H2(inner, L.assumptions);
      safeArr(asmp?.paragraphs).forEach((p,i)=>P(inner, p, `assumptions.paragraphs.${i}`));
    }
    function renderNext(L, next){
      const { inner } = makePage('next');
      H2(inner, L.next);
      safeArr(next?.paragraphs).forEach((p,i)=>P(inner, p, `next_steps.paragraphs.${i}`));
    }

    function buildTOCList(L){
      return [
        { id:'s_letter', title:L.letter, present: safeArr(spec.letter?.body_paragraphs||spec.letter?.paragraphs).length || spec.letter?.greeting||spec.letter?.closing||spec.letter?.signature },
        { id:'s_executive', title:L.executive, present: safeArr(spec.executive_summary?.paragraphs).length },
        { id:'s_objectives', title:L.objectives, present: safeArr(spec.objectives?.bullets).length },
        { id:'s_approach', title:L.approach, present: safeArr(spec.approach?.phases).length },
        { id:'s_deliverables', title:L.deliverables, present: (spec.deliverables && (safeArr(spec.deliverables.in).length || safeArr(spec.deliverables.out).length)) },
        { id:'s_timeline', title:L.timeline, present: safeArr(spec.timeline?.milestones).length },
        { id:'s_pricing', title:L.pricing, present: (spec.pricing && (spec.pricing.items?.length || spec.pricing.price!=null)) },
        { id:'s_assumptions', title:L.assumptions, present: safeArr(spec.assumptions?.paragraphs).length },
        { id:'s_next', title:L.next, present: safeArr(spec.next_steps?.paragraphs).length },
      ];
    }

    function renderSpec(){
      applyStyleTokens(spec?.meta?.style || null);
      clearPages();
      const L=t[spec.meta?.lang||getLang()]||t.fr;
      const title=safeStr(spec.meta?.title, L.title);
      const company=safeStr(spec.meta?.company || spec.meta?.brand?.company,'Votre société');
      const client=safeStr(spec.meta?.client,'Client');
      const date=safeStr(spec.meta?.date, fmtDate());
      renderCover(spec?.meta?.style, L, title, company, client, date);
      const tocList = buildTOCList(L);
      renderTOC(L, tocList);
      if (tocList[0].present) renderLetter(L, spec.letter);
      if (tocList[1].present) renderExecutive(L, spec.executive_summary);
      if (tocList[2].present) renderObjectives(L, spec.objectives);
      if (tocList[3].present) renderApproach(L, spec.approach);
      if (tocList[4].present) renderDeliverables(L, spec.deliverables);
      if (tocList[5].present) renderTimeline(L, spec.timeline);
      if (tocList[6].present) renderPricing(L, spec.pricing, spec.meta?.currency);
      if (tocList[7].present) renderAssumptions(L, spec.assumptions);
      if (tocList[8].present) renderNext(L, spec.next_steps);
      hint.style.display='flex';
    }
    renderSpec();

    /* Lang */
    function applyChatLang(){
      const en=(getLang()==='en');
      document.getElementById('composer').placeholder = en?'Type your message':'Écrivez votre message';
    }
    applyChatLang();
    window.addEventListener('langchange', ()=>{
      spec.meta = { ...(spec.meta||{}), lang:getLang() };
      localStorage.setItem('pf_proposal', JSON.stringify(spec));
      applyChatLang();
      renderSpec();
    });

    /* Relance auto */
    if(messages.length && messages[messages.length-1].role==='user' && !chatBody.querySelector('.bubble-assistant')){
      sendMessage(messages[messages.length-1].content);
    }

    /* ========= Editable bindings ========= */
    function setByPath(obj, path, value){
      const parts = path.split('.');
      let cur = obj;
      for(let i=0;i<parts.length-1;i++){
        const k = parts[i];
        if(!(k in cur) || typeof cur[k] !== 'object'){ cur[k] = isFinite(Number(parts[i+1])) ? [] : {}; }
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = value;
    }
    function persistAndRender(){
      localStorage.setItem('pf_proposal', JSON.stringify(spec));
      renderSpec();
      statusEl.textContent='Modifié';
      setTimeout(()=> statusEl.textContent='Prêt', 800);
    }
    function bindEditable(el, path, opts={}){
      if(!el) return;
      el.classList.add('editable'); el.setAttribute('contenteditable','true'); el.dataset.path=path;
      el.addEventListener('blur', (e)=>{
        let v = e.target.textContent || '';
        if(opts.type==='number'){ v = parseFloat(v.replace(/[^\d.,-]/g,'').replace(',','.'))||0; }
        setByPath(spec, path, v);
        persistAndRender();
      });
      // IA shortcut (Cmd/Ctrl+K)
      el.addEventListener('keydown', async (e)=>{
        if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){
          e.preventDefault();
          const selection = window.getSelection?.().toString() || el.textContent;
          if(!selection) return;
          const choice = prompt('IA: "corrige", "plus concis", "plus vendeur", "plus formel", "traduire en EN/FR"\nEntrez votre instruction :', 'corrige');
          if(!choice) return;
          try{
            const msg = `Réécris ce texte selon l’instruction: "${choice}". Retourne uniquement le texte final, sans balises ni explications.\nTexte:\n"""${selection}"""`;
            const resp = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: msg, proposalSpec: spec, history: [] }) });
            const data = await resp.json();
            const newText = (data?.reply||'').trim();
            if(newText){
              // Remplace la sélection ou l’entier
              if(window.getSelection && window.getSelection().rangeCount){
                const range = window.getSelection().getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(newText));
              }else{
                el.textContent = newText;
              }
              // persiste
              setByPath(spec, path, el.textContent);
              persistAndRender();
              toast('Texte réécrit ✨');
            }
          }catch(err){ toast('IA indisponible'); }
        }
      });
    }

    /* ========== Designer panel ========== */
    const openDesigner=document.getElementById('openDesigner');
    const closeDesigner=document.getElementById('closeDesigner');
    const designerPanel=document.getElementById('designerPanel');
    openDesigner.onclick = ()=>{ syncDesignerFields(); designerPanel.style.display='block'; };
    closeDesigner.onclick = ()=>{ designerPanel.style.display='none'; };

    function hex(v){ return /^#/.test(v)?v:('#'+v); }
    function setPaletteKey(key, val){
      spec.meta = spec.meta||{}; spec.meta.style = spec.meta.style||{}; spec.meta.style.palette = spec.meta.style.palette||{};
      spec.meta.style.palette[key] = val;
      persistAndRender();
    }
    function syncDesignerFields(){
      const p = ((spec.meta||{}).style||{}).palette||{};
      const typo=((spec.meta||{}).style||{}).typography||{};
      const radius= parseInt((((spec.meta||{}).style||{}).shapes||{}).radius||'12')||12;
      const pick = (id, val)=>{ const el=document.getElementById(id); if(el){ if(el.type==='color'){ try{ el.value = hex(val||'#ffffff'); }catch{ el.value='#ffffff'; } } else { el.value=val||''; } } };
      pick('cPrimary', p.primary||'#3B82F6'); pick('tPrimary', p.primary||'#3B82F6');
      pick('cSecondary', p.secondary||'#8B5CF6'); pick('tSecondary', p.secondary||'#8B5CF6');
      pick('cSurface', p.surface||'#FFFFFF'); pick('tSurface', p.surface||'#FFFFFF');
      pick('cInk', p.ink||'#0A1020'); pick('tInk', p.ink||'#0A1020');
      pick('cMuted', p.muted||'#5C667A'); pick('tMuted', p.muted||'#5C667A');
      pick('cStroke', p.stroke||'#E0E6F4'); pick('tStroke', p.stroke||'#E0E6F4');
      document.getElementById('sHeading').value = (typo.heading||'Inter');
      document.getElementById('sBody').value = (typo.body||'Inter');
      document.getElementById('nRadius').value = radius;
      document.getElementById('sDecor').value = (((spec.meta||{}).style||{}).decor_layers||[])[0]?.type || 'none';
    }
    // Bind inputs → spec
    const map = [
      ['cPrimary','tPrimary','primary'],
      ['cSecondary','tSecondary','secondary'],
      ['cSurface','tSurface','surface'],
      ['cInk','tInk','ink'],
      ['cMuted','tMuted','muted'],
      ['cStroke','tStroke','stroke'],
    ];
    map.forEach(([cid,tid,key])=>{
      const c=document.getElementById(cid), t=document.getElementById(tid);
      c.addEventListener('input', ()=>{ t.value=c.value; setPaletteKey(key,c.value); });
      t.addEventListener('change', ()=>{ setPaletteKey(key, t.value); });
    });
    document.getElementById('sHeading').addEventListener('change', (e)=>{
      spec.meta=spec.meta||{}; spec.meta.style=spec.meta.style||{}; spec.meta.style.typography = { ...(spec.meta.style.typography||{}), heading:e.target.value };
      persistAndRender();
    });
    document.getElementById('sBody').addEventListener('change', (e)=>{
      spec.meta=spec.meta||{}; spec.meta.style=spec.meta.style||{}; spec.meta.style.typography = { ...(spec.meta.style.typography||{}), body:e.target.value };
      persistAndRender();
    });
    document.getElementById('nRadius').addEventListener('change',(e)=>{
      const px = `${Math.max(4, Math.min(28, parseInt(e.target.value)||12))}px`;
      spec.meta=spec.meta||{}; spec.meta.style=spec.meta.style||{}; spec.meta.style.shapes = { ...(spec.meta.style.shapes||{}), radius:px };
      persistAndRender();
    });
    document.getElementById('sDecor').addEventListener('change',(e)=>{
      const v=e.target.value;
      if(v==='none'){ spec.meta.style.decor_layers=[]; persistAndRender(); return; }
      spec.meta.style.decor_layers = [{ type:v, position:'top', opacity:0.12, h:220, s:60, l:55, rotate: (v==='diagonal'?-18:0), scale:1, blend:(v==='glow'?'screen':'normal') }];
      persistAndRender();
    });

    /* i18n chat placeholders */
    function applyChatLangUI(){
      const en=(getLang()==='en');
      document.getElementById('composer').placeholder = en?'Type your message':'Écrivez votre message';
    }
    applyChatLangUI();
  </script>
</body>
</html>
