<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Palette & rayons – valeurs par défaut (écrasées par designSpec) */
      --palette-primary:#3b82f6;
      --palette-secondary:#8b5cf6;
      --palette-surface:#ffffff;
      --palette-ink:#0a1020;
      --palette-muted:#5c667a;
      --palette-stroke:#e0e6f4;

      --radius-panel:16px;
      --radius-bubble:14px;
      --radius-card:12px;

      /* Dérivées (ne pas toucher) */
      --bg:#f6f8fc;
      --panel:var(--palette-surface);
      --ink:var(--palette-ink);
      --muted:var(--palette-muted);
      --stroke:var(--palette-stroke);
      --accent:var(--palette-primary);
      --accent2:var(--palette-secondary);
      --elev:0 18px 48px rgba(10,16,32,.10), inset 0 1px 0 #ffffffaa;

      /* Chat themes */
      --assistant-bubble: color-mix(in hsl, var(--panel) 86%, transparent);
      --user-bubble: linear-gradient(135deg, var(--accent), var(--accent2));
      --user-ink: #ffffff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      height:100vh;
      overflow:hidden; /* pas de scroll de page */
      background:linear-gradient(180deg,var(--bg),#eef3ff);
      font-family:Inter,system-ui,sans-serif;color:var(--ink)
    }

    /* Top bar */
    .bar{
      position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--stroke);
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px;box-shadow:var(--elev)
    }
    .left,.right{display:flex;gap:10px;align-items:center}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;cursor:pointer}
    .spark{width:22px;height:22px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .btn{border:1px solid var(--stroke);background:var(--panel);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:var(--elev)}
    .sel{border:1px solid var(--stroke);border-radius:10px;padding:7px 10px;background:var(--panel);color:var(--ink)}
    .avatar{width:32px;height:32px;border-radius:50%;border:1px solid var(--stroke);display:grid;place-items:center;font-weight:800;background:var(--panel);cursor:pointer;box-shadow:var(--elev)}
    .menu{position:absolute;top:54px;right:14px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;box-shadow:var(--elev);display:none;overflow:hidden}
    .menu a,.menu button{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:var(--panel);cursor:pointer;font-weight:600;color:var(--ink)}
    .menu a:hover,.menu button:hover{background:color-mix(in hsl, var(--panel) 80%, transparent)}

    /* Layout principal : chat élargi & éléments étirés */
    .main{
      height:calc(100vh - 64px);
      display:grid;
      grid-template-columns: clamp(520px, 38vw, 640px) 1fr; /* chat élargi */
      gap:18px;
      padding:18px 24px;
      align-items:stretch;
      min-height:0;
    }
    .panel{
      background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius-panel);box-shadow:var(--elev);
      display:flex;flex-direction:column;
      min-height:0;
    }

    /* Chat */
    .chat{min-height:0; display:flex;flex-direction:column;}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke)}
    .chat-title{font-weight:800}
    .chat-body{
      padding:12px;
      overflow:auto; /* scroll interne chat */
      flex:1; min-height:0;
    }

    /* Lignes de message + avatars + bulles */
    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
      align-items:flex-end;
      width:100%;
    }
    .msg.assistant{justify-content:flex-start}
    .msg.user{justify-content:flex-end}

    .avatar-badge{
      width:34px;height:34px;border-radius:50%;
      display:grid;place-items:center;
      font-weight:800;font-size:12px;
      border:1.5px solid var(--stroke);
      box-shadow:0 6px 18px rgba(10,16,32,.12), inset 0 1px 0 #ffffff90;
      background:var(--panel); color:var(--ink);
      user-select:none;
    }
    .avatar-badge.bot{
      background:#111827; color:#fff; border-color:#111827
    }
    .avatar-badge.you{
      background:var(--accent); color:#fff; border-color:transparent
    }

    .bubble{
      max-width:min(100%, 560px);
      padding:10px 12px;border-radius:var(--radius-bubble);border:1px solid var(--stroke);
      box-shadow:var(--elev);
      word-wrap:break-word;overflow-wrap:anywhere;
    }
    .bubble-assistant{
      background:var(--assistant-bubble);
      color:var(--ink);
    }
    .bubble-user{
      background:var(--user-bubble);
      color:var(--user-ink);
      border-color:transparent;
    }

    /* Composer avec espace pour le logo */
    .chat-compose{
      position:relative;
      padding:12px;
      border-top:1px solid var(--stroke);
      display:flex;align-items:flex-end;gap:16px;
    }
    .logo-wrap{ position:relative; flex:0 0 auto; margin-right:6px; }
    .input{
      display:flex;gap:8px;align-items:flex-end;background:var(--panel);border:1px solid var(--stroke);
      border-radius:14px;padding:8px;box-shadow:var(--elev);
      flex:1;
    }
    .input textarea{flex:1;resize:vertical;min-height:72px;border:none;outline:none;background:transparent;font:500 14px/1.4 Inter;color:var(--ink)}
    .send{width:40px;height:40px;border-radius:12px;border:1px solid var(--stroke);background:#0a1020;color:#fff;display:grid;place-items:center;cursor:pointer}

    /* Upload/logo bouton + info-bulle */
    .logo-btn{width:34px;height:34px;border-radius:10px;border:1px solid #0002;
      background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd);
      box-shadow:var(--elev);display:grid;place-items:center;cursor:pointer}
    .logo-btn input{display:none}
    .logo-tip{
      position:absolute;left:0;bottom:44px;
      background:#111;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;display:none;white-space:nowrap
    }
    .logo-wrap:hover .logo-tip{display:block}

    /* Indicateur de frappe */
    .typing{display:inline-flex;gap:5px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#8aa0c6;opacity:.7;animation:bounce 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}

    /* Aperçu : centré horizontalement + scroll interne */
    .sheet-wrap{
      position:relative;
      flex:1; min-height:0; overflow:auto;
      display:flex;justify-content:center;align-items:flex-start;
      padding:12px 24px;
    }
    .texture-overlay{
      position:absolute; inset:0;
      pointer-events:none; opacity:.0; transition:opacity .25s ease;
    }
    .sheet{
      width:210mm;
      max-width:100%;
      min-height:297mm;
      background:var(--panel); border:1px solid var(--stroke); box-shadow:var(--elev);
      border-radius:var(--radius-card); padding:22mm 18mm; color:var(--ink)
    }
    .doc-header{display:grid;grid-template-columns:100px 1fr;gap:16px;align-items:center;margin-bottom:16px}
    .logo-box{width:100px;height:100px;border:1px solid var(--stroke);border-radius:12px;display:grid;place-items:center;overflow:hidden;background:var(--panel)}
    .logo-box img{width:100%;height:100%;object-fit:contain}
    .brand-info .company{font-weight:800;font-size:18px}
    .brand-info .muted{color:var(--muted);font-size:12px}
    .toc{border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:color-mix(in hsl, var(--panel) 85%, transparent);margin:10px 0 14px}
    .toc b{display:block;margin-bottom:6px}
    .toc a{display:block;text-decoration:none;color:var(--ink);font-size:13px;margin:4px 0}
    .toc a:hover{text-decoration:underline}
    .h1{font-size:28px;line-height:1.1;margin:0 0 6px;font-weight:800;letter-spacing:-.01em}
    .meta{color:var(--muted);font-size:14px;margin-bottom:18px}
    h2{margin:22px 0 8px;font-size:18px;letter-spacing:.2px}
    .hr{height:1px;background:var(--stroke);margin:12px 0}
    p{margin:8px 0 10px}
    ul{margin:8px 0 10px 18px}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:color-mix(in hsl, var(--accent) 16%, transparent);border:1px solid var(--stroke);font-size:12px;color:var(--ink)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border:1px solid var(--stroke);border-radius:12px;padding:12px;background:var(--panel);box-shadow:var(--elev)}
    .price{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:var(--panel)}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border:1px solid var(--stroke);padding:8px;text-align:left}
    th{background:color-mix(in hsl, var(--panel) 85%, transparent)}
    tfoot td{font-weight:800}

    /* History drawer */
    .drawer{position:fixed;inset:auto 0 0 auto;right:-380px;width:360px;height:100vh;background:var(--panel);border-left:1px solid var(--stroke);box-shadow:var(--elev);transition:transform .25s ease;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(-380px)}
    .drawer h3{margin:0;padding:14px;border-bottom:1px solid var(--stroke)}
    .drawer-list{padding:8px;overflow:auto}
    .row-item{border:1px solid var(--stroke);border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer;background:var(--panel)}
    .row-item:hover{background:color-mix(in hsl, var(--panel) 85%, transparent)}

    @media (max-width:1100px){
      .main{grid-template-columns:1fr}
      .sheet{width:100%;min-height:auto}
    }

    @media print{
      .bar{display:none}
      body{overflow:visible;height:auto;background:#fff}
      .main{height:auto}
      .sheet-wrap{overflow:visible;flex:auto;min-height:auto;padding:0}
      .sheet{box-shadow:none;border:none;border-radius:0;width:auto;min-height:auto;padding:18mm 16mm}
      a[href]:after{content:""}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="lang.js"></script>
</head>
<body>
  <!-- Top bar -->
  <div class="bar">
    <div class="left">
      <div class="brand" id="homeBtn"><div class="spark" aria-hidden="true"></div>PropoFlash</div>
      <button class="btn" id="openHistory">Historique</button>
      <span class="muted" id="status">Prêt</span>
    </div>
    <div class="right">
      <label class="muted">Langue</label>
      <select class="sel" id="langSel" data-lang-picker><option value="fr">FR</option><option value="en">EN</option></select>
      <div class="avatar" id="avatar">U</div>
      <div class="menu" id="menu">
        <a href="studio.html">Studio</a>
        <a href="#history">Historique</a>
        <button id="logoutBtn">Se déconnecter</button>
      </div>
    </div>
  </div>

  <!-- History drawer -->
  <div class="drawer" id="drawer">
    <h3>Historique</h3>
    <div class="drawer-list" id="histList"></div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Chat -->
    <div class="panel chat">
      <div class="chat-head"><strong class="chat-title">Chat</strong></div>
      <div class="chat-body" id="chatBody" aria-live="polite"></div>

      <div class="chat-compose">
        <div class="logo-wrap">
          <label class="logo-btn" title="Ajouter un logo (PNG/JPG/SVG)">
            <input type="file" id="logoInput" accept="image/*,.svg"/>
          </label>
          <div class="logo-tip">Ajouter votre logo</div>
        </div>
        <div class="input">
          <textarea id="composer" placeholder="Écrivez votre message"></textarea>
          <button class="send" id="sendBtn" title="Envoyer" aria-label="Envoyer">
            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="20" height="20"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Aperçu -->
    <div class="panel sheet-wrap">
      <div class="texture-overlay" id="texture"></div>
      <div class="sheet" id="sheet"></div>
    </div>
  </div>

  <script>
    /* Supabase guard */
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    async function guard(){
      const { data:{ session } } = await sb.auth.getSession();
      if(session?.user) return true;
      const tries = parseInt(localStorage.getItem('pf_anon_uses')||'0',10);
      if(tries>=1){ location.href = 'auth.html?return=studio'; return false; }
      localStorage.setItem('pf_anon_uses', String(tries+1));
      return true;
    }
    guard();

    /* Profil menu */
    const avatar=document.getElementById('avatar'), menu=document.getElementById('menu'), logoutBtn=document.getElementById('logoutBtn');
    (async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      avatar.textContent = session?.user ? (session.user.email||'?')[0].toUpperCase() : 'U';
    })();
    avatar.onclick = (e)=>{ e.stopPropagation(); menu.style.display = menu.style.display==='block'?'none':'block'; };
    document.addEventListener('click', ()=> menu.style.display='none');
    logoutBtn.onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

    /* Nav */
    document.getElementById('homeBtn').onclick=()=>location.href='index.html';

    /* Historique */
    const drawer=document.getElementById('drawer'); const histList=document.getElementById('histList');
    document.getElementById('openHistory').onclick = ()=> drawer.classList.toggle('open');
    function saveHistory(title, spec, messages){
      const h=JSON.parse(localStorage.getItem('pf_history')||'[]');
      h.unshift({ id:Date.now(), title, date:new Date().toISOString(), spec, messages });
      localStorage.setItem('pf_history', JSON.stringify(h.slice(0,100)));
      renderHistory();
    }
    function renderHistory(){
      const h=JSON.parse(localStorage.getItem('pf_history')||'[]');
      histList.innerHTML='';
      if(!h.length){ histList.innerHTML='<div class="muted" style="padding:8px">Aucun élément</div>'; return; }
      h.forEach(item=>{
        const d=new Date(item.date);
        const div=document.createElement('div'); div.className='row-item';
        div.innerHTML = `<strong>${item.title||'Sans titre'}</strong><br><span class="muted">${d.toLocaleString()}</span>`;
        div.onclick=()=>{ spec=item.spec; messages=item.messages||[]; localStorage.setItem('pf_proposal', JSON.stringify(spec)); applyDesignFromSpec(spec?.meta?.style?.designSpec||{}); renderSpec(); renderChat(); drawer.classList.remove('open'); };
        histList.appendChild(div);
      });
    }
    renderHistory();

    /* Chat + Spec */
    const chatBody=document.getElementById('chatBody');
    const composer=document.getElementById('composer');
    const sendBtn=document.getElementById('sendBtn');
    const statusEl=document.getElementById('status');
    const sheet=document.getElementById('sheet');
    const textureEl=document.getElementById('texture');

    let messages = JSON.parse(localStorage.getItem('pf_chat')||'[]');
    let spec = null;

    function loadSpec(){
      try{ spec = JSON.parse(localStorage.getItem('pf_proposal')||'null'); }catch{ spec=null; }
      if(!spec){ spec = { meta:{ lang:getLang(), title:(getLang()==='en'?'Business Proposal':'Proposition commerciale'), currency:'EUR' }, sections:[] }; }
      if(!spec.meta) spec.meta = { lang:getLang() };
    }
    loadSpec();

    (function consumeWelcome(){
      const w = localStorage.getItem('pf_welcome_msg');
      if(w){ messages.push({ role:'user', content:w }); localStorage.removeItem('pf_welcome_msg'); }
    })();

    function scrollChat(){ chatBody.scrollTop = chatBody.scrollHeight; }
    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    /* Bulle avec avatars & alignement */
    function bubble(role, html){
      const row=document.createElement('div');
      row.className='msg '+(role==='assistant'?'assistant':'user');

      const ava=document.createElement('div');
      ava.className='avatar-badge '+(role==='assistant'?'bot':'you');
      ava.textContent = (role==='assistant') ? 'PF' : 'ME';

      const bub=document.createElement('div');
      bub.className='bubble '+(role==='assistant'?'bubble-assistant':'bubble-user');
      bub.innerHTML=html;

      if(role==='assistant'){ row.appendChild(ava); row.appendChild(bub); }
      else { row.appendChild(bub); row.appendChild(ava); }

      chatBody.appendChild(row);
      scrollChat();
      return row;
    }

    /* Indicateur de frappe (côté assistant) */
    let typingRow=null;
    function showTyping(){
      if(typingRow) return;
      typingRow = document.createElement('div');
      typingRow.className='msg assistant';
      const ava=document.createElement('div');
      ava.className='avatar-badge bot'; ava.textContent='PF';
      const bub=document.createElement('div');
      bub.className='bubble bubble-assistant';
      bub.innerHTML=`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      typingRow.appendChild(ava); typingRow.appendChild(bub);
      chatBody.appendChild(typingRow);
      scrollChat();
    }
    function hideTyping(){
      if(typingRow){ typingRow.remove(); typingRow=null; }
    }

    function renderChat(){
      chatBody.innerHTML='';
      messages.forEach(m=> bubble(m.role, escapeHTML(m.content).replace(/\n/g,'<br/>')));
    }
    renderChat();

    async function sendMessage(text){
      const content=text.trim(); if(!content) return;
      messages.push({ role:'user', content: content }); localStorage.setItem('pf_chat', JSON.stringify(messages));
      bubble('user', escapeHTML(content).replace(/\n/g,'<br/>'));
      composer.value='';
      statusEl.textContent='Rédaction…';

      try{
        showTyping();

        const resp = await fetch('/api/chat', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: content, proposalSpec: spec, history: messages.slice(-10) })
        });
        const data = await resp.json();

        hideTyping();

        const reply = data.reply || (getLang()==='en'?'I could not structure the proposal.':'Je n’ai pas pu structurer la proposition.');
        messages.push({ role:'assistant', content: reply }); localStorage.setItem('pf_chat', JSON.stringify(messages));
        bubble('assistant', escapeHTML(reply).replace(/\n/g,'<br/>'));

        if(data.proposalSpec){
          // merge shallow pour conserver ce qui existe côté front
          spec = { ...(spec||{}), ...(data.proposalSpec||{}) };
          spec.meta = { ...(spec.meta||{}), ...((data.proposalSpec||{}).meta||{}) };
          localStorage.setItem('pf_proposal', JSON.stringify(spec));
          applyDesignFromSpec(spec?.meta?.style?.designSpec||{});
          renderSpec();
        }
        saveHistory(spec?.meta?.title || 'Proposition', spec, messages);
        statusEl.textContent='Prêt';
      }catch(e){
        hideTyping();
        statusEl.textContent='Erreur réseau';
        bubble('assistant', '<em>Erreur réseau. Réessayez.</em>');
      }
    }

    composer.addEventListener('keydown', (e)=>{
      if(e.isComposing || e.keyCode===229) return;
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(composer.value); }
    });
    sendBtn.onclick = ()=> sendMessage(composer.value);

    /* Upload logo -> spec.meta.style.logoDataUrl */
    const logoInput = document.getElementById('logoInput');
    logoInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const url = reader.result;
        spec.meta = { ...(spec.meta||{}), style:{ ...(spec.meta?.style||{}), logoDataUrl: url } };
        localStorage.setItem('pf_proposal', JSON.stringify(spec));
        renderSpec();
      };
      reader.readAsDataURL(file);
      e.target.value='';
    });

    /* --------- THEME / DESIGN --------- */

    function cssVar(name, value){
      if(value==null) return;
      document.documentElement.style.setProperty(name, String(value));
    }

    function applyDesignFromSpec(d){
      if(!d) return;

      // Palette
      if(d.palette){
        cssVar('--palette-primary',  d.palette.primary);
        cssVar('--palette-secondary',d.palette.secondary);
        cssVar('--palette-surface',  d.palette.surface);
        cssVar('--palette-ink',      d.palette.ink);
        cssVar('--palette-muted',    d.palette.muted);
        cssVar('--palette-stroke',   d.palette.stroke);
      }

      // Rayons
      if(d.radius){
        if(d.radius.panel != null)  cssVar('--radius-panel',  d.radius.panel +'px');
        if(d.radius.bubble!= null)  cssVar('--radius-bubble', d.radius.bubble+'px');
        if(d.radius.card  != null)  cssVar('--radius-card',   d.radius.card  +'px');
      }

      // Texture décor (overlay au-dessus de sheet-wrap)
      const kind = d.texture?.kind || 'none';
      const intensity = Math.max(0, Math.min(1, Number(d.texture?.intensity ?? 0)));
      let css = '', op = 0;
      if(kind === 'mesh'){
        // léger maillage radial + linéaire
        const col = getComputedStyle(document.documentElement).getPropertyValue('--palette-secondary').trim() || '#8b5cf6';
        css = `
          radial-gradient(1200px 800px at 80% 20%, ${col}20, transparent 60%),
          radial-gradient(900px 600px at 20% 80%, ${col}18, transparent 60%)
        `;
        op = 0.18 * intensity * 2;
      } else if(kind === 'blob'){
        const col = getComputedStyle(document.documentElement).getPropertyValue('--palette-primary').trim() || '#3b82f6';
        css = `
          radial-gradient(220px 220px at 20% 30%, ${col}26, transparent 65%),
          radial-gradient(260px 260px at 80% 70%, ${col}22, transparent 60%),
          radial-gradient(180px 180px at 60% 20%, ${col}22, transparent 60%)
        `;
        op = 0.22 * intensity * 2;
      }
      textureEl.style.background = css || 'none';
      textureEl.style.opacity = String(op || 0);
    }

    /* Libellés */
    const t = {
      fr:{ title:"Proposition commerciale", to:"Pour", from:"Émis par", date:"Date", letter:"Lettre d’introduction", executive:"Résumé exécutif", objectives:"Objectifs", approach:"Approche & phasage", deliverables:"Livrables", in_scope:"Inclus", out_scope:"Hors-périmètre", timeline:"Planning", pricing:"Tarification", assumptions:"Hypothèses / Risques", next:"Prochaines étapes", price_model:"Modèle", terms:"Conditions", toc:"Sommaire" },
      en:{ title:"Business Proposal", to:"To", from:"Issued by", date:"Date", letter:"Cover Letter", executive:"Executive Summary", objectives:"Objectives", approach:"Approach & Phasing", deliverables:"Deliverables", in_scope:"In scope", out_scope:"Out of scope", timeline:"Timeline", pricing:"Pricing", assumptions:"Assumptions / Risks", next:"Next Steps", price_model:"Model", terms:"Terms", toc:"Table of Contents" }
    };

    function safeArr(v){ return Array.isArray(v)?v:[]; }
    function safeStr(v,fb=''){ return (v==null?'':String(v)).trim() || fb; }
    function fmtDate(d){ try{ const dt=d?new Date(d):new Date(); return dt.toLocaleDateString(document.documentElement.lang||getLang(), {year:'numeric',month:'short',day:'2-digit'});}catch{return ''} }
    function money(n,c){ try{ return new Intl.NumberFormat(document.documentElement.lang||getLang(),{style:'currency',currency:c||'EUR'}).format(Number(n||0)); }catch{ return String(n||0)+' '+(c||'€') } }

    function section(titleHTML, id){ const h=document.createElement('h2'); h.innerHTML=titleHTML; if(id) h.id=id; sheet.appendChild(h); }
    function para(text){ const p=document.createElement('p'); p.textContent=text; sheet.appendChild(p); }
    function list(items){ if(!items?.length) return; const ul=document.createElement('ul'); items.forEach(it=>{ const li=document.createElement('li'); li.textContent=String(it); ul.appendChild(li); }); sheet.appendChild(ul); }
    function buildTOC(sections){ const L=t[spec.meta?.lang||getLang()]||t.fr; const box=document.createElement('div'); box.className='toc'; box.innerHTML=`<b>${L.toc}</b>`; sections.forEach(s=>{ if(s.present){ const a=document.createElement('a'); a.href='#'+s.id; a.textContent=s.title; box.appendChild(a);} }); sheet.appendChild(box); }

    function renderSpec(){
      if(!spec){ sheet.innerHTML='<p class="muted">Aucune donnée.</p>'; return; }
      const L=t[spec.meta?.lang||getLang()]||t.fr;
      sheet.innerHTML='';

      // appliquer le thème avant de construire le contenu
      applyDesignFromSpec(spec?.meta?.style?.designSpec||{});

      const header=document.createElement('div'); header.className='doc-header';
      const logoBox=document.createElement('div'); logoBox.className='logo-box';
      if(spec.meta?.style?.logoDataUrl){ const im=new Image(); im.src=spec.meta.style.logoDataUrl; logoBox.appendChild(im);} else { logoBox.textContent='LOGO'; logoBox.style.color='#9aa6bf'; }
      const bi=document.createElement('div'); bi.className='brand-info';
      const company=safeStr(spec.meta?.company || spec.meta?.brand?.company,'Votre société');
      const contact=safeStr(spec.meta?.brand?.contact_name,''), website=safeStr(spec.meta?.brand?.website,''), email=safeStr(spec.meta?.brand?.email,''), phone=safeStr(spec.meta?.brand?.phone,'');
      bi.innerHTML=`<div class="company">${company}</div><div class="muted">${[contact,website,email,phone].filter(Boolean).join(' • ')}</div>`;
      header.appendChild(logoBox); header.appendChild(bi); sheet.appendChild(header);

      const title=safeStr(spec.meta?.title,L.title); const client=safeStr(spec.meta?.client,'Client'); const date=safeStr(spec.meta?.date, fmtDate());
      const head=document.createElement('div');
      head.innerHTML = `<div class="h1">${title}</div>
        <div class="meta">${L.to}: <span class="tag">${client}</span> &nbsp;•&nbsp; ${L.from}: <span class="tag">${company}</span> &nbsp;•&nbsp; ${L.date}: ${date}</div>`;
      sheet.appendChild(head);
      sheet.appendChild(Object.assign(document.createElement('div'),{className:'hr'}));

      const tocSections=[
        { id:'s_letter', title:L.letter, present:safeArr(spec.letter?.body_paragraphs||spec.letter?.paragraphs).length || spec.letter?.greeting||spec.letter?.closing||spec.letter?.signature },
        { id:'s_executive', title:L.executive, present:safeArr(spec.executive_summary?.paragraphs).length },
        { id:'s_objectives', title:L.objectives, present:safeArr(spec.objectives?.bullets).length },
        { id:'s_approach', title:L.approach, present:safeArr(spec.approach?.phases).length },
        { id:'s_deliverables', title:L.deliverables, present:(spec.deliverables && (safeArr(spec.deliverables.in).length || safeArr(spec.deliverables.out).length)) },
        { id:'s_timeline', title:L.timeline, present:safeArr(spec.timeline?.milestones).length },
        { id:'s_pricing', title:L.pricing, present:(spec.pricing && (spec.pricing.items?.length || spec.pricing.price!=null)) },
        { id:'s_assumptions', title:L.assumptions, present:safeArr(spec.assumptions?.paragraphs).length },
        { id:'s_next', title:L.next, present:safeArr(spec.next_steps?.paragraphs).length },
      ];
      buildTOC(tocSections);

      if (tocSections[0].present){
        section(L.letter,'s_letter');
        const letter=spec.letter||{};
        if(letter.greeting) para(letter.greeting);
        const bodies=safeArr(letter.body_paragraphs?.length?letter.body_paragraphs:letter.paragraphs); bodies.forEach(p=>para(p));
        if(letter.closing) para(letter.closing); if(letter.signature) para(letter.signature);
      }
      if (tocSections[1].present){ section(L.executive,'s_executive'); safeArr(spec.executive_summary.paragraphs).forEach(p=>para(p)); }
      if (tocSections[2].present){ section(L.objectives,'s_objectives'); list(spec.objectives.bullets); }
      if (tocSections[3].present){
        section(L.approach,'s_approach');
        safeArr(spec.approach.phases).forEach((ph,i)=>{
          const c=document.createElement('div'); c.className='card';
          c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Phase ${i+1} — ${safeStr(ph.title,'À confirmer')}</strong>
            <span class="pill">${safeStr(ph.duration||'','')}</span></div>`;
          sheet.appendChild(c);
          if(ph.description) para(ph.description);
          const acts=safeArr(ph.activities?.length?ph.activities:ph.steps); if(acts.length) list(acts);
          const outs=safeArr(ph.outcomes); if(outs.length){ const p=document.createElement('p'); p.innerHTML='<em>Résultats attendus :</em>'; sheet.appendChild(p); list(outs); }
        });
      }
      if (tocSections[4].present){
        section(L.deliverables,'s_deliverables');
        const grid=document.createElement('div'); grid.className='grid2';
        const a=document.createElement('div'); a.className='card'; a.innerHTML=`<div class="muted" style="margin-bottom:6px">${L.in_scope}</div>`;
        const b=document.createElement('div'); b.className='card'; b.innerHTML=`<div class="muted" style="margin-bottom:6px">${L.out_scope}</div>`;
        grid.appendChild(a); grid.appendChild(b); sheet.appendChild(grid);
        const ulA=document.createElement('ul'); safeArr(spec.deliverables.in).forEach(x=>{const li=document.createElement('li'); li.textContent=x; ulA.appendChild(li);});
        const ulB=document.createElement('ul'); safeArr(spec.deliverables.out).forEach(x=>{const li=document.createElement('li'); li.textContent=x; ulB.appendChild(li);});
        a.appendChild(ulA); b.appendChild(ulB);
      }
      if (tocSections[5].present){
        section(L.timeline,'s_timeline');
        const grid=document.createElement('div'); grid.className='grid2';
        safeArr(spec.timeline.milestones).forEach(ms=>{
          const c=document.createElement('div'); c.className='card';
          c.innerHTML = `<div><strong>${safeStr(ms.title,'Étape')}</strong></div><div class="muted">${safeStr(ms.dateOrWeek || ms.date || ms.duration || '', '')}</div>`;
          if(ms.notes){ const p=document.createElement('p'); p.textContent=ms.notes; c.appendChild(p); }
          grid.appendChild(c);
        });
        sheet.appendChild(grid);
      }
      if (tocSections[6].present){
        section(L.pricing,'s_pricing');
        const pr=spec.pricing||{}; const currency=pr.currency||spec.meta?.currency||'EUR';
        const m=document.createElement('div'); m.className='muted'; m.style.margin='-6px 0 8px'; m.innerHTML = `${L.price_model}: <span class="pill">${safeStr(pr.model,'forfait')}</span>`; sheet.appendChild(m);
        if(Array.isArray(pr.items)&&pr.items.length){
          const table=document.createElement('table');
          table.innerHTML=`<thead><tr><th>Item</th><th>Qté</th><th>Unité</th><th>PU</th><th>Sous-total</th></tr></thead><tbody></tbody><tfoot>
            <tr><td colspan="4" style="text-align:right">Sous-total</td><td id="ft_subtotal"></td></tr>
            <tr><td colspan="4" style="text-align:right">Taxes</td><td id="ft_tax"></td></tr>
            <tr><td colspan="4" style="text-align:right">Total</td><td id="ft_total"></td></tr></tfoot>`;
          const tb=table.querySelector('tbody');
          pr.items.forEach(it=>{
            const tr=document.createElement('tr');
            const qty=Number(it.qty||1), up=Number(it.unit_price||0), st=(it.subtotal!=null)?Number(it.subtotal):qty*up;
            tr.innerHTML=`<td>${safeStr(it.name,'—')}</td><td>${Number.isFinite(qty)?qty:1}</td><td>${safeStr(it.unit||'—')}</td><td>${money(up,currency)}</td><td>${money(st,currency)}</td>`;
            tb.appendChild(tr);
          });
          sheet.appendChild(table);
          const subtotal=Array.from(tb.children).reduce((s,tr)=>{ const v=(tr.children[4]?.textContent||'0').replace(/[^\d.,-]/g,'').replace(',','.'); return s + (parseFloat(v)||0); },0);
          const taxRate=Number(pr.tax_rate||0); const taxes=subtotal*(taxRate/100); const total=subtotal+taxes;
          sheet.querySelector('#ft_subtotal').textContent=money(subtotal,currency);
          sheet.querySelector('#ft_tax').textContent=`${money(taxes,currency)} ${taxRate?`(${taxRate}%)`:''}`;
          sheet.querySelector('#ft_total').textContent=money(total,currency);
          if((pr.terms||[]).length){ const terms=document.createElement('div'); terms.className='card'; terms.style.marginTop='8px'; terms.innerHTML=`<div class="muted" style="margin-bottom:6px">${L.terms}</div><ul>${(pr.terms||[]).map(x=>`<li>${x}</li>`).join('')}</ul>`; sheet.appendChild(terms); }
        }else{
          const priceBox=document.createElement('div'); priceBox.className='card'; const price=pr.price!=null?String(pr.price):'—';
          priceBox.innerHTML=`<div class="price">${money(price,currency)}</div><div class="muted" style="margin-top:4px">${L.price_model}: <span>${safeStr(pr.model,'forfait')}</span></div>`;
          sheet.appendChild(priceBox);
        }
      }
      if (tocSections[7].present){ section(L.assumptions,'s_assumptions'); safeArr(spec.assumptions.paragraphs).forEach(p=>para(p)); }
      if (tocSections[8].present){ section(L.next,'s_next'); safeArr(spec.next_steps.paragraphs).forEach(p=>para(p)); }
    }
    renderSpec();

    /* Lang */
    function applyChatLang(){
      const en=(getLang()==='en');
      document.getElementById('composer').placeholder = en?'Type your message':'Écrivez votre message';
    }
    applyChatLang();
    window.addEventListener('langchange', ()=>{
      spec.meta = { ...(spec.meta||{}), lang:getLang() };
      localStorage.setItem('pf_proposal', JSON.stringify(spec));
      applyChatLang();
      applyDesignFromSpec(spec?.meta?.style?.designSpec||{});
      renderSpec();
    });

    /* Si dernier message user est sans réponse → relance */
    if(messages.length && messages[messages.length-1].role==='user' && !chatBody.querySelector('.bubble-assistant')){
      sendMessage(messages[messages.length-1].content);
    }

    /* appliquer le design au tout premier rendu (si historique) */
    applyDesignFromSpec(spec?.meta?.style?.designSpec||{});
  </script>
</body>
</html>
