<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0a1020; --muted:#667085; --stroke:#e6e9f3; --bg:#f6f8ff;
      --accent:#3b82f6; --accent-ink:#fff; --shadow:0 10px 28px rgba(10,16,32,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}

    /* Top bar */
    .bar{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;cursor:pointer}
    .spark{width:22px;height:22px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .left,.right{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.accent{background:var(--accent);color:var(--accent-ink);border-color:#0000}
    select.sel,.theme{border:1px solid var(--stroke);border-radius:10px;padding:7px 10px;background:#fff;cursor:pointer}
    .avatar{width:32px;height:32px;border-radius:50%;background:#0b2446;color:#e8eefc;font-weight:800;display:grid;place-items:center}
    .dropdown{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--stroke);border-radius:12px;box-shadow:var(--shadow);padding:8px;display:none;min-width:220px}
    .show{display:block}

    /* Layout */
    .wrap{display:grid;grid-template-columns:420px 1fr;height:calc(100vh - 52px)}
    .panel{border-right:1px solid var(--stroke);background:#fff;display:flex;flex-direction:column}
    .panel-head{padding:12px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .panel-head strong{font-size:14px}
    .chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{display:flex}
    .msg.me{justify-content:flex-end}
    .bubble{max-width:78%;background:#fff;border:1px solid var(--stroke);padding:10px 12px;border-radius:12px}
    .msg.me .bubble{background:#0b2446;color:#e8eefc}
    .composer{padding:10px;border-top:1px solid var(--stroke);background:#fff}
    .input{display:flex;gap:8px;border:1px solid var(--stroke);border-radius:12px;padding:8px;background:#fff}
    textarea{flex:1;border:none;outline:none;resize:none;max-height:160px;font:500 14px/1.4 Inter}
    .tool{width:38px;height:38px;border-radius:10px;border:1px solid var(--stroke);background:#fff;display:grid;place-items:center;cursor:pointer}
    .send{background:var(--accent);color:#fff;border-color:#0000}

    /* Preview */
    .preview{position:relative}
    .preview iframe{border:0;width:100%;height:100%}
    .pv-hint{position:absolute;left:12px;top:12px;background:#ffffffd9;border:1px solid var(--stroke);padding:6px 10px;border-radius:10px;font-size:12px;color:#475569}

    /* History drawer */
    .drawer{position:fixed;left:12px;top:60px;width:360px;max-height:75vh;overflow:auto;background:#fff;border:1px solid var(--stroke);border-radius:12px;box-shadow:var(--shadow);padding:10px;display:none;z-index:25}
    .item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;border:1px solid transparent;cursor:pointer}
    .item:hover{background:#f6f8ff}
    .muted{color:#667085}

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr}
      .preview{display:none}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
  <!-- BAR -->
  <div class="bar">
    <div class="left">
      <div id="home" class="brand" title="Accueil"><div class="spark"></div>PropoFlash</div>
      <button class="btn" id="historyBtn">Historique</button>
      <span id="status" class="muted">Prêt</span>
    </div>
    <div class="right" style="position:relative">
      <select class="sel" id="langSel"><option value="fr">FR</option><option value="en">EN</option></select>
      <button class="theme" id="themeBtn">☀︎/☾</button>
      <button class="btn" id="backBtn">Accueil</button>
      <div id="userBox" style="display:none;position:relative">
        <button class="avatar" id="avatarBtn">U</button>
        <div class="dropdown" id="dropdown">
          <div style="padding:6px 8px;color:#667085;font-size:12px" id="userEmail">—</div>
          <button id="signOutBtn">Se déconnecter</button>
        </div>
      </div>
      <button class="btn accent" id="exportBtn">Exporter PDF</button>
    </div>
  </div>

  <!-- HISTORY drawer -->
  <div class="drawer" id="drawer"></div>

  <!-- MAIN -->
  <div class="wrap">
    <!-- LEFT: CHAT -->
    <div class="panel">
      <div class="panel-head">
        <strong>Assistant</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <img id="miniLogo" alt="" style="width:20px;height:20px;object-fit:cover;border-radius:6px;border:1px solid var(--stroke);display:none">
        </div>
      </div>
      <div id="thread" class="chat" aria-live="polite"></div>

      <div class="composer">
        <div class="input">
          <input id="logoInput" type="file" accept="image/*" hidden>
          <button class="tool" id="logoBtn" title="Ajouter un logo">＋</button>
          <textarea id="message" rows="1" placeholder="Écrivez votre message"></textarea>
          <button class="tool send" id="sendBtn" title="Envoyer">➤</button>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <small class="muted">Entrée = envoyer • Maj+Entrée = nouvelle ligne</small>
          <small class="muted"><span id="leftCount">—</span> aperçus restants (Free)</small>
        </div>
      </div>
    </div>

    <!-- RIGHT: PREVIEW -->
    <div class="preview">
      <iframe id="pv" src="preview.html" title="Aperçu"></iframe>
      <div class="pv-hint" id="pvHint">L’aperçu se mettra à jour automatiquement.</div>
    </div>
  </div>

  <script>
  (function(){
    const $=q=>document.querySelector(q);

    // Lang/thème
    function setLangUI(lang){
      document.documentElement.lang = lang;
      $("#message").placeholder = lang==='en' ? "Write your message" : "Écrivez votre message";
      $("#backBtn").textContent = lang==='en' ? "Home" : "Accueil";
      $("#historyBtn").textContent = lang==='en' ? "History" : "Historique";
      $("#exportBtn").textContent = lang==='en' ? "Export PDF" : "Exporter PDF";
      $("#pvHint").textContent = lang==='en' ? "The preview updates live." : "L’aperçu se mettra à jour automatiquement.";
    }
    function applyTheme(theme){
      if(theme==='dark'){
        document.body.style.background="#0f1730";
        document.body.style.color="#e8eefc";
      }else{
        document.body.style.background="var(--bg)";
        document.body.style.color="var(--ink)";
      }
    }

    // Supabase
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    let sb, currentChatId = localStorage.getItem('pf_chat_id')||null;

    // State
    const thread=$("#thread");
    const pv = $("#pv");
    const status = $("#status");
    const miniLogo = $("#miniLogo");
    const LIMITS={free:3, starter:50, pro:1e9};
    const PLAN='free'; // front-only
    const monthKey=(plan)=>{const d=new Date(); return `pf_${plan}_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;}
    const getCount=(plan)=>parseInt(localStorage.getItem(monthKey(plan))||'0',10);
    const incCount=(plan)=>localStorage.setItem(monthKey(plan), String(getCount(plan)+1));
    const leftCount=(plan)=> (LIMITS[plan]||0) - getCount(plan);
    const updateLeft=()=>{ $("#leftCount").textContent = Math.max(0,leftCount('free')); };

    function addMsg(text, who='ai'){
      const row=document.createElement('div'); row.className='msg'+(who==='me'?' me':'');
      const b=document.createElement('div'); b.className='bubble'; b.textContent=String(text||'');
      row.appendChild(b); thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
    }
    function saveLocal(role, content){
      const hist = JSON.parse(localStorage.getItem('pf_chat')||'[]');
      const next = [...hist, {role, content}].slice(-50);
      localStorage.setItem('pf_chat', JSON.stringify(next));
      localStorage.setItem('pf_chat_ts', String(Date.now()));
    }
    function loadLocal(){
      const hist = JSON.parse(localStorage.getItem('pf_chat')||'[]');
      thread.innerHTML=''; hist.forEach(m=>addMsg(m.content, m.role==='user'?'me':'ai'));
    }

    function pushPreview(spec){
      // store + ping iframe
      localStorage.setItem('pf_proposal', JSON.stringify(spec));
      pv?.contentWindow?.postMessage({type:'pf_spec', payload:spec}, "*");
    }

    async function callChatAPI(message, proposalSpec, history){
      // Essaie l’API, sinon fallback côté front pour la démo
      try{
        const { data:{ session } } = await sb.auth.getSession();
        const headers = {'Content-Type':'application/json'};
        if(session?.access_token) headers.Authorization = `Bearer ${session.access_token}`;
        const res = await fetch('/api/chat',{ method:'POST', headers, body: JSON.stringify({ message, proposalSpec, history })});
        if(!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch{
        // Fallback simple : ajoute une section et une ligne pricing
        const reply = (document.documentElement.lang==='en')
          ? "Draft updated. I added an executive summary and a pricing line."
          : "Brouillon mis à jour. J’ai ajouté un résumé exécutif et une ligne de tarification.";
        const spec = JSON.parse(localStorage.getItem('pf_proposal')||'{"meta":{"lang":"fr"},"sections":[]}');
        const next = {
          ...spec,
          meta:{ ...(spec.meta||{}), lang: document.documentElement.lang },
          executive_summary:{ paragraphs:[
            "Résumé exécutif généré à partir de votre brief (modifiable)."
          ]},
          pricing:{ currency:"EUR", model:"forfait",
            items:[{ name:"Forfait projet", qty:1, unit:"pack", unit_price:1500 }] }
        };
        return { reply, proposalSpec: next, actions:[{type:'preview'}] };
      }
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      // Lang
      const langSel=$("#langSel");
      const lang = localStorage.getItem('pf_lang') || (navigator.language||'fr').slice(0,2);
      langSel.value = ['fr','en'].includes(lang)?lang:'en';
      setLangUI(langSel.value);
      langSel.addEventListener('change', e=>{ localStorage.setItem('pf_lang', e.target.value); setLangUI(e.target.value); });

      // Theme
      const theme = localStorage.getItem('pf_theme')||'light';
      applyTheme(theme);
      $("#themeBtn").addEventListener('click', ()=>{
        const next = (localStorage.getItem('pf_theme')==='dark') ? 'light' : 'dark';
        localStorage.setItem('pf_theme', next); applyTheme(next);
      });

      // Go home
      $("#home").addEventListener('click', ()=>location.href='index.html');
      $("#backBtn").addEventListener('click', ()=>location.href='index.html');

      // Supabase init + session
      let sessionUserEmail = '';
      try{
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        const { data:{ session } } = await sb.auth.getSession();
        if(session?.user){
          $("#userBox").style.display='block';
          sessionUserEmail = session.user.email||'';
          $("#userEmail").textContent = sessionUserEmail;
          $("#avatarBtn").textContent = (sessionUserEmail[0]||'U').toUpperCase();
        }else{
          $("#userBox").style.display='none';
        }
        // menu
        $("#avatarBtn").addEventListener('click', ()=>$("#dropdown").classList.toggle('show'));
        document.addEventListener('click',(e)=>{ const box=$("#userBox"); if(box && !box.contains(e.target)) $("#dropdown").classList.remove('show'); });
        $("#signOutBtn").addEventListener('click', async ()=>{ try{await sb.auth.signOut();}catch(_){ } location.href='index.html'; });
      }catch(e){ console.error(e); }

      // History drawer
      const drawer=$("#drawer");
      $("#historyBtn").addEventListener('click', async ()=>{
        if(drawer.style.display==='block'){ drawer.style.display='none'; return; }
        drawer.innerHTML = '<div class="muted" style="padding:6px 8px">Chargement…</div>';
        drawer.style.display='block';
        try{
          const { data:{ user } } = await sb.auth.getUser();
          if(!user){ drawer.innerHTML = '<div class="muted" style="padding:6px 8px">Connectez-vous pour voir l’historique.</div>'; return; }
          const { data, error } = await sb.from('chats').select('id,title,created_at').order('created_at',{ascending:false}).limit(30);
          if(error){ drawer.innerHTML = '<div class="muted" style="padding:6px 8px">Erreur de chargement.</div>'; return; }
          drawer.innerHTML = '';
          data.forEach(c=>{
            const btn=document.createElement('div'); btn.className='item';
            btn.innerHTML = `<div style="overflow:hidden">
                <div style="font-weight:700;white-space:nowrap;text-overflow:ellipsis;overflow:hidden">${c.title||'Sans titre'}</div>
                <div class="muted" style="font-size:12px">${new Date(c.created_at).toLocaleString()}</div>
              </div><div>›</div>`;
            btn.onclick = async ()=>{ currentChatId=c.id; localStorage.setItem('pf_chat_id', c.id); await loadChatFromCloud(); drawer.style.display='none'; };
            drawer.appendChild(btn);
          });
        }catch(_){}
      });

      // Load local history
      loadLocal(); updateLeft();

      // Pré-remplir 1er message (depuis la home)
      const first = localStorage.getItem('pf_first_msg');
      if(first){ localStorage.removeItem('pf_first_msg'); $("#message").value = first; $("#message").focus(); }

      // Composer
      const textarea=$("#message"); const sendBtn=$("#sendBtn");
      textarea.addEventListener('keydown',(e)=>{
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
      });

      // Logo
      $("#logoBtn").addEventListener('click', ()=>$("#logoInput").click());
      $("#logoInput").addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const fr = new FileReader();
        fr.onload = ()=>{
          const spec = JSON.parse(localStorage.getItem('pf_proposal')||'{"meta":{}}');
          const next = { ...spec, meta:{ ...(spec.meta||{}), style:{ ...(spec.meta?.style||{}), logoDataUrl: fr.result } } };
          miniLogo.src = fr.result; miniLogo.style.display='inline-block';
          pushPreview(next);
          addMsg('Logo importé. Le thème de l’aperçu s’adaptera.', 'ai');
          saveLocal('assistant','Logo importé. Le thème de l’aperçu s’adaptera.');
        };
        fr.readAsDataURL(file);
      });

      // Export
      $("#exportBtn").addEventListener('click', ()=> pv?.contentWindow?.postMessage({type:'pf_cmd', payload:'print'}, '*'));

      // Send
      sendBtn.addEventListener('click', async ()=>{
        const v = textarea.value.trim(); if(!v){ textarea.focus(); return; }
        addMsg(v,'me'); saveLocal('user', v); textarea.value=''; textarea.focus();

        if(PLAN==='free' && leftCount('free')<=0){
          addMsg('Limite atteinte : 3 aperçus gratuits/mois. Connectez-vous ou passez à Starter.','ai');
          saveLocal('assistant','Limite atteinte : 3 aperçus gratuits/mois.'); return;
        }

        status.textContent='Traitement…';
        try{
          await ensureChat(v.slice(0,80));
          const history = JSON.parse(localStorage.getItem('pf_chat')||'[]');
          const spec = JSON.parse(localStorage.getItem('pf_proposal')||'{"meta":{"lang":"'+document.documentElement.lang+'"}}');

          const data = await callChatAPI(v, spec, history);

          if(data.reply){ addMsg(data.reply,'ai'); saveLocal('assistant', data.reply); }
          if(data.proposalSpec){ pushPreview(data.proposalSpec); }

          // upsert proposal in cloud
          try{
            const { data:{ user } } = await sb.auth.getUser();
            if(user && currentChatId){
              await sb.from('proposals').upsert({ user_id:user.id, chat_id: currentChatId, spec: JSON.parse(localStorage.getItem('pf_proposal')||'{}') }, { onConflict:'chat_id' });
            }
          }catch(_){}

          incCount('free'); updateLeft();
          status.textContent='Prêt';
        }catch(e){
          console.error(e); addMsg('Erreur serveur. Réessayez.','ai'); status.textContent='Erreur';
        }
      });

      // iframe ready hint hide after first load
      pv.addEventListener('load', ()=>{ setTimeout(()=>$("#pvHint").style.display='none', 800); });

      // Ensure chat exists when logged-in
      async function ensureChat(title){
        const { data:{ user } } = await sb.auth.getUser();
        if(!user) return; // cloud facultatif
        if(currentChatId) return currentChatId;
        const { data, error } = await sb.from('chats').insert({ title }).select().single();
        if(!error && data){ currentChatId = data.id; localStorage.setItem('pf_chat_id', data.id); }
      }

      async function loadChatFromCloud(){
        const { data, error } = await sb.from('messages').select('role,content,created_at').eq('chat_id', currentChatId).order('created_at',{ascending:true});
        if(error){ addMsg('Impossible de charger cette discussion.','ai'); return; }
        thread.innerHTML=''; data.forEach(m=>addMsg(m.content, m.role==='user'?'me':'ai'));
      }
    });
  })();
  </script>
</body>
</html>
