<!doctype html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash ‚Äî Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1629; --ink:#e6ecff; --muted:#9aa6bf; --stroke:#22314d;
      --accent:#3b82f6; --accent2:#8b5cf6; --accent-ink:#fff;
      --chip:#101a33; --elev:#0d152b; --elev2:#0f1a36; --bubble-ai:#0d1730; --bubble-me:#122043;
    }
    :root[data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --ink:#0a1020; --muted:#5c667a; --stroke:#dfe6f4;
      --accent:#3b82f6; --accent2:#8b5cf6; --accent-ink:#fff;
      --chip:#ffffff; --elev:#ffffff; --elev2:#f8fbff; --bubble-ai:#ffffff; --bubble-me:#0b2446;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg); color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .top{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, #0000) , color-mix(in oklab, var(--panel) 92%, #0000)); backdrop-filter:saturate(130%) blur(6px); border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px}
    .brand{display:flex;align-items:center;gap:10px;cursor:pointer}
    .spark{width:24px;height:24px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .rightBtns{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--chip); color:var(--ink); border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
    .btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.12)} .btn[disabled]{opacity:.6;cursor:not-allowed}
    .seg{display:flex;border:1px solid var(--stroke);border-radius:10px;overflow:hidden}
    .seg button{border:none;background:var(--chip);padding:8px 10px;font-weight:700;cursor:pointer}
    .seg button.active{background:var(--accent);color:var(--accent-ink)}
    .sel{border:1px solid var(--stroke);border-radius:10px;background:var(--chip);color:var(--ink);padding:8px 10px;font-weight:700}
    .layout{height:calc(100% - 58px);display:grid;grid-template-columns:420px 1fr}
    .left{border-right:1px solid var(--stroke);background:var(--panel);display:flex;flex-direction:column}
    .head{padding:10px 12px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:8px;justify-content:space-between}
    .chat{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:88%;padding:10px 12px;border:1px solid color-mix(in oklab, var(--stroke) 80%, #0000); border-radius:12px;background:var(--bubble-ai);color:color-mix(in oklab, var(--ink) 90%, #000)}
    .msg.me{align-self:flex-end;background:var(--bubble-me);color:color-mix(in oklab, var(--ink) 94%, #fff)}
    .composer{padding:10px;border-top:1px solid var(--stroke);display:flex;gap:8px;align-items:flex-end}
    .logoBtn{min-width:44px;height:44px;border-radius:10px;border:1px solid var(--stroke);background:var(--chip);display:grid;place-items:center;cursor:pointer}
    .text{flex:1;min-height:44px;max-height:160px;border:1px solid var(--stroke);border-radius:12px;background:var(--chip);color:var(--ink);padding:10px 12px;resize:vertical}
    .send{min-width:110px;height:44px;border-radius:10px;border:1px solid var(--stroke);background:var(--accent);color:var(--accent-ink);font-weight:800;cursor:pointer}
    .send.loading{opacity:.7;pointer-events:none}
    .right{position:relative;overflow:auto;background:color-mix(in oklab, var(--bg) 92%, #0000)}
    .toolbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 96%, #0000), color-mix(in oklab, var(--panel) 92%, #0000));padding:8px;border-bottom:1px solid var(--stroke);display:flex;gap:8px;align-items:center}
    .chip{border:1px solid var(--stroke);background:var(--chip);color:var(--ink);padding:6px 10px;border-radius:999px;font-size:12px}
    .wrap{padding:16px;display:grid;place-items:start}
    .sheet{width:900px; min-height:1200px; background:var(--elev); border:1px solid var(--stroke); border-radius:12px; box-shadow:0 14px 48px rgba(0,0,0,.18); padding:26px; color:var(--ink)}
    .h1{font-size:28px;font-weight:800;margin:0 0 4px}
    .meta{color:var(--muted);margin-bottom:16px}
    h2{margin:20px 0 8px}
    .tag{display:inline-block;border:1px solid var(--stroke);background:var(--elev2);color:var(--ink);padding:2px 8px;border-radius:999px;font-size:12px}
    .card{border:1px solid var(--stroke);background:var(--elev2);border-radius:12px;padding:12px;margin:8px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    ul{margin:6px 0 10px 18px}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border:1px solid var(--stroke);padding:8px} th{background:var(--elev2)}
    .muted{color:var(--muted)} .hidden{display:none}
    .profile{position:relative}
    .avatar{width:34px;height:34px;border-radius:50%;border:1px solid var(--stroke);background:var(--chip);display:grid;place-items:center;font-weight:800}
    .menu{position:absolute; right:0; top:44px; min-width:220px; background:var(--panel); border:1px solid var(--stroke); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:8px; display:none}
    .menu.open{display:block}
    .menu .mi{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .menu .mi:hover{background:var(--elev2)}
    .menu .muted{font-size:12px}
    @media (max-width:1100px){.layout{grid-template-columns:1fr} .sheet{width:min(900px, 100% - 32px)}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="site-lang.js"></script>
</head>
<body>
  <div class="top">
    <a class="brand" href="index.html" title="Accueil"><div class="spark"></div><strong>PropoFlash Studio</strong></a>
    <div class="rightBtns">
      <div class="seg" id="themeSeg" aria-label="Th√®me">
        <button type="button" data-theme="light" title="Clair">‚òÄÔ∏è</button>
        <button type="button" data-theme="dark" title="Sombre">üåô</button>
        <button type="button" data-theme="auto" title="Auto" class="active">üñ•Ô∏è</button>
      </div>
      <!-- S√©lecteur global -->
      <select id="langSel" class="sel" data-lang-picker title="Language">
        <option value="fr">FR</option><option value="en">EN</option>
      </select>
      <button id="historyBtn" class="btn" data-i18n="history">Historique</button>
      <button id="authBtn" class="btn">Se connecter</button>
      <div id="profileBox" class="profile hidden">
        <div id="avatar" class="avatar">?</div>
        <div id="profileMenu" class="menu">
          <div class="mi" style="cursor:default">
            <div id="menuAvatar" class="avatar" style="width:28px;height:28px;font-size:12px">?</div>
            <div><div id="menuName" style="font-weight:800">User</div><div id="menuEmail" class="muted">email</div></div>
          </div>
          <div class="mi" id="goAccount">Mon compte</div>
          <div class="mi" id="logout">Se d√©connecter</div>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="left">
      <div class="head">
        <div style="font-weight:800" data-i18n="assistant">Assistant</div>
        <div class="muted" id="chatTitle" data-i18n="new_chat">Nouvelle discussion</div>
      </div>
      <div id="thread" class="chat" aria-live="polite"></div>
      <div class="composer">
        <button id="logoBtn" class="logoBtn" title="+ Logo">üñºÔ∏è</button>
        <input id="logoInput" type="file" accept="image/*" hidden>
        <textarea id="prompt" class="text" placeholder=""></textarea>
        <button id="send" class="send" data-i18n="send">Envoyer</button>
      </div>
    </aside>

    <main class="right">
      <div class="toolbar">
        <span class="chip" id="status">Aper√ßu</span>
        <button id="openFull" class="btn" data-i18n="fullscreen">Plein √©cran</button>
        <button id="emailModeBtn" class="btn" data-i18n="email_mode">Mode Email</button>
      </div>
      <div class="wrap"><div id="preview" class="sheet"></div></div>
    </main>
  </div>

  <div id="drawer" class="hidden" style="position:fixed;inset:auto 0 0 auto;width:360px;background:var(--panel);border-left:1px solid var(--stroke);box-shadow:-10px 0 40px rgba(0,0,0,.45)">
    <div style="padding:10px;border-bottom:1px solid var(--stroke);display:flex;justify-content:space-between;align-items:center">
      <strong data-i18n="my_chats">Mes discussions</strong>
      <button id="closeDrawer" class="btn" data-i18n="close">Fermer</button>
    </div>
    <div id="chatList" style="display:flex;flex-direction:column;gap:8px;padding:10px;max-height:60vh;overflow:auto"></div>
  </div>

  <script>
    /* ====== I18N UI ====== */
    const UI = {
      fr: {history:"Historique", assistant:"Assistant", new_chat:"Nouvelle discussion", send:"Envoyer", fullscreen:"Plein √©cran", email_mode:"Mode Email", my_chats:"Mes discussions", close:"Fermer", status_preview:"Aper√ßu", status_updating:"G√©n√©ration‚Ä¶", status_ready:"Aper√ßu mis √† jour", guest_used:"Essai gratuit utilis√©. Connectez-vous pour continuer.", connect:"Se connecter", disconnect:"Se d√©connecter", account:"Mon compte", placeholder:"√âcrivez votre message‚Ä¶", loading:"Chargement‚Ä¶", error:"Erreur", signout_ok:"D√©connexion effectu√©e" },
      en: {history:"History", assistant:"Assistant", new_chat:"New chat", send:"Send", fullscreen:"Fullscreen", email_mode:"Email Mode", my_chats:"My chats", close:"Close", status_preview:"Preview", status_updating:"Generating‚Ä¶", status_ready:"Preview updated", guest_used:"Free trial used. Please sign in to continue.", connect:"Sign in", disconnect:"Sign out", account:"Account", placeholder:"Write your message‚Ä¶", loading:"Loading‚Ä¶", error:"Error", signout_ok:"Signed out" }
    };
    function t(k){ const L=UI[getLang()]||UI.en; return L[k]||k; }
    function applyUI(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = t(el.dataset.i18n); });
      document.getElementById('prompt').placeholder = t('placeholder');
      document.getElementById('status').textContent = t('status_preview');
      document.getElementById('authBtn').textContent = t('connect');
      document.getElementById('closeDrawer').textContent = t('close');
      document.getElementById('historyBtn').textContent = t('history');
      document.getElementById('openFull').textContent = t('fullscreen');
      document.getElementById('emailModeBtn').textContent = t('email_mode');
    }
    window.addEventListener('langchange', ()=>{ applyUI(); if(spec){ spec.meta = Object.assign({}, spec.meta||{}, { lang:getLang() }); saveSpec(); renderPreview(); }});
    document.addEventListener('DOMContentLoaded', applyUI);

    /* ====== Th√®me ====== */
    const themeSeg = document.getElementById('themeSeg');
    function applyTheme(mode){
      document.documentElement.setAttribute('data-theme', mode);
      themeSeg.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b.dataset.theme===mode));
      localStorage.setItem('pf_theme', mode);
      if(mode==='auto'){
        const mql=window.matchMedia('(prefers-color-scheme: dark)');
        document.documentElement.setAttribute('data-theme', mql.matches?'dark':'light');
      }
    }
    themeSeg.addEventListener('click', e=>{ const b=e.target.closest('button'); if(!b) return; applyTheme(b.dataset.theme); });
    (function(){ const saved=localStorage.getItem('pf_theme')||'auto'; applyTheme(saved); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if((localStorage.getItem('pf_theme')||'auto')==='auto') applyTheme('auto'); }); })();

    /* ====== Supabase + Auth UI ====== */
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const authBtn     = document.getElementById('authBtn');
    const profileBox  = document.getElementById('profileBox');
    const avatar      = document.getElementById('avatar');
    const menu        = document.getElementById('profileMenu');
    const menuAvatar  = document.getElementById('menuAvatar');
    const menuName    = document.getElementById('menuName');
    const menuEmail   = document.getElementById('menuEmail');
    const logoutBtn   = document.getElementById('logout');
    const goAccount   = document.getElementById('goAccount');

    let IS_GUEST = true;
    function initialsFromEmail(email=''){ const m=(email.split('@')[0]||'').slice(0,2).toUpperCase(); return m||'U'; }
    function showAuth(session){
      if(session){
        IS_GUEST=false; authBtn.classList.add('hidden'); profileBox.classList.remove('hidden');
        const meta=session.user?.user_metadata||{}; const name=meta.full_name||meta.name||(session.user.email||'').split('@')[0]||'User';
        const email=session.user?.email||''; const pic=meta.avatar_url||meta.picture||'';
        if(pic){ avatar.innerHTML=`<img src="${pic}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`; menuAvatar.innerHTML=avatar.innerHTML; }
        else { avatar.textContent=initialsFromEmail(email); menuAvatar.textContent=initialsFromEmail(email); }
        menuName.textContent=name; menuEmail.textContent=email;
        document.getElementById('logout').textContent=t('disconnect'); document.getElementById('goAccount').textContent=t('account');
      }else{
        IS_GUEST=true; profileBox.classList.add('hidden'); authBtn.classList.remove('hidden'); authBtn.textContent=t('connect'); authBtn.onclick=()=>location.href='auth.html?from=studio';
      }
      enforceGuestLimitUI();
    }
    sb.auth.getSession().then(({data:{session}})=>showAuth(session));
    sb.auth.onAuthStateChange((_evt,session)=>showAuth(session));
    avatar.onclick = ()=> menu.classList.toggle('open');
    document.addEventListener('click',(e)=>{ if(!profileBox.contains(e.target)) menu.classList.remove('open'); });
    logoutBtn.onclick = async ()=>{ await sb.auth.signOut(); alert(t('signout_ok')); localStorage.removeItem('pf_chat_id'); location.reload(); };
    goAccount.onclick = ()=> window.open('https://app.supabase.com/','_blank');

    /* ====== Historique ====== */
    const drawer=document.getElementById('drawer'); const chatList=document.getElementById('chatList');
    document.getElementById('historyBtn').onclick = async ()=>{ if(IS_GUEST){ alert(t('guest_used')); return; } drawer.classList.remove('hidden'); await listChats(); };
    document.getElementById('closeDrawer').onclick = ()=> drawer.classList.add('hidden');

    async function listChats(){
      chatList.innerHTML = `<div class="muted">${t('loading')}</div>`;
      const { data:{ user } } = await sb.auth.getUser(); if(!user){ chatList.innerHTML='<div class="muted">‚Äî</div>'; return; }
      const { data, error } = await sb.from('chats').select('id,title,created_at').order('created_at',{ascending:false}).limit(50);
      if(error){ chatList.innerHTML = `<div class="muted">${t('error')}</div>`; return; }
      chatList.innerHTML=''; data.forEach(c=>{ const b=document.createElement('button'); b.className='btn'; b.style.justifyContent='space-between'; b.innerHTML=`<span>${c.title||'Sans titre'}</span><span class="muted" style="font-size:12px">${new Date(c.created_at).toLocaleString()}</span>`; b.onclick=()=>openChat(c.id); chatList.appendChild(b); });
    }
    let currentChatId = localStorage.getItem('pf_chat_id') || null;
    async function openChat(chatId){
      currentChatId=chatId; localStorage.setItem('pf_chat_id', chatId);
      document.getElementById('thread').innerHTML=''; document.getElementById('chatTitle').textContent=t('new_chat');
      const { data, error } = await sb.from('messages').select('role,content,created_at').eq('chat_id', chatId).order('created_at',{ascending:true});
      if(!error && data){ data.forEach(m=>addMsg(m.content, m.role==='user'?'me':'ai')); }
      drawer.classList.add('hidden'); document.getElementById('prompt').focus();
      try{ const { data:p } = await sb.from('proposals').select('spec').eq('chat_id', chatId).maybeSingle(); if(p?.spec){ spec=p.spec; saveSpec(); renderPreview(); } }catch{}
    }

    /* ====== Invit√© (1 envoi) ====== */
    const GUEST_LIMIT = 1;
    function guestKey(){ const d=new Date(); return `pf_guest_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;}
    function getGuestCount(){ return parseInt(localStorage.getItem(guestKey())||'0',10); }
    function incGuestCount(){ localStorage.setItem(guestKey(), String(getGuestCount()+1)); }
    function enforceGuestLimitUI(){
      const count=getGuestCount(); const promptEl=document.getElementById('prompt'); const sendBtn=document.getElementById('send');
      if(IS_GUEST && count>=GUEST_LIMIT){ sendBtn.disabled=true; promptEl.disabled=true; promptEl.placeholder=t('guest_used'); } else { sendBtn.disabled=false; promptEl.disabled=false; promptEl.placeholder=t('placeholder'); }
    }

    /* ====== Chat + Preview state ====== */
    const thread=document.getElementById('thread'); const statusEl=document.getElementById('status'); const promptEl=document.getElementById('prompt'); const sendBtn=document.getElementById('send'); const logoBtn=document.getElementById('logoBtn'); const logoInput=document.getElementById('logoInput');
    function addMsg(text, who='ai'){ const b=document.createElement('div'); b.className='msg'+(who==='me'?' me':''); b.textContent=String(text||''); thread.appendChild(b); thread.scrollTop=thread.scrollHeight; }
    function setStatus(s){ statusEl.textContent = t(s); }

    let spec=null;
    function loadSpec(){ try{ spec=JSON.parse(localStorage.getItem('pf_proposal')||'{}'); }catch{ spec={}; } spec=spec||{}; spec.meta=Object.assign({ lang:getLang() }, spec.meta||{}); saveSpec(); renderPreview(); }
    function saveSpec(){ localStorage.setItem('pf_proposal', JSON.stringify(spec||{})); }

    async function callChatAPI(message, proposalSpec, history){
      const { data:{ session } } = await sb.auth.getSession();
      const headers={'Content-Type':'application/json'}; if(session?.access_token){ headers.Authorization=`Bearer ${session.access_token}`; }
      const res=await fetch('/api/chat',{ method:'POST', headers, body: JSON.stringify({ message, proposalSpec, history }) }); if(!res.ok) throw new Error('HTTP '+res.status); return res.json();
    }

    sendBtn.onclick = async ()=>{
      if(IS_GUEST && getGuestCount()>=GUEST_LIMIT){ alert(t('guest_used')); location.href='auth.html?from=studio'; return; }
      const v=(promptEl.value||'').trim(); if(!v) return;
      addMsg(v,'me'); promptEl.value=''; promptEl.focus();
      const before=getGuestCount(); sendBtn.classList.add('loading'); sendBtn.disabled=true; setStatus('status_updating');
      try{
        if(!IS_GUEST && !currentChatId){
          const { data:{ user } } = await sb.auth.getUser();
          if(user){ const title=v.slice(0,80)||'Nouvelle discussion'; const { data, error } = await sb.from('chats').insert({ user_id:user.id, title }).select().single(); if(!error){ currentChatId=data.id; localStorage.setItem('pf_chat_id',data.id); } }
        }
        if(!IS_GUEST && currentChatId){ await sb.from('messages').insert({ chat_id:currentChatId, role:'user', content:v }); }
        const history=JSON.parse(localStorage.getItem('pf_chat')||'[]');
        const data=await callChatAPI(v, spec, history);
        if(data.reply){ addMsg(data.reply,'ai'); if(!IS_GUEST && currentChatId){ await sb.from('messages').insert({ chat_id:currentChatId, role:'assistant', content:data.reply }); } }
        if(data.proposalSpec){
          spec={ ...(spec||{}), ...(data.proposalSpec||{}), meta:{ ...(spec?.meta||{}), ...(data.proposalSpec?.meta||{}), lang:getLang() } };
          saveSpec(); renderPreview();
          if(!IS_GUEST && currentChatId){
            try{ const { data:{ user } } = await sb.auth.getUser(); if(user){ await sb.from('proposals').upsert({ user_id:user.id, chat_id:currentChatId, spec }, { onConflict:'chat_id' }); } }catch{}
          }
        }
        const newHist=[...history,{role:'user',content:v},{role:'assistant',content:(data.reply||'')}].slice(-30); localStorage.setItem('pf_chat', JSON.stringify(newHist));
        setStatus('status_ready');
        if(IS_GUEST && before<GUEST_LIMIT){ incGuestCount(); enforceGuestLimitUI(); }
      }catch(e){ console.error(e); addMsg(t('error'),'ai'); setStatus('status_preview'); }
      finally{ sendBtn.classList.remove('loading'); if(!(IS_GUEST && getGuestCount()>=GUEST_LIMIT)) sendBtn.disabled=false; }
    };

    promptEl.addEventListener('keydown',(e)=>{
      const hasText=(promptEl.value||'').trim().length>0;
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(hasText) sendBtn.click(); }
      if(e.key===' ' && e.altKey){ e.preventDefault(); if(hasText) sendBtn.click(); }
    });

    logoBtn.onclick=()=>logoInput.click();
    logoInput.onchange=async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      const dataUrl=await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
      const {primary,secondary}=await (async function extract(dataUrl){
        const img=new Image(); img.crossOrigin='anonymous'; img.src=dataUrl; await new Promise((r,j)=>{ img.onload=r; img.onerror=j; });
        const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{ willReadFrequently:true }); const W=180,H=Math.max(90,Math.round(img.height*(W/img.width))); canvas.width=W; canvas.height=H; ctx.drawImage(img,0,0,W,H);
        const { data }=ctx.getImageData(0,0,W,H); const map=new Map(); for(let i=0;i<data.length;i+=4*10){ const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3]/255; if(a<0.6) continue; const lum=(0.2126*r+0.7152*g+0.0722*b)/255; if(lum<0.12||lum>0.98) continue; const key=((r&0xF0)<<16)|((g&0xF0)<<8)|(b&0xF0); map.set(key,(map.get(key)||0)+1); }
        const hexify=k=>{ const r=(k>>16)&0xF0,g=(k>>8)&0xF0,b=k&0xF0; const H=x=>(x|0x0F).toString(16).padStart(2,'0'); return `#${H(r)}${H(g)}${H(b)}`.toUpperCase(); };
        const palette=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(([k])=>hexify(k)); const p=palette[0]||'#3B82F6';
        const dist=(h1,h2)=>{ const a={r:parseInt(h1.slice(1,3),16),g:parseInt(h1.slice(3,5),16),b:parseInt(h1.slice(5,7),16)}, b={r:parseInt(h2.slice(1,3),16),g:parseInt(h2.slice(3,5),16),b:parseInt(h2.slice(5,7),16)}; const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db); };
        let s='#8B5CF6'; for(let i=1;i<palette.length;i++){ if(dist(p,palette[i])>80){ s=palette[i]; break; } } return { primary
