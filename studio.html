<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f4f7fb;
      --panel: #ffffff;
      --card: #ffffff;
      --ink: #0a1020;
      --muted:#657086;
      --stroke:#e6ebf3;
      --accent:#3b82f6;
      --accent2:#8b5cf6;
      --pill:#eef5ff;
      --shadow-sm: 0 6px 18px rgba(10,16,32,.06);
      --shadow-md: 0 12px 30px rgba(10,16,32,.10);
      --radius: 14px;
    }
    .dark{
      --bg: #0d121a;
      --panel: #0f1520;
      --card: #121a27;
      --ink: #e9eefb;
      --muted:#9aa6bf;
      --stroke:#1e2a3d;
      --pill:#101826;
      --shadow-sm: 0 6px 18px rgba(0,0,0,.35);
      --shadow-md: 0 12px 30px rgba(0,0,0,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg),color-mix(in oklab, var(--bg) 60%, #dde7ff 40%));
      color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }

    /* Top bar */
    .top{position:sticky;top:0;z-index:20;background:var(--panel);
      border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand a{color:inherit;text-decoration:none}
    .spark{width:22px;height:22px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--stroke);background:var(--panel);color:var(--ink);
      border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow-sm)}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0000;box-shadow:0 10px 24px color-mix(in oklab, var(--accent) 25%, transparent)}
    .icon-btn{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px}

    /* Layout */
    .layout{display:grid;grid-template-columns:420px 1fr;gap:12px;height:calc(100vh - 56px)}
    .col{padding:12px;overflow:auto}

    /* Chat */
    .panel{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow-md)}
    .chat{display:flex;flex-direction:column;height:100%}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke)}
    .chat-body{flex:1;overflow:auto;padding:12px}
    .msg{display:flex;margin:8px 0}
    .msg.me{justify-content:flex-end}
    .bubble{max-width:80%;border:1px solid var(--stroke);padding:10px 12px;border-radius:12px;background:var(--card);color:var(--ink)}
    .msg.me .bubble{background:#0b2446;color:#e8eefc;border-color:#0000}
    .chat-input{display:grid;grid-template-columns:auto 1fr auto;gap:8px;border-top:1px solid var(--stroke);padding:10px}
    .input-actions{display:flex;align-items:center;gap:8px}
    textarea{width:100%;resize:vertical;min-height:72px;border:1px solid var(--stroke);border-radius:10px;padding:10px;background:var(--card);color:var(--ink)}

    /* Canvas */
    .canvas{padding:14px}
    .sheet{background:var(--card);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow-md);min-height:60vh}
    .hero{padding:22px;border-bottom:1px solid var(--stroke);position:relative;overflow:hidden;border-top-left-radius:16px;border-top-right-radius:16px}
    .hero::after{content:"";position:absolute;right:-80px;top:-60px;width:260px;height:200px;border-radius:20px;
      background:linear-gradient(135deg, color-mix(in oklab, var(--accent) 15%, transparent), color-mix(in oklab, var(--accent2) 15%, transparent));filter:blur(8px)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:var(--shadow-sm)}
    .sec-title{padding:8px 14px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}

    /* Skeleton (aperçu vide) */
    .skeleton{position:relative;overflow:hidden;background:var(--panel)}
    .sk-line{height:14px;border-radius:8px;background:color-mix(in oklab, var(--muted) 20%, transparent)}
    .sk-box{height:120px;border-radius:12px;background:color-mix(in oklab, var(--muted) 12%, transparent);border:1px solid var(--stroke)}
    .shimmer::before{
      content:"";position:absolute;inset:0;transform:translateX(-100%);
      background:linear-gradient(90deg, transparent, color-mix(in oklab, #fff 60%, transparent), transparent);
      animation:sh 1.4s infinite;
    }
    @keyframes sh{100%{transform:translateX(100%)}}

    /* Drawer */
    .drawer{position:fixed;top:0;right:0;bottom:0;width:min(440px,90vw);background:var(--panel);border-left:1px solid var(--stroke);box-shadow:var(--shadow-md);transform:translateX(100%);transition:transform .2s ease;z-index:30}
    .drawer.open{transform:translateX(0)}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke)}
    .drawer-body{padding:12px;overflow:auto;height:calc(100% - 52px)}
    .link-btn{display:flex;justify-content:space-between;gap:12px;width:100%;text-align:left}

    @media (max-width:1200px){.layout{grid-template-columns:1fr}.hero::after{display:none}}
    @media print{.top,.layout>.col:first-child,.drawer{display:none}.layout{grid-template-columns:1fr}.sheet{box-shadow:none;border:none}body{background:#fff}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- TOP -->
  <div class="top">
    <div class="brand"><div class="spark"></div><a href="index.html" title="Retour à l’accueil">PropoFlash</a></div>
    <div class="toolbar">
      <button id="historyBtn" class="btn">Historique</button>
      <button id="themeBtn" class="btn icon-btn" aria-label="Mode sombre/clair">☼</button>
      <button id="pdfBtn" class="btn">Exporter PDF</button>
      <button id="logoutBtn" class="btn">Déconnexion</button>
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="layout">
    <!-- LEFT / CHAT -->
    <div class="col">
      <div class="panel chat">
        <div class="chat-head">
          <strong>Assistant</strong>
        </div>
        <div id="chatBody" class="chat-body"></div>
        <div class="chat-input">
          <div class="input-actions">
            <input id="logoFile" type="file" accept="image/*" hidden>
            <button id="logoAttachBtn" class="btn icon-btn" title="Ajouter un logo" aria-label="Ajouter un logo">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="3"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <path d="M21 15l-4.5-4.5L9 18"></path>
              </svg>
            </button>
          </div>
          <textarea id="prompt" placeholder="Écrivez votre message…"></textarea>
          <button id="send" class="btn primary">Envoyer</button>
        </div>
      </div>
    </div>

    <!-- RIGHT / PREVIEW -->
    <div class="col">
      <div class="canvas panel">
        <div class="sheet" id="sheet"><!-- contenu injecté --></div>
      </div>
    </div>
  </div>

  <!-- Drawer Historique -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <strong>Mes discussions</strong>
      <button id="closeDrawer" class="btn icon-btn" aria-label="Fermer">✕</button>
    </div>
    <div id="historyList" class="drawer-body"></div>
  </div>

  <script>
    /* ===== Supabase ===== */
    const SUPABASE_URL  = 'https://lxiaaplvbitqqgvaxelt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4aWFhcGx2Yml0cXFndmF4ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTU0NjQsImV4cCI6MjA3MjM5MTQ2NH0.C3LzDFt67_GM978JIkSHDShmrr0mSYBr4jjVUxXgKtE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ===== State ===== */
    const chatBody = document.getElementById('chatBody');
    const promptEl = document.getElementById('prompt');
    const sheet = document.getElementById('sheet');
    let spec = null;
    let currentChatId = localStorage.getItem('pf_chat_id') || null;

    /* ===== Utils ===== */
    const toHex=(c)=>{const s=String(c||'').trim();if(/^#([0-9a-f]{3}){1,2}$/i.test(s))return s.toUpperCase();if(s.startsWith('rgb')){const m=s.match(/\d+/g)||[0,0,0];return '#'+m.slice(0,3).map(x=>Number(x).toString(16).padStart(2,'0')).join('').toUpperCase();}return '#3B82F6';};
    function addMsg(text, who='ai'){
      const row=document.createElement('div'); row.className='msg'+(who==='me'?' me':'');
      const b=document.createElement('div'); b.className='bubble'; b.textContent=String(text||'');
      row.appendChild(b); chatBody.appendChild(row); chatBody.scrollTop=chatBody.scrollHeight;
    }
    function showTyping(){
      removeTyping();
      const row=document.createElement('div'); row.className='msg'; row.id='typingRow';
      const b=document.createElement('div'); b.className='bubble'; b.textContent='…';
      row.appendChild(b); chatBody.appendChild(row); chatBody.scrollTop=chatBody.scrollHeight;
    }
    function removeTyping(){ const t=document.getElementById('typingRow'); if(t) t.remove(); }

    function persistSpec(){ if(!spec) return; localStorage.setItem('pf_proposal', JSON.stringify(spec)); saveProposalCloud().catch(()=>{}); }
    async function saveProposalCloud(){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user || !currentChatId || !spec) return;
      await sb.from('proposals').upsert({ user_id:user.id, chat_id:currentChatId, spec }, { onConflict:'chat_id' });
    }

    /* ===== Render ===== */
    function render(){
      sheet.innerHTML='';
      const primary = spec?.meta?.style?.primary || spec?.meta?.accent;
      const secondary = spec?.meta?.style?.secondary;
      if(primary) document.documentElement.style.setProperty('--accent', toHex(primary));
      if(secondary) document.documentElement.style.setProperty('--accent2', toHex(secondary));

      if(!spec){
        // Skeleton tant qu'on n'a rien
        const hero=document.createElement('div'); hero.className='hero skeleton shimmer';
        const grid=document.createElement('div'); grid.className='grid';
        const a=document.createElement('div'); a.className='card sk-box shimmer';
        const b=document.createElement('div'); b.className='card sk-box shimmer';
        grid.appendChild(a); grid.appendChild(b);
        sheet.appendChild(hero); sheet.appendChild(grid);
        return;
      }

      const hero = document.createElement('div'); hero.className='hero';
      const title  = spec.meta?.title ? `<h1 contenteditable="true" data-bind="meta.title">${spec.meta.title}</h1>` : '';
      const subtitle = spec.meta?.subtitle ? `<p contenteditable="true" data-bind="meta.subtitle">${spec.meta.subtitle}</p>` : '';
      hero.innerHTML = `${title}${subtitle}`;
      sheet.appendChild(hero);

      const grid = document.createElement('div'); grid.className='grid';
      if(spec.executive_summary?.paragraphs?.length){
        const c1=document.createElement('div'); c1.className='card';
        c1.innerHTML = `<div class="sec-title">Résumé</div><p contenteditable="true" data-bind="executive_summary.paragraphs.0">${spec.executive_summary.paragraphs[0]}</p>`;
        grid.appendChild(c1);
      }
      if(spec.pricing){
        const cur=spec.pricing.currency||spec.meta?.currency||'EUR';
        const total = Array.isArray(spec.pricing.items)? spec.pricing.items.reduce((s,it)=>s+Number(it.subtotal ?? (Number(it.qty||1)*Number(it.unit_price||0))),0)
                    : (spec.pricing.price ?? null);
        if(total!=null){
          const c2=document.createElement('div'); c2.className='card';
          c2.innerHTML = `<div class="sec-title">Chiffre</div><div style="font-weight:900;font-size:28px" contenteditable="true" data-bind="pricing.price">${new Intl.NumberFormat('fr-FR',{style:'currency',currency:cur}).format(Number(total)||0)}</div>`;
          grid.appendChild(c2);
        }
      }
      if(grid.children.length) sheet.appendChild(grid);

      if(Array.isArray(spec.approach?.phases) && spec.approach.phases.length){
        const sec=document.createElement('div'); sec.innerHTML='<div class="sec-title">Approche</div>';
        const stack=document.createElement('div'); stack.style.padding='0 14px 14px 14px'; stack.style.display='grid'; stack.style.gap='12px';
        spec.approach.phases.forEach((ph,i)=>{
          const k=document.createElement('div'); k.className='card';
          k.innerHTML = `<strong contenteditable="true" data-bind="approach.phases.${i}.title">${ph.title||('Phase '+(i+1))}</strong>`;
          stack.appendChild(k);
        });
        sec.appendChild(stack); sheet.appendChild(sec);
      }

      sheet.querySelectorAll('[contenteditable="true"]').forEach(el=>{
        el.addEventListener('input', ()=>{ const path=el.dataset.bind; if(!path) return; setDeep(spec,path,el.textContent.trim()); persistSpec(); });
      });
    }

    function setDeep(obj, path, val){
      const keys=path.split('.'); let cur=obj;
      for(let i=0;i<keys.length-1;i++){ const k=keys[i]; const idx=(String(+k)===k)?+k:k; if(cur[idx]==null) cur[idx]=(String(+keys[i+1])===keys[i+1])?[]:{}; cur=cur[idx]; }
      const last=keys.at(-1); cur[(String(+last)===last)?+last:last]=val;
    }

    /* ===== Robust loaders (LOCAL + CLOUD) ===== */
    function mergeAnySpec(data, base){
      const candidate = data?.proposalSpec || data?.proposal || data?.spec || data?.preview?.spec || data?.result?.proposalSpec || null;
      if(!candidate) return null;
      return { ...(base||{}), ...candidate, meta:{ ...((base&&base.meta)||{}), ...(candidate.meta||{}) } };
    }

    async function loadSpecFromCloud(chatId, tries=5, delayMs=600){
      if(!chatId) return null;
      for(let i=0;i<tries;i++){
        try{
          const { data, error } = await sb.from('proposals').select('spec').eq('chat_id', chatId).single();
          if(!error && data?.spec){ return data.spec; }
        }catch{}
        await new Promise(r=>setTimeout(r, delayMs));
      }
      return null;
    }

    async function ensureChat(title='Nouvelle discussion'){
      if(currentChatId) return currentChatId;
      const { data:{ user } } = await sb.auth.getUser(); if(!user) return null;
      const { data, error } = await sb.from('chats').insert({ user_id:user.id, title }).select().single();
      if(error){ console.error(error); return null; }
      currentChatId=data.id; localStorage.setItem('pf_chat_id', data.id); return data.id;
    }
    async function saveMessage(role, content){
      const { data:{ user } } = await sb.auth.getUser(); if(!user || !currentChatId) return;
      await sb.from('messages').insert({ chat_id:currentChatId, user_id:user.id, role, content });
    }
    async function callChatAPI(message, proposalSpec, history){
      const { data:{ session } } = await sb.auth.getSession();
      const headers={'Content-Type':'application/json'}; if(session?.access_token) headers.Authorization=`Bearer ${session.access_token}`;
      const res=await fetch('/api/chat',{method:'POST',headers,body:JSON.stringify({message,proposalSpec,history})});
      if(!res.ok) throw new Error('HTTP '+res.status); return res.json();
    }

    /* ===== Send ===== */
    document.getElementById('send').onclick = async ()=>{
      const msg=(promptEl.value||'').trim(); if(!msg) return;
      addMsg(msg,'me'); promptEl.value=''; showTyping();

      const history = JSON.parse(localStorage.getItem('pf_chat')||'[]');
      const baseLocal = spec || JSON.parse(localStorage.getItem('pf_proposal')||'null') || null;

      try{
        await ensureChat(msg.slice(0,80));
        await saveMessage('user', msg);

        const data = await callChatAPI(msg, baseLocal, history);
        removeTyping();

        if(data.reply){ addMsg(data.reply,'ai'); await saveMessage('assistant', data.reply); }

        // 1) Essayer de fusionner une spec directement renvoyée
        let merged = mergeAnySpec(data, baseLocal);

        // 2) Sinon, recharger depuis la base (serveur a peut-être écrit la spec en DB)
        if(!merged){
          const cloud = await loadSpecFromCloud(currentChatId, 6, 500);
          if(cloud){ merged = { ...(baseLocal||{}), ...cloud, meta:{ ...((baseLocal&&baseLocal.meta)||{}), ...(cloud.meta||{}) } }; }
        }

        if(merged){
          spec = merged;
          persistSpec();
          render();
        }

        const newHist=[...history,{role:'user',content:msg},{role:'assistant',content:data.reply||''}].slice(-20);
        localStorage.setItem('pf_chat', JSON.stringify(newHist));
      }catch(e){
        console.error(e);
        removeTyping();
        addMsg('Erreur serveur. Réessayez.','ai');
      }
    };

    /* ===== Historique ===== */
    const drawer=document.getElementById('drawer');
    document.getElementById('historyBtn').onclick=async ()=>{
      const { data:{ user } } = await sb.auth.getUser(); if(!user){ alert('Connectez-vous pour accéder à votre historique.'); return; }
      const { data, error } = await sb.from('chats').select('id,title,created_at').order('created_at',{ascending:false}).limit(50);
      if(error){ console.error(error); return; }
      const list=document.getElementById('historyList'); list.innerHTML='';
      data.forEach(c=>{ const b=document.createElement('button'); b.className='btn link-btn';
        b.innerHTML=`<span>${c.title||'Sans titre'}</span><span class="muted" style="font-size:12px">${new Date(c.created_at).toLocaleString()}</span>`;
        b.onclick=()=>openChat(c.id); list.appendChild(b);
      });
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    };
    document.getElementById('closeDrawer').onclick=()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
    async function openChat(id){
      currentChatId=id; localStorage.setItem('pf_chat_id', id); drawer.classList.remove('open'); chatBody.innerHTML='';
      const { data:msgs } = await sb.from('messages').select('role,content,created_at').eq('chat_id', id).order('created_at',{ascending:true});
      msgs?.forEach(m=>addMsg(m.content, m.role==='user'?'me':'ai'));
      const cloud = await loadSpecFromCloud(id, 1, 0);
      spec = cloud || null;
      if(spec){ persistSpec(); }
      render();
    }

    /* ===== Theme / PDF / Logout / Logo ===== */
    const themeBtn=document.getElementById('themeBtn');
    (function(){ const saved=localStorage.getItem('pf_theme')||'light'; if(saved==='dark') document.body.classList.add('dark'); })();
    themeBtn.onclick=()=>{ document.body.classList.toggle('dark'); localStorage.setItem('pf_theme', document.body.classList.contains('dark')?'dark':'light'); };
    document.getElementById('pdfBtn').onclick=()=>window.print();
    document.getElementById('logoutBtn').onclick=async ()=>{ await sb.auth.signOut(); localStorage.removeItem('pf_chat_id'); location.href='index.html'; };

    const logoAttachBtn = document.getElementById('logoAttachBtn');
    const logoFile = document.getElementById('logoFile');
    logoAttachBtn.onclick=()=>logoFile.click();
    logoFile.onchange=(ev)=>{
      const f=ev.target.files?.[0]; if(!f) return;
      const fr=new FileReader();
      fr.onload=()=>{
        spec = spec || { meta:{} };
        spec.meta.style = { ...(spec.meta.style||{}), logoDataUrl: fr.result };
        persistSpec(); render();
      };
      fr.readAsDataURL(f);
    };

    /* ===== Boot ===== */
    (async function init(){
      try{ spec = JSON.parse(localStorage.getItem('pf_proposal')||'null'); }catch{ spec=null; }

      // Si pas de spec locale mais chat courant → tenter cloud
      if(!spec && currentChatId){
        const cloud = await loadSpecFromCloud(currentChatId, 1, 0);
        if(cloud){ spec = cloud; persistSpec(); }
      }
      render();
    })();
  </script>
</body>
</html>
