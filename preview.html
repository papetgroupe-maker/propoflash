<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Aperçu</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --paper-w:210mm; --paper-h:297mm;
      --bg:#f3f6fb; --ink:#0a1020; --muted:#5c667a; --stroke:#e7ecf6;
      --accent:#3b82f6; --accent-ink:#fff;
      --font: "Inter", system-ui, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#f6f8fc,#eef3ff);font-family:var(--font);color:var(--ink)}
    /* Top bar */
    .bar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--stroke);
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
    .left,.right{display:flex;gap:8px;align-items:center}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .spark{width:22px;height:22px;border-radius:6px;background:conic-gradient(from 180deg,#93c5fd,#c4b5fd,#60a5fa,#93c5fd)}
    .btn{border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink);border-color:#0000}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .sel,.color{border:1px solid var(--stroke);border-radius:10px;padding:7px 10px;background:#fff}
    .hint{color:var(--muted);font-size:12px}
    /* Page */
    .wrap{display:grid;place-items:center;padding:22px}
    .sheet{width:var(--paper-w); min-height:var(--paper-h); background:#fff; border:1px solid var(--stroke);
      box-shadow:0 20px 60px rgba(10,16,32,.12); border-radius:12px; padding:28mm 22mm;}
    .header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    .logo{width:40px;height:40px;border-radius:8px;background:#eef2ff;display:grid;place-items:center;overflow:hidden}
    .logo img{max-width:100%;max-height:100%;display:block}
    .h1{font-size:28px;line-height:1.1;margin:0 0 6px;font-weight:800;letter-spacing:-.01em}
    .meta{color:var(--muted);font-size:14px;margin-bottom:18px}
    h2{margin:22px 0 8px;font-size:18px;letter-spacing:.2px}
    .hr{height:1px;background:var(--stroke);margin:12px 0}
    p{margin:8px 0 10px}
    ul{margin:8px 0 10px 18px}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef4ff;border:1px solid var(--stroke);font-size:12px;color:#28436d}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .muted{color:var(--muted)}
    .price{font-weight:800;font-size:18px}
    table.items{width:100%;border-collapse:collapse;margin-top:8px}
    table.items th, table.items td{border:1px solid var(--stroke);padding:8px;font-size:13px;text-align:left}
    table.items th{background:#f7f9ff}
    .tfoot{display:flex;justify-content:flex-end;margin-top:8px}
    .total{border:1px solid var(--stroke);border-radius:10px;padding:10px 12px;font-weight:800}

    /* Editable mode */
    .edit-on [contenteditable="true"]{outline:2px solid #e0ecff;border-radius:6px;padding:2px 4px}

    /* Print */
    @media print{
      .bar{display:none}
      body{background:#fff}
      .wrap{padding:0}
      .sheet{box-shadow:none;border:none;border-radius:0;width:auto;min-height:auto;padding:18mm 16mm}
      a[href]:after{content:""}
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="bar" id="bar">
    <div class="left">
      <div class="brand"><div class="spark" aria-hidden="true"></div>PropoFlash</div>
      <button class="btn" id="backBtn">← Retour au chat</button>
      <span class="hint" id="status">Chargement de l’aperçu…</span>
    </div>
    <div class="right">
      <label class="hint">Langue</label>
      <select class="sel" id="langSel">
        <option value="fr">FR</option><option value="en">EN</option>
      </select>
      <label class="hint">Couleur</label>
      <input type="color" class="color" id="accentPick" value="#3b82f6" title="Couleur d’accent"/>
      <button class="btn" id="editBtn">Éditer</button>
      <button class="btn primary" id="pdfBtn">Exporter PDF</button>
    </div>
  </div>

  <!-- Page -->
  <div class="wrap">
    <div class="sheet" id="sheet" aria-live="polite">
      <!-- contenu injecté par JS -->
    </div>
  </div>

  <script>
    const $ = (q,ctx=document)=>ctx.querySelector(q);

    const t = {
      fr: {
        title:"Proposition commerciale",
        to:"Pour",
        from:"Émis par",
        date:"Date",
        letter:"Lettre d’introduction",
        subject:"Objet",
        executive:"Résumé exécutif",
        objectives:"Objectifs",
        approach:"Approche & phasage",
        deliverables:"Livrables",
        in_scope:"Inclus",
        out_scope:"Hors-périmètre",
        timeline:"Planning",
        pricing:"Tarification",
        assumptions:"Hypothèses / Risques",
        next:"Prochaines étapes",
        price_model:"Modèle",
        terms:"Conditions",
        owner:"Responsable",
        items:"Détail"
      },
      en: {
        title:"Business Proposal",
        to:"To",
        from:"Issued by",
        date:"Date",
        letter:"Cover Letter",
        subject:"Subject",
        executive:"Executive Summary",
        objectives:"Objectives",
        approach:"Approach & Phasing",
        deliverables:"Deliverables",
        in_scope:"In scope",
        out_scope:"Out of scope",
        timeline:"Timeline",
        pricing:"Pricing",
        assumptions:"Assumptions / Risks",
        next:"Next Steps",
        price_model:"Model",
        terms:"Terms",
        owner:"Owner",
        items:"Items"
      }
    };

    let spec = null;
    const sheet = $('#sheet');
    const statusEl = $('#status');
    const langSel = $('#langSel');
    const accentPick = $('#accentPick');
    const editBtn = $('#editBtn');

    function safeArr(v){ return Array.isArray(v) ? v : []; }
    function safeStr(v, fallback=''){ return (v==null?'':String(v)).trim() || fallback; }
    function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
    function fmtDate(d){
      try{
        const dt = d ? new Date(d) : new Date();
        return dt.toLocaleDateString(document.documentElement.lang||'fr', { year:'numeric', month:'short', day:'2-digit' });
      }catch{ return '' }
    }
    function money(v, curr){ return `${(n(v)).toLocaleString(document.documentElement.lang||'fr')} ${curr||''}`.trim(); }

    function section(titleHTML){
      const h = document.createElement('h2'); h.innerHTML = titleHTML;
      sheet.appendChild(h);
    }
    function para(text){
      const p = document.createElement('p'); p.textContent = text; p.setAttribute('contenteditable','true'); p.classList.add('editable');
      sheet.appendChild(p);
    }
    function list(items){
      if(!items || !items.length) return;
      const ul = document.createElement('ul');
      items.forEach(it=>{ const li=document.createElement('li'); li.textContent=String(it); li.setAttribute('contenteditable','true'); li.classList.add('editable'); ul.appendChild(li); });
      sheet.appendChild(ul);
    }

    function render(){
      sheet.innerHTML = '';
      if(!spec){ sheet.innerHTML='<p class="muted">Aucune donnée. Revenez au chat pour générer un aperçu.</p>'; return; }
      const lang = spec.meta?.lang || 'fr';
      const L = t[lang] || t.fr;
      document.documentElement.lang = lang;

      /* Apply style (color + font + logo) */
      const primary = safeStr(spec.meta?.style?.primary, getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#3b82f6');
      document.documentElement.style.setProperty('--accent', primary);
      const font = safeStr(spec.meta?.style?.font);
      if (font) document.documentElement.style.setProperty('--font', font);

      // Header
      const title = safeStr(spec.meta?.title, L.title);
      const company = safeStr(spec.meta?.company, 'Votre société');
      const client = safeStr(spec.meta?.client, 'Client');
      const date = safeStr(spec.meta?.date, fmtDate());
      const logoDataUrl = safeStr(spec.meta?.style?.logoDataUrl);

      const hdr = document.createElement('div');
      hdr.className = 'header';
      const logo = document.createElement('div');
      logo.className = 'logo';
      logo.innerHTML = logoDataUrl ? `<img alt="logo" src="${logoDataUrl}"/>` : `<span style="width:16px;height:16px;border-radius:999px;background:var(--accent);display:inline-block"></span>`;
      const tt = document.createElement('div');
      tt.innerHTML = `<div class="h1" contenteditable="true">${title}</div>
        <div class="meta">${L.to}: <span class="tag" contenteditable="true">${client}</span> &nbsp;•&nbsp;
        ${L.from}: <span class="tag" contenteditable="true">${company}</span> &nbsp;•&nbsp; ${L.date}: ${date}</div>`;
      hdr.appendChild(logo); hdr.appendChild(tt); sheet.appendChild(hdr);
      sheet.appendChild(Object.assign(document.createElement('div'),{className:'hr'}));

      // Letter (cover email-style)
      const letter = spec.letter || {};
      const hasLetter = letter.subject || letter.greeting || safeArr(letter.body_paragraphs).length || letter.closing || letter.signature;
      if (hasLetter){
        section(L.letter);
        if (letter.subject) para(`${L.subject}: ${letter.subject}`);
        if (letter.preheader) para(letter.preheader);
        if (letter.greeting) para(letter.greeting);
        safeArr(letter.body_paragraphs).forEach(p=>para(p));
        if (letter.closing) para(letter.closing);
        if (letter.signature) para(letter.signature);
      }

      // Executive summary
      if (safeArr(spec.executive_summary?.paragraphs).length){
        section(L.executive);
        safeArr(spec.executive_summary.paragraphs).forEach(p=>para(p));
      }

      // Objectives
      if (safeArr(spec.objectives?.bullets).length){
        section(L.objectives);
        list(spec.objectives.bullets);
      }

      // Approach (phases per schema: title, description?, activities[], outcomes[], duration?)
      if (safeArr(spec.approach?.phases).length){
        section(L.approach);
        safeArr(spec.approach.phases).forEach((ph,i)=>{
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <strong contenteditable="true">Phase ${i+1} — ${safeStr(ph.title,'À confirmer')}</strong>
              <span class="tag">${safeStr(ph.duration || '', '')}</span>
            </div>`;
          sheet.appendChild(card);
          if (ph.description) { const p=document.createElement('p'); p.textContent=ph.description; p.setAttribute('contenteditable','true'); card.appendChild(p); }
          if (safeArr(ph.activities).length){
            const h=document.createElement('div'); h.className='muted'; h.style.marginTop='6px'; h.textContent='• Activités';
            card.appendChild(h);
            const ul=document.createElement('ul');
            ph.activities.forEach(x=>{const li=document.createElement('li'); li.textContent=x; li.setAttribute('contenteditable','true'); ul.appendChild(li);});
            card.appendChild(ul);
          }
          if (safeArr(ph.outcomes).length){
            const h=document.createElement('div'); h.className='muted'; h.style.marginTop='6px'; h.textContent='• Résultats';
            card.appendChild(h);
            const ul=document.createElement('ul');
            ph.outcomes.forEach(x=>{const li=document.createElement('li'); li.textContent=x; li.setAttribute('contenteditable','true'); ul.appendChild(li);});
            card.appendChild(ul);
          }
        });
      }

      // Deliverables
      if (spec.deliverables && (safeArr(spec.deliverables.in).length || safeArr(spec.deliverables.out).length)){
        section(L.deliverables);
        const grid = document.createElement('div'); grid.className='grid2';
        const a=document.createElement('div'); a.className='card';
        a.innerHTML = `<div class="muted" style="margin-bottom:6px">${L.in_scope}</div>`;
        grid.appendChild(a);
        const b=document.createElement('div'); b.className='card';
        b.innerHTML = `<div class="muted" style="margin-bottom:6px">${L.out_scope}</div>`;
        grid.appendChild(b);
        sheet.appendChild(grid);

        const ulA=document.createElement('ul'); safeArr(spec.deliverables.in).forEach(x=>{const li=document.createElement('li'); li.textContent=x; li.setAttribute('contenteditable','true'); ulA.appendChild(li);});
        const ulB=document.createElement('ul'); safeArr(spec.deliverables.out).forEach(x=>{const li=document.createElement('li'); li.textContent=x; li.setAttribute('contenteditable','true'); ulB.appendChild(li);});
        a.appendChild(ulA); b.appendChild(ulB);
      }

      // Timeline (milestones: title, dateOrWeek, owner?)
      if (safeArr(spec.timeline?.milestones).length){
        section(L.timeline);
        const grid=document.createElement('div'); grid.className='grid2';
        safeArr(spec.timeline.milestones).forEach(ms=>{
          const c=document.createElement('div'); c.className='card';
          const when = ms.dateOrWeek || ms.date || ms.duration || '';
          c.innerHTML = `<div><strong contenteditable="true">${safeStr(ms.title,'Étape')}</strong></div>
                         <div class="muted">${when}${ms.owner?` — ${L.owner}: ${ms.owner}`:''}</div>`;
          if (ms.notes) { const p=document.createElement('p'); p.textContent=ms.notes; p.setAttribute('contenteditable','true'); c.appendChild(p); }
          grid.appendChild(c);
        });
        sheet.appendChild(grid);
      }

      // Pricing (schema: model, currency?, total?, items[], terms[])
      if (spec.pricing && (spec.pricing.total != null || safeStr(spec.pricing.model))){
        section(L.pricing);

        const currency = spec.pricing.currency || (spec.meta?.currency || '€');

        if (Array.isArray(spec.pricing.items) && spec.pricing.items.length){
          const tbl = document.createElement('table'); tbl.className='items';
          tbl.innerHTML = `<thead><tr>
              <th>${L.items}</th><th>Qty</th><th>Unit</th><th>PU</th><th>Subtotal</th>
            </tr></thead><tbody></tbody>`;
          const tb = tbl.querySelector('tbody');
          spec.pricing.items.forEach(it=>{
            const tr=document.createElement('tr');
            const subtotal = (it.subtotal!=null) ? n(it.subtotal) : (n(it.qty)*n(it.unit_price));
            tr.innerHTML = `
              <td contenteditable="true">${safeStr(it.name,'Item')}</td>
              <td contenteditable="true">${safeStr(it.qty,'')}</td>
              <td contenteditable="true">${safeStr(it.unit,'')}</td>
              <td contenteditable="true">${money(it.unit_price, currency)}</td>
              <td>${money(subtotal, currency)}</td>
            `;
            tb.appendChild(tr);
          });
          sheet.appendChild(tbl);
        }

        const priceBox=document.createElement('div'); priceBox.className='card';
        const total = spec.pricing.total!=null ? money(spec.pricing.total, currency) : '—';
        priceBox.innerHTML = `
          <div class="tfoot"><div class="total">Total: <span contenteditable="true">${total}</span></div></div>
          <div class="muted" style="margin-top:6px">${L.price_model}: <span contenteditable="true">${safeStr(spec.pricing.model,'Forfait')}</span></div>
        `;
        sheet.appendChild(priceBox);

        if (safeArr(spec.pricing.terms).length){
          const terms=document.createElement('div'); terms.className='card'; terms.style.marginTop='8px';
          terms.innerHTML = `<div class="muted" style="margin-bottom:6px">${L.terms}</div>`;
          const ul=document.createElement('ul');
          spec.pricing.terms.forEach(x=>{const li=document.createElement('li'); li.textContent=x; li.setAttribute('contenteditable','true'); ul.appendChild(li);});
          terms.appendChild(ul); sheet.appendChild(terms);
        }
      }

      // Assumptions
      if (safeArr(spec.assumptions?.paragraphs).length){
        section(L.assumptions);
        safeArr(spec.assumptions.paragraphs).forEach(p=>para(p));
      }

      // Next steps
      if (safeArr(spec.next_steps?.paragraphs).length){
        section(L.next);
        safeArr(spec.next_steps.paragraphs).forEach(p=>para(p));
      }

      statusEl.textContent = (lang==='en') ? 'Preview ready' : 'Aperçu prêt';
    }

    // Load spec
    (function init(){
      try {
        const raw = localStorage.getItem('pf_proposal');
        if(raw){ spec = JSON.parse(raw); }
      } catch {}
      if(!spec) spec = { meta:{ lang: 'fr', title:'Proposition commerciale', style:{ primary:'#3b82f6' } } };
      // init UI from spec
      langSel.value = spec.meta?.lang || 'fr';

      const primary = spec.meta?.style?.primary;
      if(primary) { document.documentElement.style.setProperty('--accent', primary); accentPick.value = primary.startsWith('#') ? primary : '#3b82f6'; }
      const font = spec.meta?.style?.font; if (font) document.documentElement.style.setProperty('--font', font);

      render();
    })();

    // Controls
    $('#backBtn').onclick = ()=>{ location.href = 'index.html'; };
    $('#pdfBtn').onclick  = ()=> {
      statusEl.textContent = (spec.meta?.lang==='en') ? 'Preparing PDF…' : 'Préparation du PDF…';
      setTimeout(()=>{ window.print(); statusEl.textContent = (spec.meta?.lang==='en') ? 'Preview ready' : 'Aperçu prêt'; }, 80);
    };

    langSel.onchange = (e)=>{
      const lang = e.target.value;
      spec.meta = Object.assign({}, spec.meta, { lang });
      localStorage.setItem('pf_proposal', JSON.stringify(spec));
      render();
    };

    accentPick.oninput = (e)=>{
      const v = e.target.value || '#3b82f6';
      document.documentElement.style.setProperty('--accent', v);
      spec.meta = Object.assign({}, spec.meta, { style:{ ...(spec.meta?.style||{}), primary:v } });
      localStorage.setItem('pf_proposal', JSON.stringify(spec));
    };

    let editing = false;
    editBtn.onclick = ()=>{
      editing = !editing;
      document.body.classList.toggle('edit-on', editing);
      editBtn.textContent = editing ? 'Terminer édition' : 'Éditer';
      // (Persistance fine des champs édités à mettre en place plus tard si souhaité)
    };
  </script>
</body>
</html>
