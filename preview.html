<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PropoFlash — Aperçu (impression)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--paper-w:210mm;--paper-h:297mm;--stroke:#e7ecf6;--ink:#0a1020;--muted:#5c667a}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:#f3f6fb;font-family:Inter,system-ui,sans-serif;color:var(--ink)}
    .bar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--stroke);display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
    .wrap{display:grid;place-items:center;padding:22px}
    .sheet{width:var(--paper-w);min-height:var(--paper-h);background:#fff;border:1px solid var(--stroke);border-radius:12px;box-shadow:0 20px 60px rgba(10,16,32,.12);padding:24mm 20mm}
    .h1{font-weight:800;font-size:28px;margin:0 0 6px}
    .meta{color:var(--muted);font-size:14px;margin-bottom:18px}
    .hr{height:1px;background:var(--stroke);margin:12px 0}
    .card{border:1px solid var(--stroke);border-radius:12px;padding:12px;margin-top:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff}
    table{border-collapse:collapse;width:100%;font-size:14px} th,td{border-bottom:1px solid var(--stroke);padding:6px;text-align:left}
    @media print{.bar{display:none} body{background:#fff} .wrap{padding:0} .sheet{box-shadow:none;border:none;border-radius:0;width:auto;min-height:auto;padding:18mm 16mm}}
  </style>
</head>
<body>
  <div class="bar">
    <div><strong>Aperçu</strong></div>
    <div><button onclick="window.print()">Exporter PDF</button> <a href="studio.html" style="margin-left:8px">← Retour au studio</a></div>
  </div>
  <div class="wrap"><div id="sheet" class="sheet"></div></div>

  <script>
    const sheet=document.getElementById('sheet');
    const safeArr=v=>Array.isArray(v)?v:[];
    const safeStr=(v,f='')=>(v==null?'':String(v)).trim()||f;
    const money=(n,c)=>{try{return new Intl.NumberFormat('fr-FR',{style:'currency',currency:c||'EUR'}).format(Number(n||0));}catch{return String(n||0)+' '+(c||'€')}};

    function render(spec){
      sheet.innerHTML='';
      const company=safeStr(spec.meta?.company||spec.meta?.brand?.company,'Votre société');
      const client=safeStr(spec.meta?.client,'Client');
      const title=safeStr(spec.meta?.title,'Proposition commerciale');

      const h=document.createElement('div'); h.innerHTML=`<div class="h1">${title}</div>
        <div class="meta">Pour <span class="pill">${client}</span> • Émis par <span class="pill">${company}</span></div>`;
      sheet.appendChild(h); sheet.appendChild(Object.assign(document.createElement('div'),{className:'hr'}));

      if (safeArr(spec.executive_summary?.paragraphs).length){
        const c=document.createElement('div'); c.className='card'; c.innerHTML='<strong>Résumé exécutif</strong>';
        spec.executive_summary.paragraphs.forEach(p=>{const el=document.createElement('p'); el.textContent=p; c.appendChild(el);});
        sheet.appendChild(c);
      }
      if (spec.pricing){
        const pr=spec.pricing, currency=pr.currency||'EUR';
        const c=document.createElement('div'); c.className='card'; c.innerHTML='<strong>Tarification</strong>';
        if (Array.isArray(pr.items) && pr.items.length){
          const t=document.createElement('table'); t.innerHTML='<thead><tr><th>Item</th><th>Qté</th><th>PU</th><th>Sous-total</th></tr></thead><tbody></tbody>';
          const tb=t.querySelector('tbody');
          pr.items.forEach(it=>{
            const qty=Number(it.qty||1), up=Number(it.unit_price||0), st=(it.subtotal!=null)?Number(it.subtotal):qty*up;
            const tr=document.createElement('tr'); tr.innerHTML=`<td>${safeStr(it.name,'—')}</td><td>${qty}</td><td>${money(up,currency)}</td><td>${money(st,currency)}</td>`;
            tb.appendChild(tr);
          });
          c.appendChild(t);
        }else{
          const p=document.createElement('div'); p.style.marginTop='6px'; p.innerHTML=`<span class="pill">${money(pr.price||0,currency)}</span> &nbsp; <span style="color:#5c667a">(${safeStr(pr.model||'forfait')})</span>`;
          c.appendChild(p);
        }
        sheet.appendChild(c);
      }
    }

    (function init(){
      let spec=null; try{ spec = JSON.parse(localStorage.getItem('pf_proposal')||'null'); }catch{}
      if(!spec) spec={ meta:{ title:'Proposition commerciale' } };
      render(spec);
    })();
  </script>
</body>
</html>
